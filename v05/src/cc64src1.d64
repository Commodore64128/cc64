\ C-COMPILER (1)               11SEP94PZ                                          .                    0                   ..                   0                   LOADSCREEN          &2                                                            дир: TOOLS          &5                                                            MEMMAN             &12                   LISTMAN            &18                   ERRORMESSAGES      &24                   INPUT              &30                   SCANNER            &36                   ERRORHANDLER       &54                   SYMBOLTABLE        &60                   SAVESTACK          &66                   CODEHANDLER        &72                   CODEOUTPUT         &77                   FILEMAN            &78                   ASSEMBLER          &84                   PREPROCESSOR      &104                   FILEIO            &112                   FORTH-ASSEMBLER   &120                   дир: TEST         &149                                                           \ RELOCATING THE SYSTEM        23AUG94PZ                                          э : RELOCATE-TASKS  ( NEWуп -- )          UP@ DUP                                  бегин  1+ UNDER @ 2DUP -                 вхиле  ROT DROP  репеат  2DROP ! ;                                               : RELOCATE  ( STACKLEN RSTACKLEN -- )     SWAP  ORIGIN +                           2DUP + B/BUF + 2+  LIMIT U>               ABORT" BUFFERS?"                        DUP   PAD  $100 +  U< ABORT" STACK?"     OVER  UDP @ $40 +  U< ABORT" RSTACK?"    FLUSH EMPTY                              UNDER  +   ORIGIN $а + !        \ R0     DUP RELOCATE-TASKS                       UP@ 1+ @   ORIGIN   1+ !        \ TASK         6 -  ORIGIN  8 + ! COLD ; \ S0                                             : BYTES.MORE  ( N -- )                    UP@ ORIGIN -  +  R0 @ UP@ - RELOCATE ;  : BUFFERS  ( +N -- )                      B/BUF * 2+  LIMIT R0 @ -                 SWAP - BYTES.MORE ;                       $D000 ' LIMIT >BODY !  1 BUFFERS      \ DEVELOPMENT LOADSCREEN 1     21SEP94PZ                                            ONLYFORTH  DECIMAL                       : ч   ;          : ээ  э ;               ROOT   CD TOOLS                          ^ UNLOOP  ^ DOER-MAKE THRU                                                        VOCABULARY COMPILER                      COMPILER ALSO DEFINITIONS   : э ;        ^ STRINGTAB  ^ REMOVE-INITS THRU ROOT    ^ ERRORMESSAGES     LOAD                 ^ ERRORHANDLER      LOAD                 ^ MEMMAN            LOAD                 ^ LISTMAN           LOAD                 ^ FILEIO            LOAD                 ^ FILEMAN           LOAD                 ^ INPUT             LOAD                 ^ SCANNER           LOAD                 ^ SYMBOLTABLE       LOAD                 ^ CODEHANDLER       LOAD                 ^ CODEOUTPUT        LOAD                 ^ ASSEMBLER         LOAD                 ^ PREPROCESSOR      LOAD                                                                                                \ TESTING LOADSCREEN 1         21SEP94PZ                                            ONLYFORTH  DECIMAL                     э : ч   ;    ' NOOP ис .STATUS             6 8 THRU   \ UNLOOP STRCMP DOER-MAKE   \ 120 LOAD    \ TRANSIENT ASSEMBLER       129 LOAD    \ 2@ 2! 2VARIABLE/CONSTANT    VOCABULARY COMPILER                      COMPILER ALSO DEFINITIONS    : э  ;      9 10 THRU  \ STRTAB INIT                 24 LOAD    \ ERRORMESSAGES               54 LOAD    \ ERRORHANDLER                12 LOAD    \ MEMMAN                      18 LOAD    \ LISTMAN                    112 LOAD    \ FILEIO                      78 LOAD    \ FILEMAN                     30 LOAD    \ INPUT                       36 LOAD    \ SCANNER                     60 LOAD    \ SYMBOLTABLE                 72 LOAD    \ CODEHANDLER                 77 LOAD    \ CODEOUTPUT                  84 LOAD    \ ASSEMBLER                  104 LOAD    \ PREPROCESSOR                                                                                               \ ENDCOMPILE  LOADSCREEN 1     21SEP94PZ                                            ONLYFORTH  DECIMAL  CR                 э : ч  э ;                                 6 8 THRU   \ UNLOOP STRCMP DOER-MAKE    120 LOAD    \ TRANSIENT ASSEMBLER        129 LOAD    \ 2@ 2! 2VARIABLE/CONSTANT    VOCABULARY COMPILER                      COMPILER ALSO DEFINITIONS                9 10 THRU  \ STRTAB INIT                 24 LOAD    \ ERRORMESSAGES               54 LOAD    \ ERRORHANDLER                12 LOAD    \ MEMMAN                      18 LOAD    \ LISTMAN                    112 LOAD    \ FILEIO                      78 LOAD    \ FILEMAN                     30 LOAD    \ INPUT                       36 LOAD    \ SCANNER                     60 LOAD    \ SYMBOLTABLE                 72 LOAD    \ CODEHANDLER                 77 LOAD    \ CODEOUTPUT                  84 LOAD    \ ASSEMBLER                  104 LOAD    \ PREPROCESSOR                                                                                               \ TOOLS:                       18APR94PZ                                          ..                  -5                   UNLOOP               1                   STRCMP               2                   DOER-MAKE            3                   STRINGTAB            4                   INIT                 5                   REMOVE-INITS         6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ DO-LOOP TOOLS                26MAY91PZ                                          \NEEDS UNLOOP                         (  \ ) : UNLOOP  R> RDROP RDROP RDROP >R ;                                             : >и  ( N -- )                             R> RDROP SWAP R@ - >R >R ;                                                                                               : >LO/HI ( U -- LO HI )                     256 U/MOD ;                                                                    : LO/HI> ( LO HI -- U )                     255 AND 256 * SWAP 255 AND + ;                                                 : >LO ( -- LO )                             255 AND ;                             : >HI ( -- HI )                             2/ 2/ 2/ 2/ 2/ 2/ 2/ 2/ ;                                                    \NEEDS :DOES>                         (  \ ) : :DOES>  HERE >R [COMPILE] DOES> (  \ )   CURRENT @ CONTEXT !  HIDE 0 ] ;                                                                                     \ STRCMP                       09MAY94PZ                                          ч : STRCMP  ( STR1 STR2 -- FLAG )           COUNT ROT COUNT ROT OVER =                  иф 0 ?до                                 OVER и + C@  OVER и + C@ -                 иф 2DROP FALSE унлооп EXIT тхен        лооп 2DROP TRUE                          елсе DROP 2DROP FALSE тхен ;                                                ч : STRCPY  ( SRC DST -- )                    OVER C@ 1+ MOVE ;                                                            ч : STRCAT  ( SRC DST -- )                    SWAP COUNT >R OVER COUNT + R@ MOVE       DUP C@ R> + SWAP C! ;                                                                                                                                                                                                                                                                                                                                                                                               \ DOER/MAKE (INTERAKTIV)       02SEP94PZ                                            HERE 0 ] ;                               : DOER  ( -- )                               CREATE  [ SWAP ] LITERAL ,               DOES> @ [ ASSEMBLER ] IP                         [ FORTH ]     ! ;                                                     : MAKE  ( -- )                               HERE ' >BODY ! [COMPILE] ] 0 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \ STRINGTABELLEN               30SEP90PZ                                          э VARIABLE N                             э VARIABLE M                                                                      ч : X ( -- )  N @  1 N +!  CONSTANT ;    ч : X"  ( -- )   HERE M @ !  HERE M !        2 ALLOT  [COMPILE] ," ;                                                         HERE 0 ,   э CONSTANT NIL                HERE NIL , ," END OF TABLE"                         э CONSTANT VOID                                                      ч : STRINGTAB ( -- )                          CREATE  HERE M !  2 ALLOT  0 N !        DOES> ( -- 1.ADR )  @ ;              ч : ENDTAB ( -- )  NIL M @ ! ;                                                    ч : >STRING  ( ADR -- STR )  2+ ;        ч : +STRING  ( ADR1 -- ADR2/0 ) @ ;      ч : STRING[] ( TAB N -- ADR )                 0 ?до +STRING ?DUP 0= иф VOID тхен      лооп ;                                                                                                                \ INIT                         18APR94PZ                                          э VARIABLE INITS  INITS OFF                                                       ч : INIT  ( -- )                              INITS бегин @ ?DUP вхиле                       DUP 2+ PERFORM репеат ;                                                ч : INIT: ( NAME )                            INITS бегин DUP @ вхиле @ репеат         HERE SWAP !  0 ,  ' , ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \   INIT                       18APR94PZ                                            : REMOVE-INITS                             ( DICT SYMB -- DICT SYMB )                INITS бегин DUP @ вхиле                        2 PICK OVER @ U<                            иф DUP OFF елсе @ тхен                репеат DROP ;                                                            : INITS?                                  INITS бегин @ ?DUP вхиле DUP 2+ @        >NAME COUNT $1F AND CR TYPE репеат ;                                           ' REMOVE-INITS ис CUSTOM-REMOVE                                                   \\                                       ч ' ; алиас ;INIT...                           IMMEDIATE RESTRICT                                                          ч : ...INIT:                                  INITS бегин DUP @ вхиле @ репеат         HERE SWAP !  0 ,                         HERE 2+ ,                                [ ' INIT: @ ] LITERAL ,  \ NEST          ] 0 ;                              \ MEMMAN: LOADSCREEN           20SEP94PZ                                            .( MODULE MEMMAN ) CR                                                            1 5 +THRU                                                                        \\ TERMINOLOGIE:                            HIMEM                                    HEAP[    ]HEAP                           HASH[    ]HASH                           SYMTAB[  ]SYMTAB                         STATIC[  ]STATIC                         CODE[    ]CODE                           LINEBUF                                                                           /LINEBUF                                 #GLOBALS                                 /LINK                                    /SYMBOL                                  /ID                                                                               INIT-MEM                                                                          .MEM                                                                          \   MEMMAN: VARIABLE           03SEP94PZ                                          э CREATE MEM  $D000 , 100   ,                          1000  , 4000  , 4000 ,                   0 , 0 , 0 , 0 , 0 ,                                                   : HIMEM         MEM @ ;                э : #LINKS        MEM 2+ @ ;             ч : #GLOBALS      MEM 4 + @ ;            э : SYMTABSIZE    MEM 6 + @ ;            э : CODESIZE      MEM 8 + @ ;              : LOMEM          R0 @ ;                                                         ч 6 CONSTANT /LINK   \ LISTENKNOTEN                                               ч 4 CONSTANT /SYMBOL \ DATENFELDGROESSE                                           ч 31 CONSTANT /ID  \ DARF NICHT KLEINER     \ ALS DAS KUERZESTE KEYWORD SEIN !!!                                           ч 133 CONSTANT /LINEBUF                                                                                                                                                                                     \   MEMMAN: CONFIGURE          03SEP94PZ                                          ч ' HIMEM алиас   ]HEAP                  ч               : HEAP[    MEM 10 + @ ;  ч ' HEAP[ алиас   ]HASH                  ч               : HASH[    MEM 12 + @ ;  ч ' HASH[ алиас   ]SYMTAB                ч               : SYMTAB[  MEM 14 + @ ;  ч ' SYMTAB[ алиас ]CODE                  ч               : CODE[    MEM 16 + @ ;  ч ' CODE[ алиас   ]STATIC                ч               : STATIC[  MEM 18 + @ ;  ч ' LOMEM алиас   LINEBUF                                                         э : (CONF?  ( -- FLAG )                       HIMEM  #LINKS /LINK *  -                                  DUP MEM 10 + !          #GLOBALS 2*  -   DUP MEM 12 + !          SYMTABSIZE -     DUP MEM 14 + !          CODESIZE   -         MEM 16 + !          LINEBUF /LINEBUF +   MEM 18 + !          STATIC[ 11 + ]STATIC U> ;                                                                                                                                     \   MEMMAN: .MEM               24AUG94PZ                                          ч : CONFIGURE  ( -- )                         (CONF?   *MEMSETUP* ?FATAL ;                                                    INIT: CONFIGURE                                                                э : SET-MEM:  ( N -- ) CREATE C, DOES>     ( N DFA -- ) C@ MEM + ! ;                                                       ч 0 SET-MEM: HIMEM!                      ч 2 SET-MEM: #LINKS!                     ч 4 SET-MEM: #GLOBALS!                   ч 6 SET-MEM: SYMTABSIZE!                 ч 8 SET-MEM: CODESIZE!                                                            \\                                                                                э CREATE (DEFAULT-MEM  $D000 , $20   ,                  $10   , $100  , $100  ,                                            ч : DEFAULT-MEM  ( -- )                    (DEFAULT-MEM MEM 10 CMOVE CONFIGURE ;                                                                                   \   MEMMAN:                    09SEP94PZ                                          э : .BYTES  ( N -- )  . ." BYTES" CR ;                                            ч : .MEM ( -- )                               (CONF? CR                               ." DATA STACK  : " S0 @ PAD - 256 -                         .BYTES                ." RETURN STACK: " R0 @ S0 @ -                              .BYTES                ." STATICBUFFER: " ]STATIC STATIC[                          - .BYTES              ." CODEBUFFER  : " CODESIZE  .BYTES      ." SYMBOL TABLE: " SYMTABSIZE .BYTES     ." HASH TABLE  : " #GLOBALS .                               ." ELEMENTS" CR       ." HEAP        : " #LINKS .                                 ." LINKS" CR          ." MEMORY LIMIT: " HIMEM   U. CR        иф                                        ." BAD MEMORY SETUP: STATICBUFFER !"    CR тхен ;                                                                                                                                                       \   MEMMAN:                    24AUG94PZ                                          э : RELOCATE-TASKS  ( NEWуп -- )          UP@ DUP бегин  1+ UNDER @ 2DUP -         вхиле  ROT DROP  репеат  2DROP ! ;                                               ч : RELOCATE  ( STACKLEN RSTACKLEN -- )   EMPTY  256 MAX 8192 MIN  SWAP            256 MAX 8192 MIN  PAD + 256 +            2DUP + 2+ LIMIT U>                       ABORT" STACKS BEYOND LIMIT"              UNDER  +   ORIGIN $а + !        \ R0     DUP RELOCATE-TASKS                       UP@ 1+ @   ORIGIN   1+ !        \ TASK         6 -  ORIGIN  8 + ! COLD ; \ S0                                                                                                                                                                                                                                                                                                                                                                                                                             \ LISTMAN: LOADSCREEN          20SEP94PZ                                          \ TERMINOLOGIE:                          \ HOOK-INTO     HOOK-OUT                 \ HEAP>         >HEAP                    \ INIT-HEAP                                                                         .( MODULE LISTMAN ) CR                                                            1 2 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ LISTMAN:                     12MAR91PZ                                          ч : HOOK-INTO ( ELEMENT LIST -- )             2DUP  @ SWAP !  !  ;                                                         ч : HOOK-OUT  ( LIST -- ELEMENT/0 )           DUP @ DUP                                   иф DUP @ ROT !                           елсе NIP тхен ;                                                                                                    э VARIABLE HEAP                                                                   ч : HEAP> ( -- ELEMENT/0 )                    HEAP @ DUP                                  иф DUP @ HEAP !                          елсе *HEAPOVFL* ERROR тхен ;                                              ч : >HEAP ( ELEMENT -- )                       HEAP HOOK-INTO ;                                                                                                                                                                                                                               \   LISTMAN: INIT              12MAR91PZ                                          ч : INIT-HEAP                                 HEAP OFF                                 ]HEAP HEAP[ ?до                            и >HEAP                                /LINK +лооп ;                                                                  INIT: INIT-HEAP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ FEHLERMELDUNGEN              20SEP94PZ                                            .( MODULE ERRORMESSAGES ) CR                                                      1 3 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \ ERRORMESSAGES                11SEP94PZ                                          ч STRINGTAB ERRORMESSAGE                                                          ч X *SYNTAX*      X" SYNTAX ERROR"       \ X *IN-FILE*     X" SOURCE FILE ERROR"  ч X *EOF*         X" END OF FILE"        ч X *SYMOVFL*                                 X" SYMBOL TABLE OVERFLOW"           ч X *DOUBLEDEF*                               X" DOUBLE DEFINED SYMBOL"           ч X *GLBOVFL*                                 X" HASH TABLE OVERFLOW"             ч X *FUNCTOLONG*  X" FUNCTION TOO LONG"  \ X *OUT-FILE*    X" OUTPUT FILE ERROR"  ч X *UNDEF*       X" UNDEFINED SYMBOL"   ч X *NOFUNC*      X" BAD FUNCTION CALL"  ч X *INC-NEST*                                X" INCLUDE NESTING TOO DEEP"        ч X *NOREF*       X" REFERENCE NEEDED"   ч X *NOVECTOR*    X" VECTOR NEEDED"      ч X *NOPTR*       X" POINTER NEEDED"     ч X *NOCONST*                                 X" CONSTANT EXPRESSION NEEDED"                                              \   ERRORMESSAGES              11SEP94PZ                                          ч X *NOSWITCH*    X" NO ACTIVE SWITCH"   ч X *ILL-BRK*                                 X" NOTHING TO BREAK OR CONTINUE"    ч X *ILL-DEFAULT* X" ILLEGAL DEFAULT"    ч X *HEAPOVFL*    X" HEAP OVERFLOW"      ч X *!=TYPE*      X" INCOMPATIBLE TYPE"  ч X *LEX*         X" LEXICAL ERROR"      ч X *EOL*                                     X" UNEXPECTED END OF LINE"          ч X *COMMENT*                                 X" UNCLOSED COMMENT FROM LINE "     ч X *IGNORED*     X" WORD IGNORED: "     \ X *FILE*        X" FILE ERROR"         \ X *STACKOVFL*   X" STACK OVERFLOW"     ч X *EXPECTED*    X" EXPECTED: "         ч X *INITER*      X" BAD INITIALIZER"    ч X *???*         X" MAKES NO SENSE"     ч X *DOUBLE-FUNC* X" DOUBLE FUNCTION"    ч X *DOUBLE-PTR*  X" DOUBLE POINTER"     ч X *PARAM*       X" BAD PARAMETER"      ч X *LONGLINE*    X" OVERLONG LINE"      ч X *PREPROCESSOR* X" PREPROCESSOR"                                              \   ERRORMESSAGES              01MAR20PZ                                          ч X *PREPROCESS-IN-STRING*                    X" PREPROCESSOR CALL IN STRING"     ч X *MEMSETUP*                             X" BAD MEMORY SETUP: NO STATIC SPACE"  ч X *NOLAYOUT*  X" NO '#PRAGMA CC64'"    ч X *BAD-MAIN*  X" MAIN'S NO FUNCTION"   ч X *LINK*      X" LINKER FILE ERROR"    ч X *OBJ-LONG* X" OBJECT FILE TOO LONG"  ч X *OBJ-SHORT*                              X" OBJECT FILE TOO SHORT"            ч X *STACK*     X" STACK OVERFLOW"       ч X *RSTACK*  X" RETURN STACK OVERFLOW"  ч X (*COMPILER*   X" COMPILER ERROR"       ENDTAB                                                                          ч CREATE ERR-BLK  0 ,                                                             э : *COMPILER* ( -- )                         BLK @  ERR-BLK @ +  >IN @ 41 /           1024 * + [COMPILE] LITERAL               COMPILE ERR-BLK  COMPILE !               COMPILE (*COMPILER* ; IMMEDIATE                                                                            02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ INPUT: LOADSCREEN            20SEP94PZ                                          \ TERMINOLOGIE:                                                                   \ NEWLINE                                \ OPEN-INPUT    CLOSE-INPUT              \ OPEN-INCLUDE  CLOSE-INCLUDE            \ CHAR>         +CHAR                    \ LINE                                   \ COMMENT-LINE  COMMENT-STATE            \ #EOF                                   \ PRINTCONTEXT                                                                      .( MODULE INPUT ) CR                                                              1 5 +THRU                                                                                                                                                                                                                                                                                                                                                                                                              \   INPUT :  VARIABLE          14SEP94PZ                                          э 4 CONSTANT MAX-LEVEL                   э VARIABLE INCLUDE-LEVEL                 э CREATE NAME[]                                    /FILENAME MAX-LEVEL * ALLOT    э CREATE LINE[]    MAX-LEVEL 2* ALLOT    э CREATE FILEPOS[] MAX-LEVEL 2* ALLOT                                             ч VARIABLE COMMENT-STATE                 ч VARIABLE COMMENT-LINE                  э VARIABLE EOF                                                                    ч DOER PREPROCESS                                                                 э VARIABLE INPTR                                                                  ч : +CHAR  ( -- )  1 INPTR +! ;          ч : CHAR>  ( -- C )  INPTR @ C@ ;        \ : CHAR>  ( -- C )   EOF @              \    иф #EOF елсе INPTR @ C@ тхен ;                                               э : RES-INPTR  LINEBUF INPTR ! ;                                                                                          \   INPUT: OPEN/CLOSE-INPUT    11SEP94PZ                                          ч : SOURCE-NAME     INCLUDE-LEVEL @                       /FILENAME * NAME[] + ;  ч : LINE  INCLUDE-LEVEL @ 2* LINE[] + ;  э : FILEPOS         INCLUDE-LEVEL @                             2* FILEPOS[] + ;                                           ч : CLOSE-INPUT ( -- )                        COMMENT-STATE @                             иф *COMMENT* ERROR                       COMMENT-LINE @ U.                        " */" LINEBUF STRCPY                     елсе LINEBUF OFF тхен                 SOURCE-FILE FCLOSE ;                                                         э : OPEN-SOURCE  ( -- )                       ASCII R ASCII S SOURCE-NAME              SOURCE-FILE FOPEN  RES-INPTR ;                                               ч : OPEN-INPUT ( NAME -- )                    SOURCE-NAME STRCPY                       EOF OFF  COMMENT-STATE OFF               LINE OFF  LINEBUF OFF  FILEPOS OFF       OPEN-SOURCE ;                      \   INPUT: OPEN/CLOSE-INCLUDE  11SEP94PZ                                          ч : CLOSE-INCLUDE ( -- )                      CLOSE-INPUT                              INCLUDE-LEVEL @                             иф -1 INCLUDE-LEVEL +!                   ." END OF INCLUDE FILE" CR               REOPEN-OUTFILES  OPEN-SOURCE             SOURCE-FILE FSETIN                       FILEPOS @ FSKIP  FUNSET                  елсе ." END OF SOURCE FILE" CR           #EOF EOF ! тхен ;                                                         ч : OPEN-INCLUDE  ( NAME -- )                 ." INCLUDE-FILE: "                       DUP COUNT TYPE CR                        INCLUDE-LEVEL @ 1+ DUP MAX-LEVEL U<         иф INCLUDE-LEVEL !                       SOURCE-FILE FCLOSE                       REOPEN-OUTFILES  OPEN-INPUT              елсе *INC-NEST* ERROR  2DROP             тхен ;                                                                                                                                                     \   INPUT :  NEWLINE           14SEP94PZ                                          ч VARIABLE LISTING  LISTING ON                                                    э : PRINTSOURCELINE  ( -- )                   LINEBUF /LINEBUF BOUNDS                  до и C@ ?DUP 0= иф леаже тхен            EMIT лооп CR ;                                                               ч : NEWLINE ( -- )                            SOURCE-FILE FEOF?                           иф CLOSE-INCLUDE                         EOF @ ?EXIT тхен                      1 LINE +!                                SOURCE-FILE FSETIN                       LINEBUF /LINEBUF 1- #CR FGET2DELIM          *LONGLINE* ?ERROR                     DUP FILEPOS +!                           1- /LINEBUF 1- UMIN                      LINEBUF + 0 SWAP C!                      FUNSET                                   LISTING @ иф LINE @ U.                          ." : " PRINTSOURCELINE тхен       RES-INPTR  PREPROCESS ;                                                     \   INPUT :  PRINTCONTEXT      11SEP94PZ                                          MAKE PRINTCONTEXT  ( -- )                      CONTEXT? @ 0= ?EXIT                      LINEBUF C@ 0= ?EXIT                      PRINTSOURCELINE                          INPTR @ LINEBUF - 1- 0 MAX               SPACES асции ^ EMIT  CR ;                                                   ч : INIT-INPUT ( -- )                         INCLUDE-LEVEL OFF                        LINEBUF OFF  RES-INPTR                   CONTEXT? ON ;                           INIT: INIT-INPUT                                                              \ CONTEXT? IS DEFINED IN ERRORHANDLER    \ AND SHALL AVOID CONTEXT PRINTING       \ IF AN ERROR OCCURS DURING INIT WHILE   \ NO VALID LINEBUF CONTENT EXISTS.                                                                                                                                                                                                                                                            \ SCANNER: LOADSCREEN          20SEP94PZ                                          \ TERMINOLOGIE:                          \   NEXTWORD   BACKWORD                  \   MARK       ADVANCED?                 \   WORD.                                \   START$     BUILD$      END$          \   ALLE TOKENS                          \   INIT-SCANNER                                                                    .( MODULE SCANNER ) CR                                                           1 15 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \   SCANNER:                   26FEB91PZ                                          э : ALPHA?  ( C -- FLAG )                    DUP  ASCII A ASCII [ UWITHIN             OVER ASCII а ASCII ш UWITHIN OR          SWAP ASCII _ = OR ;                                                           э : NUM?  ( C -- FLAG )                      ASCII 0  ASCII :  UWITHIN ;                                                   э : ALPHANUM? ( C -- FLAG )                  DUP ALPHA?  SWAP NUM?  OR ;                                                   э : SKIPBLANKS  ( -- )                        бегин CHAR> BL = вхиле                   +CHAR репеат ;                                                               ч 0 CONSTANT #CHAR#                      ч 1 CONSTANT #ID#                        ч 2 CONSTANT #NUMBER#                    ч 3 CONSTANT #KEYWORD#                   ч 4 CONSTANT #OPER#                      ч 5 CONSTANT #STRING#                    ч -1 DUP 2CONSTANT #EOF#                                                         \   SCANNER:                   12JAN91PZ                                          э STRINGTAB KEYWORD                                                               ч X <AUTO>     X" AUTO"                  ч X <BREAK>    X" BREAK"                 ч X <CASE>     X" CASE"                  ч X <CHAR>     X" CHAR"                  ч X <CONT>     X" CONTINUE"              ч X <DEFAULT>  X" DEFAULT"               ч X <DO>       X" DO"                    ч X <ELSE>     X" ELSE"                  ч X <EXTERN>   X" EXTERN"                ч X <FOR>      X" FOR"                   ч X <GOTO>     X" GOTO"                  ч X <IF>       X" IF"                    ч X <INT>      X" INT"                   ч X <REGISTER> X" REGISTER"              ч X <RETURN>   X" RETURN"                ч X <STATIC>   X" STATIC"                ч X <SWITCH>   X" SWITCH"                ч X <WHILE>    X" WHILE"                                                            ENDTAB                                                                         \   SCANNER:                   18APR94PZ                                          э VARIABLE TOKEN                                                                  ч : SCANWORD  ( ADR TABLE -- FALSE )                 ( ADR TABLE -- TOKEN TRUE )       TOKEN OFF                                бегин ?DUP вхиле                         2DUP >STRING STRCMP                         иф 2DROP TOKEN @ TRUE EXIT тхен       +STRING  1 TOKEN +! репеат               DROP FALSE ;                                                                 ч : KEYWORD?  ( ADR -- FALSE )                         ( ADR -- TOKEN TRUE )           KEYWORD  SCANWORD ;                                                                                                                                                                                                                                                                                                                                                                                                 \   SCANNER:                   18APR94PZ                                          э CREATE ID-BUF  /ID 1+ ALLOT                                                     э : GET-ID ( -- )                             ID-BUF 1+ /ID BOUNDS                     до CHAR> и C! +CHAR CHAR>                ALPHANUM? 0=                                иф и ID-BUF - ID-BUF C!                  унлооп EXIT тхен                      лооп /ID ID-BUF C!                       бегин +CHAR CHAR>                        ALPHANUM? 0= унтил ;                                                         э : ID ( -- WORD TYPE )                       GET-ID  ID-BUF KEYWORD?                     иф #KEYWORD#                             елсе ID-BUF #ID# тхен ;                                                                                                                                                                                                                                                                                                        \   SCANNER:                   08OCT90PZ                                          э CREATE OPERATOR-LIST                    ," +++---**///%%&&&эээ^^!!==<<<<>>>>ч"   ," += -= = =* = =& =э = = = <<= >>=  "   ,"                          =   =    "                                           э STRINGTAB OP                             ?HEAD OFF  ч  ?HEAD @ 34 * ?HEAD !       X <++>    X <+=>    X <+>                X <-->    X <-=>    X <->                X <*=>    X <*>                          X </=>    X <COMMENT>         X </>      X <%=>    X <%>                          X <AND=>  X <L-AND> X <AND>              X <OR=>   X <L-OR>  X <OR>               X <XOR=>  X <XOR>                        X <!=>    X <!>                          X <==>    X <=>                          X <<<=>   X <<<>    X <<=>    X <<>      X <>>=>   X <>>>    X <>=>    X <>>      X <INV>                                                                           ENDTAB                                                                         \   SCANNER:                   08OCT90PZ                                          э : OPERATOR?  ( C -- TOKEN T/ -- F )         OPERATOR-LIST COUNT 0                    до 2DUP и + C@ =                           иф 2DROP  +CHAR                          и TRUE унлооп EXIT тхен                лооп  2DROP FALSE ;                                                          э : TH-CHAR ( TOKEN1 N -- TOKEN2 )            OPERATOR-LIST SWAP 1                        до COUNT + лооп COUNT ROT                до DUP и + C@  DUP  BL =                    иф 2DROP                                 и унлооп EXIT тхен                    CHAR> =                                     иф DROP +CHAR                            и унлооп EXIT тхен                    лооп  *COMPILER* FATAL ;                                                  э : OPERATOR ( TOKEN1 -- TOKEN2 #OP# )        2 TH-CHAR  3 TH-CHAR  #OPER# ;                                                                                                                                \   SCANNER:                   13FEB91PZ                                          э : OCTNUM ( -- N )                           0 бегин CHAR> ASCII 0 -                  DUP 8 U< вхиле                           SWAP 8 * +  +CHAR репеат DROP ;                                              э : DEZNUM ( -- N )                           0 бегин CHAR> ASCII 0 -                  DUP 10 U< вхиле                          SWAP 10 * +  +CHAR репеат DROP ;                                             э : HEXDIGIT ( C -- N/-1 )                    CAPITAL  ASCII 0 -                       DUP 10 U< ?EXIT                          [ ASCII а ASCII 0 - ] LITERAL -          DUP 6 U< иф 10 +                                  елсе DROP -1 тхен ;                                                 э : HEXNUM ( -- N )                           0 бегин CHAR> HEXDIGIT                   DUP 16 U< вхиле                          SWAP 16 * +  +CHAR репеат DROP ;                                                                                     \   SCANNER:                   03OCT90PZ                                          э : NUMBER ( -- N #NUMBER# )                  CHAR> ASCII 0 =                             иф +CHAR CHAR> CAPITAL                   ASCII ь = иф +CHAR HEXNUM                          елсе OCTNUM тхен               елсе DEZNUM тхен #NUMBER# ;                                                                                        э CREATE CHARLIST ," ()[]шщ,;:"                                                   э : LEGALCHAR? ( C -- C TRUE  )                         ( C --   FALSE )               CHARLIST COUNT BOUNDS                    до DUP и C@ =                               иф унлооп TRUE EXIT тхен              лооп DROP *LEX* ERROR FALSE ;                                                                                                                                                                                                                                                                                                     \   SCANNER:                   02MAR94PZ                                          э CREATE \LIST ," BTNFR0\' "               ASCII " HERE 1- C!                       8 C, 9 C, 13 C, 12 C, 13 C, 0 C,         ASCII \ C,  ASCII ' C,  ASCII " C,                                              э 256 CONSTANT NONE                                                               э : \CHAR ( -- C )                            CHAR> 0= иф NEWLINE NONE EXIT тхен       \LIST COUNT BOUNDS                       до и C@ CHAR> =                             иф +CHAR и \LIST C@ + C@                 унлооп EXIT тхен                      лооп                                     CHAR> ASCII 1 ASCII 8 UWITHIN               иф 0  3 0 до CHAR> ASCII 0 -             7 OVER U< иф DROP леаже тхен             SWAP 8 * +  +CHAR лооп  255 AND          елсе NONE тхен ;                                                                                                                                                                                    \   SCANNER:                   03OCT90PZ                                          э 512 CONSTANT ERR                                                                э : CHAR-CONST ( -- C #NUMBER# )              бегин CHAR> 0 CASE?                         иф *EOL* ERROR ERR                       елсе +CHAR ASCII ' CASE?                    иф *LEX* ERROR ERR                       елсе ASCII \ CASE?                          иф \CHAR тхен тхен тхен         DUP NONE - унтил                         DUP ERR -                                  иф CHAR> ASCII ' =                         иф +CHAR елсе *LEX* ERROR тхен         тхен                                   255 AND #NUMBER# ;                                                                                                                                                                                                                                                                                                                                                         \   SCANNER:                   21FEB91PZ                                          э VARIABLE DO$                           э : $: цREATE C,                                дOES> C@ DO$ @ + PERFORM ;                                                 э 0 $: $[  ( -- SYS )                    э 2 $: $,  ( C -- )                      э 4 $: ]$  ( SYS -- DESC )                                                        э VARIABLE $PENDING                                                               ч : DO$:  цREATE:                            дOES> ( PFA -- DESC )  DO$ !              $PENDING @ 0= *COMPILER* ?FATAL          $[ бегин CHAR> 0= *EOL* ?ERROR           CHAR> вхиле CHAR> ASCII " - вхиле        CHAR> +CHAR ASCII \ CASE?                   иф \CHAR тхен                         DUP NONE =                                  иф DROP елсе 255 AND $, тхен          репеат                                   CHAR> иф +CHAR тхен                      0 $,  ]$  $PENDING OFF ;                                                    \   SCANNER:                   14SEP94PZ                                          э : STRING ( -- ??? #STRING# )                $PENDING ON  0 #STRING# ;                                                                                             э : (NEXTWORD ( -- WORD TYPE )                $PENDING @  *COMPILER* ?FATAL            бегин                                     бегин SKIPBLANKS  CHAR> 0=               EOF @ 0= AND вхиле NEWLINE репеат       EOF @ #EOF = иф #EOF#  EXIT тхен         CHAR> ALPHA? иф ID EXIT тхен             CHAR> NUM?   иф NUMBER EXIT тхен         CHAR> OPERATOR?                                       иф OPERATOR EXIT тхен       CHAR> ASCII " =                             иф +CHAR STRING EXIT тхен             CHAR> ASCII ' =                             иф +CHAR CHAR-CONST EXIT тхен         CHAR> +CHAR LEGALCHAR? унтил             #CHAR# ;                                                                                                                                                      \   SCANNER:                   09OCT90PZ                                          э : IS-COMMENT? ( W T -- W T FLAG )           2DUP <COMMENT> #OPER# DNEGATE D+         OR 0= ;                                                                      э ' COMMENT-STATE алиас ST                                                        э : SKIP-COMMENT ( -- )                       LINE @ COMMENT-LINE !                    2 ST !                                   бегин CHAR> +CHAR ASCII * CASE?             иф 1 ST !                                елсе ASCII / CASE?                          иф ST @ 1 = иф ST OFF                                елсе 2 ST ! тхен             елсе 2 ST ! 0=                              иф NEWLINE тхен тхен тхен       ST @ 0= унтил ;                                                                                                                                                                                                                                                                          \   SCANNER:                   11MAR91PZ                                          э 2VARIABLE WORD'                        э VARIABLE BACK                          э VARIABLE WORD#                                                                  ч : NEXTWORD ( -- WORD TYPE )                 BACK @ BACK OFF  иф WORD' 2@ елсе         бегин (NEXTWORD IS-COMMENT? вхиле        2DROP SKIP-COMMENT репеат                2DUP WORD' 2! тхен                      1 WORD# +! ;                                                                 ч : BACKWORD ( -- )                           BACK @ *COMPILER* ?FATAL                 BACK ON  -1 WORD# +! ;                                                       ч : MARK ( -- WORD# )  WORD# @ ;                                                  ч : ADVANCED? ( WORD# -- FLAG )               WORD# @ = 0= ;                                                               ч : INIT-SCANNER                            BACK OFF  $PENDING OFF  WORD# OFF ;       INIT: INIT-SCANNER                  \   SCANNER: WORD.             03OCT90PZ                                          э : KEYWORD. ( N )                            KEYWORD SWAP STRING[]                    >STRING COUNT TYPE ;                                                         э : EMIT' ( C ) DUP BL -                           иф EMIT елсе DROP тхен ;       э : OPER. ( N )  OPERATOR-LIST 2DUP             1+ + C@ EMIT    COUNT + 2DUP             1+ + C@ EMIT'   COUNT +                  1+ + C@ EMIT' ;                                                            ч : WORD.  ( N TYP )                       #KEYWORD# CASE? иф KEYWORD. EXIT тхен    #OPER#    CASE? иф OPER.    EXIT тхен    #NUMBER#  CASE? иф .        EXIT тхен    #CHAR#    CASE? иф EMIT     EXIT тхен    #ID#      CASE? иф COUNT TYPE                                        EXIT тхен    #STRING#  CASE? иф ." STRING @ " U.                                  EXIT тхен    ." WORD T:" . ." N:" . ;                                                                                                                               13FEB91PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ OLD STORESTRING              23FEB91PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ ERRORHANDLER : LOADSCREEN    20SEP94PZ                                            .( MODULE ERRORHANDLER ) CR                                                       1 2 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \   ERRORHANDLER               11SEP94PZ                                          ч VARIABLE ANY-ERRORS?                   ч VARIABLE CONTEXT?                      ч DOER PRINTCONTEXT                                                               ч : INIT-ERROR  ANY-ERRORS? OFF                          CONTEXT? OFF ;               INIT: INIT-ERROR                                                              ч DOER CLOSE-FILES  ( -- )               ч DOER SCRATCHFILES ( -- )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   ERRORHANDLER               11SEP94PZ                                          ч : ERROR ( ERRNUM -- )                       ERRORMESSAGE SWAP STRING[]               CR >STRING COUNT TYPE  CR                PRINTCONTEXT  ANY-ERRORS? ON ;                                               ч : ?ERROR ( FLAG ERRNUM -- )                SWAP иф ERROR елсе DROP тхен ;                                                                                         ч : FATAL ( ERRNUM -- )                       DUP ERROR  (*COMPILER* =                   иф ERR-BLK @ DUP 1024 /                  SWAP 1023 AND ." LOCATION: BLK "         . ."  LINE " . CR тхен                 CLOSE-FILES SCRATCHFILES                 TRUE ABORT" FATAL ERROR" ;                                                   ч : ?FATAL ( FLAG ERRNUM -- )                 SWAP иф FATAL елсе DROP тхен ;                                                                                                                                                                                                        02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ SYMTAB: LOADSCREEN           20SEP94PZ                                          \ TERMINOLOGIE:                          \ FINDLOCAL    PUTLOCAL                  \ NESTLOCAL    UNNESTLOCAL               \ FINDGLOBAL   PUTGLOBAL                 \ INIT-SYMTAB                                                                       .( MODULE SYMTAB ) CR                                                             1 5 +THRU                                                                       \\ SYMBOL FORMAT:                         [ NAME$(COUNTED)][ /SYMBOL BYTES DATA ]                                          SYMBOL TABLE FORMAT:                      SYMTAB[//GLOBALS//   //LOCALS//]SYMTAB            GLOBALS>^   ^LOCALS>                                                     HASH[////POINTERS TO GLOBALS/////]HASH                                           MARKS IN THE LOCAL SYMBOL TABLE:          END OF BLOCK LOCAL TABLE:  )BLOCK        END OF TOTAL LOCAL TABLE:  )LOCAL                                               \ SYMTAB: DIV.                 11MAR91PZ                                          э 63 CONSTANT /NAME                      э 255 CONSTANT )LOCAL   \ MARKEN         э 254 CONSTANT )BLOCK   \                \ ES MUSS /NAME < )BLOCK < )LOCAL < 256                                           э : CUTNAME ( NAME -- )                       DUP C@ /NAME UMIN SWAP C! ;                                                  э CREATE DUMMY  /SYMBOL ALLOT                                                     э VARIABLE GLOBALS>                      э VARIABLE LOCALS>                                                                ч : INIT-SYMTAB                               HASH[ ]HASH OVER - ERASE                 SYMTAB[ GLOBALS> !                       ]SYMTAB 1-  )LOCAL OVER C!               LOCALS> ! ;                                                                      INIT: INIT-SYMTAB                                                                                                                                              \ SYMTAB: LOCALS               14FEB91PZ                                          э : (FINDLOC) ( NAME ENDMARK -- DFA/0 )       ]SYMTAB LOCALS> @                        ?до DUP и C@ > NOT                          иф 2DROP 0 унлооп EXIT тхен           и C@ /NAME > иф 1                           елсе OVER и STRCMP                          иф 2DROP и COUNT +                       унлооп EXIT тхен                      и C@ 1+ /SYMBOL + тхен                +лооп  *COMPILER* FATAL ;                                                    ч : FINDLOCAL ( NAME -- DFA/0 )               DUP CUTNAME  )LOCAL (FINDLOC) ;                                              ч : FINDPARAM ( NAME -- DFA/0 )               DUP CUTNAME  )BLOCK (FINDLOC) ;                                              э : SPACIOUS? ( N -- FLAG )                   LOCALS> @ GLOBALS> @ - U> 0= ;                                                                                                                                                                         \   SYMTAB: LOCALS             14FEB91PZ                                          ч : PUTLOCAL ( NAME -- DFA )                  DUP C@ 0= иф DROP DUMMY EXIT тхен        DUP CUTNAME   DUP )BLOCK (FINDLOC)          иф DROP DUMMY                            *DOUBLEDEF* ERROR  EXIT тхен          DUP C@ 1+ /SYMBOL + SPACIOUS?               иф LOCALS> @ /SYMBOL - UNDER             OVER C@ 1+ UNDER - UNDER                 LOCALS> !  CMOVE                         елсе DROP DUMMY                          *SYMOVFL* ERROR тхен ;                                                    ч : NESTLOCAL ( -- )                          1 SPACIOUS? иф LOCALS> @ 1-              )BLOCK OVER C!  LOCALS> !                елсе *SYMOVFL* ERROR тхен ;                                                  ч : UNNESTLOCAL ( -- )                        ]SYMTAB LOCALS> @ ?до                    и C@ )BLOCK = иф и 1+ LOCALS> !                        унлооп EXIT тхен           лооп *COMPILER* FATAL ;                                                     \ SYMTAB: GLOBALS              18FEB91PZ                                          э : HASH ( NAME -- N )                        0 SWAP COUNT BOUNDS                         ?до 2* и C@ + лооп ;                                                      э : (FINDGLB) ( NAME -- DFA   TRUE )                   ( NAME -- ADR/0 FALSE )         DUP HASH #GLOBALS U/MOD DROP             2* HASH[ + DUP                           до и ]HASH U< NOT                           иф HASH[ >и тхен                      и @ ?DUP                                    иф OVER STRCMP                              иф DROP и @ COUNT +  TRUE                унлооп EXIT тхен                      елсе DROP и  FALSE унлооп EXIT           тхен                                  2 +лооп DROP 0  FALSE ;                                                                                                                                                                                                                                                                  \   SYMTAB: GLOBALS            14FEB91PZ                                          ч : FINDGLOBAL ( NAME -- DFA/0 )              DUP CUTNAME  (FINDGLB) AND ;                                                 ч : PUTGLOBAL  ( NAME -- DFA )                DUP C@ 0= иф DROP DUMMY EXIT тхен        DUP CUTNAME  DUP (FINDGLB)                  иф 2DROP DUMMY                           *DOUBLEDEF* ERROR EXIT тхен           ?DUP 0=                                     иф DROP DUMMY                            *GLBOVFL* ERROR EXIT тхен             OVER C@ 1+ /SYMBOL +  SPACIOUS?             иф GLOBALS> @ SWAP !                     GLOBALS> @ OVER C@ 1+ CMOVE              GLOBALS> @ COUNT +                       DUP  /SYMBOL + GLOBALS> !                елсе 2DROP DUMMY                         *SYMOVFL* ERROR тхен ;                                                                                                                                                                                                                       \ SAVESTACK: LOADSCREEN        26FEB91PZ                                          \ TERMINOLOGIE:                                                                   \ +SAVESTACK    -SAVESTACK               \ ?SAVESTACK    ?LOADSTACK                                                          1 3 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \   SAVESTACK:                 10SEP94PZ                                          э CREATE ST-NAME ," %%ST  "                                                       э : TH-FILE  ( N -- )                         DUP 255 U> *STACKOVFL* ?FATAL            16 /MOD 256 * +                          [ ASCII A DUP 256 * + ] LITERAL          +  ST-NAME 5 + ! ;                                                           э : ST-OPEN ( MODE -- )                       ASCII S STACK-FILE ST-NAME FOPEN ;                                           э : ST-CLOSE ( -- )                           STACK-FILE FCLOSE ;                 \\                                       э : SCRATCH-STACKS ( -- )                     STACK-DEV 2@ DROP 15 BUSOUT              " S0:%%ST??" COUNT BUSTYPE               BUSOFF ;                            \    DERROR? *FILE* ?FATAL ;                                                                                                                                                                                \   SAVESTACK:                 10SEP94PZ                                          э : SAVESTACK ( OLDSTACK N -- )               TH-FILE  ASCII W ST-OPEN                 STACK-FILE FSETOUT                       SP@ S0 @ OVER -                          DUP >LO/HI FPUTC FPUTC                   FPUTS   FUNSET                           ST-CLOSE  CLEARSTACK ;                                                       э : LOADSTACK ( N -- OLDSTACK )               TH-FILE  ASCII R ST-OPEN                 STACK-FILE FSETIN                        FGETC FGETC SWAP LO/HI> >R               S0 @ R@ -  DUP HERE $100 + S0 @ 1+       UWITHIN NOT *COMPILER* ?FATAL            SP!  SP@ R> FGETS DROP FUNSET            ST-CLOSE ;                                                                                                                                                                                                                                                                                                                        \   SAVESTACK:                 09SEP94PZ                                          э VARIABLE STACKS                                                                 ч : ?SAVESTACK ( -- )                         SP@ HERE - $110 U<                          иф STACKS @ SAVESTACK                    1 STACKS +! тхен ;                                                        ч : ?LOADSTACK ( -- )                         DEPTH 0=                                    иф STACKS @ DUP                          0= *COMPILER* ?FATAL                     1- DUP STACKS !  LOADSTACK               тхен ;                                                                    ч : +SAVESTACK ( -- )  STACKS OFF ;                                               ч : -SAVESTACK ( -- )                         STACKS @  *COMPILER* ?FATAL ;       \    SCRATCH-STACKS ;                                                                                                                                                                                                                      02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ CODEHANDLER: LOADSCREEN      20SEP94PZ                                            .( MODULE CODEHANDLER ) CR                                                        1 4 +THRU                                                                       \ TERMINOLOGIE:                                                                   \ FUER PROGRAMMCODE:                     \ B!  W!  B,  W,  PC  *=  FLUSHCODE                                               \ FUER STATISCHE VARIABLE:               \ CSTAT,  STAT,  >STATICADR  STATICADR>  \ FLUSHSTATIC                                                                     \ FUER DYNAMISCHE VARIABLE:              \ TOS-OFFS  DYN-ALLOT                                                             \ FUER CODELAYOUT:                       \ LIB.FIRST          CODELAYOUT.OK       \ CODE.FIRST         END-OF-CODE         \ CODE.LAST                              \ STATICS.FIRST                          \ STATICS.LIBFIRST                       \ STATICS.LAST                          \   CODEHANDLER: DYNAMICS,INIT 19APR94PZ                                          ч VARIABLE TOS-OFFS                                                               ч : DYN-ALLOT ( N -- OFFS )                   TOS-OFFS @  SWAP TOS-OFFS +! ;                                                                                                                                 ч DOER FLUSHCODE ( -- )                                                           ч DOER FLUSHSTATIC ( -- )                                                                                                  э VARIABLE NOLAYOUT                                                               ч : INIT-CODEHANDLER  NOLAYOUT ON ;                                                  INIT: INIT-CODEHANDLER                                                                                                                                                                                                                                                                     \   CODEHANDLER: CODE          19APR94PZ                                          э VARIABLE >PC                           ч : PC  >PC @ ;                                                                   э VARIABLE CODEOFFSET                    э : CLEARCODE ( -- )                          PC CODE[ - CODEOFFSET ! ;           ч : *=   >PC !  CLEARCODE ;                                                       э : >CODEADR ( PC-ADR -- CODE-BUF-ADR )      NOLAYOUT @  *NOLAYOUT* ?FATAL            CODEOFFSET @ - DUP                       CODE[ ]CODE 1- UWITHIN                   0= *FUNCTOLONG* ?FATAL ;                                                      ч : B! ( 8B PC-ADR -- )  >CODEADR C! ;   ч : W! ( 16B PC-ADR -- )  >CODEADR ! ;                                            ч : B,  ( 8B -- )     PC B! 1 >PC +! ;   ч : W,  ( 16B -- )    PC W! 2 >PC +! ;                                                                                                                                                                      \   CODEHANDLER: STATICS       19APR94PZ                                          э VARIABLE STATIC-OFFSET                 э VARIABLE STATIC>                                                                э : CLEARSTATIC ( -- )                      STATIC[ STATIC> ! ;                                                            ч : STATICADR> ( -- CURRENT.ADRESS )          NOLAYOUT @  *NOLAYOUT* ?FATAL            STATIC-OFFSET @ STATIC> @ - ;                                                ч : >STATICADR ( ADR -- )                     CLEARSTATIC                              STATIC> @ + STATIC-OFFSET ! ;                                                ч : CSTAT, ( 8B -- )                          STATIC> @ C!  1 STATIC> +!               STATIC> @ ]STATIC U< NOT                    иф FLUSHSTATIC тхен ;                                                     ч : STAT, ( 16B -- )                          >LO/HI CSTAT, CSTAT, ;                                                                                               \   CODEHANDLER : CODELAYOUT   11SEP94PZ                                          ч VARIABLE LIB.FIRST                     ч VARIABLE CODE.FIRST                    ч VARIABLE CODE.LAST                     ч VARIABLE STATICS.FIRST                 ч VARIABLE STATICS.LIBFIRST              ч VARIABLE STATICS.LAST                  ч VARIABLE LIB.CODENAME  15 ALLOT        ч VARIABLE LIB.INITNAME  15 ALLOT                                                 ч CREATE CODE.SUFFIX ," .O"              ч CREATE INIT.SUFFIX ," .I"              ч CREATE DECL.SUFFIX ," .H"              ч : CUT-SUFFIX  ( STR -- )                    DUP C@ 2- SWAP C! ;                                                          ч : CODELAYOUT.OK  NOLAYOUT OFF ;                                                 ч : END-OF-CODE  ( -- )                       FLUSHSTATIC                              FLUSHCODE                                STATICADR> STATICS.FIRST !               PC         CODE.LAST     ! ;                                                \ CODEOUTPUT: FLUSHCODE/STATIC 11SEP94PZ                                          MAKE FLUSHCODE ( -- )                       CODE-FILE FSETOUT                        CODE[  PC >CODEADR  OVER -  FPUTS        FUNSET  CLEARCODE ;                                                            MAKE FLUSHSTATIC ( -- )                     STATIC-FILE FSETOUT                      STATIC[  STATIC> @  OVER - FPUTS         STATIC[ STATIC> @ - STATIC-OFFSET +!     FUNSET  CLEARSTATIC ;                                                          \\ NOCH SCHLECHT MODULARISIERT:             GREIFT AUF INTERNE WORTE DES             CODEHANDLERS ZURUECK.                                                                                                                                                                                                                                                                                                                                                                                                 \ FILEMAN: LOADSCREEN          20SEP94PZ                                            .( MODULE FILEMAN ) CR                                                            1 3 +THRU                                                                       \ TERMINOLOGIE:                                                                   \ SOURCE-FILE                            \ CODE-FILE       CODE-NAME              \ STATIC-FILE     STATIC-NAME                                                     \ /FILENAME                              \ DEV             DEV#                                                            \ CLOSE-FILES     SCRATCHFILES           \ OPEN-OUTFILES   CLOSE-OUTFILES         \ REOPEN-OUTFILES                                                                 \ INIT-FILES                                                                                                                                                                                                                                         \   FILEMAN:                   20SEP94PZ                                          ч FHANDLE SOURCE-FILE                    ч FHANDLE CODE-FILE                      ч FHANDLE STATIC-FILE                    ч FHANDLE EXE-FILE                                                                ч 17 CONSTANT /FILENAME                  ч CREATE EXE-NAME   /FILENAME ALLOT                                               ч CREATE CODE-NAME    ," %%CODE"         ч CREATE STATIC-NAME  ," %%INIT"                                                    CREATE DEV#  8 C,                        : DEV   ( -- DEV )  DEV# C@ ;          ч CREATE AUX#  8 C,                      ч : AUX   ( -- AUX )  AUX# C@ ;                                                   ч : INIT-FILES                                DEV 2 SOURCE-FILE  SET-FHANDLE           AUX 3 CODE-FILE    SET-FHANDLE           AUX 4 STATIC-FILE  SET-FHANDLE           DEV 5 EXE-FILE     SET-FHANDLE ;                                                 INIT: INIT-FILES                    \   FILEMAN:                   11SEP94PZ                                          э : LOADADR!  ( HANDLE -- )                   FSETOUT 0 FPUTC 64 FPUTC FUNSET ;                                            ч : OPEN-OUTFILES  ( -- )                     ASCII W ASCII P CODE-NAME                CODE-FILE FOPEN                          CODE-FILE LOADADR!                       ASCII W ASCII P STATIC-NAME              STATIC-FILE FOPEN                        STATIC-FILE LOADADR! ;                                                       ч : CLOSE-OUTFILES  ( -- )                    CODE-FILE   FCLOSE                       STATIC-FILE FCLOSE ;                                                         ч : REOPEN-OUTFILES  ( -- )                   CLOSE-OUTFILES                           ASCII A ASCII P CODE-NAME                CODE-FILE FOPEN                          ASCII A ASCII P STATIC-NAME              STATIC-FILE FOPEN ;                                                                                                  \   FILEMAN:                   13APR20PZ                                          MAKE CLOSE-FILES  ( -- )                       SOURCE-FILE  FCLOSE                      EXE-FILE     FCLOSE                      CLOSE-OUTFILES ;                                                            MAKE SCRATCHFILES ( -- )                   ." SCRATCHING TEMPORARY FILES" CR        DEV 15 BUSOUT                            " S0:%%CODE" COUNT BUSTYPE BUSOFF        DEV 15 BUSOUT                            " S0:%%INIT" COUNT BUSTYPE BUSOFF ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ ASSEMBLER LOADSCREEN         20SEP94PZ                                            .( MODULE ASSEMBLER ) CR                                                          1 17 +THRU                                                                                                                                                                                                                                                                                                                                                                     \\ $ZP WIRD IMPLIZIT BENUTZT VON         - .NOT                                   - .MULT .MULT#                           - .DIV  .DIV#  .#DIV                     - .MOD  .MOD#  .#MOD                     - .ADD .SUB .AND .OR  .XOR               - .EQ  .NE  .GE  .LT  .GT  .LE           - .JMN  .JMN-AHEAD                       - .JMZ  .JMZ-AHEAD                                                                                                                                                 \   ASSEMBLER: RUNTIME         21AUG94PZ                                          э VARIABLE SIZE   2 SIZE !               ч VARIABLE >BASE                         ч VARIABLE >ZP                           ч VARIABLE >RUNTIME                                                               э VARIABLE O    $08C7 O !                \ HIBYTE: OFFSET-^ ^-LOBYTE: KENNBYTE    э : RT ( -- )  O @ CONSTANT                       $0300 O +! ;                    \ OFFS +=3-^ ^-KENNBYTE NICHT AENDERN                                             э RT $JMP(ZP)                            э RT $SWITCH                             э RT $MULT                               э RT $DIVMOD                             э RT $SHL                                э RT $SHR                                                                                                                                                                                                                                                                                     \   ASSEMBLER: PARAMETER       25MAY91PZ                                          э $FF07 CONSTANT &                       э $FF17 CONSTANT &+1                     э   $27 CONSTANT <&                      э   $37 CONSTANT >&                      э   $47 CONSTANT $ZP                     э   $57 CONSTANT $ZP+1                   э   $67 CONSTANT $BASE                   э   $77 CONSTANT $BASE+1                 э : W:  $87 C, 21 ;                      э : ;W  21 ?PAIRS $97 C, ;               э : B:  $A7 C, 22 ;                      э : ;B  22 ?PAIRS $B7 C, ;                                                        э : (WB:   ( PAR и ENDCODE -- STEP )                >R NIP DUP бегин 1+ DUP C@               R@ = унтил SWAP - 1+ RDROP ;            ( PAR и -- STEP )              э : (;WB  2DROP 1 ;                      э : (W:   SIZE @ 2- иф $97 (WB:                              елсе (;WB тхен ;     э : (B:   SIZE @ 1- иф $B7 (WB:                              елсе (;WB тхен ;                                             \   ASSEMBLER: PARAMETER AUSW. 25MAY91PZ                                                     ( PAR и -- STEP )             э : 0+W,   DROP     W,          2 ;      э : 1+W,   DROP  1+ W,          2 ;      э : <B,    DROP >LO B,          1 ;      э : >B,    DROP >HI B,          1 ;      э : ZP,    2DROP >ZP @    B,    1 ;      э : ZP+1,  2DROP >ZP @ 1+ B,    1 ;      э : BA,    2DROP >BASE @    B,  1 ;      э : BA+1,  2DROP >BASE @ 1+ B,  1 ;      э : RT,    1+ C@ >RUNTIME @ + W,                                   DROP  2 ;                                               э : COMPILER-ERROR  *COMPILER* FATAL ;                                            э CREATE ATAB                             ' 0+W, ,  ' 1+W, ,  ' <B, ,  ' >B, ,     ' ZP, ,  ' ZP+1, ,  ' BA, ,  ' BA+1, ,   ' (W: ,  ' (;WB ,   ' (B: ,  ' (;WB ,    ' RT, ,                                  ' COMPILER-ERROR DUP DUP , , ,                                                                                                                                    \   ASSEMBLER: A: A&: ;A       26MAY91PZ                                          э : (A: ( -- SYS )                            CREATE  HERE 0 C, 20 ASSEMBLER ;                                             э : ;A ( SYS -- )                             20 ?PAIRS  CURRENT @ CONTEXT !           HERE OVER - 1- SWAP C! ;                                                     э : A, ( PAR и B -- STEP )                    DUP $F AND $7 =                             иф 2/ 2/ 2/ 2/ 2*                        ATAB + @ EXECUTE                         елсе B, 2DROP 1 тхен ;                                                    э : A&: (A: DOES> ( PAR PFA -- )              COUNT BOUNDS                             до DUP и DUP C@ A, +лооп DROP ;                                              э : A: (A: DOES> ( PFA -- )                   COUNT BOUNDS                             до 0 и DUP C@ A, +лооп ;                                                                                                                                      \   ASSEMBLER: BASICS          26MAY91PZ                                          ч A&: .LDA#   <& # LDA  >& # LDX  ;A                                              ч A: .PHA     PHA TAY TXA PHA TYA  ;A    ч A: .PHA'    PHA     TXA PHA      ;A    ч A: .PLA A                                                                                                                                             COMPILER(1/2)═════C1═2A════                                                                                      Ъ                                                                                                                                                                                                                                                              K    PLA     TAX PLA      ;A                                             ч ' W, алиас .WORD                       ч ' B, алиас .BYTE                                                                ч A&: .JSR    & JSR  ;A                  ч A:  .JSR(ZP)  $JMP(ZP) JSR ;A          ч A:  .RTS    RTS ;A                                                              э A&: .LDY#   <& # LDY ;A                      ' .LDY#                            ч алиас .ARGS                                                                     ч A: .SHLA  .A ASL TAY TXA                           .A ROL TAX TYA ;A            ч A: .SHRA  TAY TXA .A LSR                           TAX TYA .A ROR ;A            ч A: .AND#255  0 # LDX ;A                                                        \   ASSEMBLER: BASICS          24MAY91PZ                                          ч A: .POP-ZP  TAY PLA $ZP+1 STA                            PLA $ZP   STA  TYA ;A  ч A: .STA-ZP  $ZP STA  $ZP+1 STX ;A      ч A: .LDA-ZP  $ZP LDA  $ZP+1 LDX ;A                                               ч A: .LDA-BASE $BASE LDA $BASE+1 LDX ;A                                           ч A&: .LINK#  TAY CLC   $BASE LDA                      <& # ADC  $BASE STA                      $BASE+1 LDA  >& # ADC                    $BASE+1 STA  TYA ;A                                                 ч A: .SWITCH  $SWITCH JSR ;A                                                                                                                                                                                                                                                                                                                                                                                                                                      \   ASSEMBLER: ARITHMETICS     27MAY91PZ                                          ч A: .NOT  $ZP STX  0 # LDX  $ZP ORA                0= ?[ DEX ]? TXA ;A                                                    ч A: .NEG  $FF # EOR TAY TXA                        $FF # EOR TAX                            INY 0= ?[ INX ]? TYA ;A                                                ч A: .INV  $FF # EOR TAY TXA                        $FF # EOR TAX TYA ;A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \   ASSEMBLER: ARITHMETICS     27MAY91PZ                                          ч A&: .ADD#   CLC  <& # ADC  TAY  TXA                  >& # ADC  TAX  TYA  ;A                                              ч A&: .SUB#   SEC  <& # SBC  TAY  TXA                  >& # SBC  TAX  TYA  ;A                                              ч A&: .#SUB   SEC  $FF # EOR  <& # ADC                 TAY  TXA  $FF # EOR                      >& # ADC  TAX  TYA  ;A                                              ч A&: .AND#   <& # AND  TAY  TXA                       >& # AND  TAX  TYA  ;A                                              ч A&: .OR#    <& # ORA  TAY  TXA                       >& # ORA  TAX  TYA  ;A                                              ч A&: .XOR#   <& # EOR  TAY  TXA                       >& # EOR  TAX  TYA  ;A                                                                                                                                                                                                                 \   ASSEMBLER: ARITHMETICS     24MAY91PZ                                          э A: .ADD-ZP  CLC  $ZP ADC  TAY  TXA                      $ZP+1 ADC  TAX  TYA ;A                                           э A: .SUB-ZP  SEC  $ZP SBC  TAY  TXA                      $ZP+1 SBC  TAX  TYA ;A                                           э A: .AND-ZP    $ZP AND  TAY  TXA                      $ZP+1 AND  TAX  TYA  ;A                                             э A: .OR-ZP     $ZP ORA  TAY  TXA                      $ZP+1 ORA  TAX  TYA  ;A                                             э A: .XOR-ZP    $ZP EOR  TAY  TXA                      $ZP+1 EOR  TAX  TYA  ;A                                             ч  : .ADD  .STA-ZP  .PLA  .ADD-ZP ;      ч  : .SUB  .STA-ZP  .PLA  .SUB-ZP ;      ч  : .AND  .STA-ZP  .PLA  .AND-ZP ;      ч  : .OR   .STA-ZP  .PLA  .OR-ZP  ;      ч  : .XOR  .STA-ZP  .PLA  .XOR-ZP ;                                                                                                                                \   ASSEMBLER: ARITHMETICS     24MAY91PZ                                          э A&: .LDZP#  TAY  <& # LDA    $ZP STA                      >& # LDA  $ZP+1 STA                 TYA  ;A                    э A: (.MULT    $MULT   JSR ;A            э A: (.DIVMOD  $DIVMOD JSR ;A                                                     ч : .MULT#  .STA-ZP  .LDA#  (.MULT ;     ч : .MULT   .STA-ZP  .PLA   (.MULT ;                                              ч : .DIV#   .LDZP#  (.DIVMOD ;           ч : .#DIV   .STA-ZP  .LDA#  (.DIVMOD ;   ч : .DIV    .STA-ZP  .PLA   (.DIVMOD ;                                            ч : .MOD#   .DIV#  .LDA-ZP ;             ч : .#MOD   .#DIV  .LDA-ZP ;             ч : .MOD    .DIV   .LDA-ZP ;                                                                                                                                                                                                                                                                                                           \   ASSEMBLER: ARITHMETICS     27MAY91PZ                                          э A: .TAY   TAY ;A                       э A: (.SHL  $SHL JSR ;A                  э A: (.SHR  $SHR JSR ;A                                                           ч : .SHL   .TAY   .PLA   (.SHL ;         ч : .SHL#  .LDY#         (.SHL ;         ч : .#SHL  .TAY   .LDA#  (.SHL ;                                                  ч : .SHR   .TAY   .PLA   (.SHR ;         ч : .SHR#  .LDY#         (.SHR ;         ч : .#SHR  .TAY   .LDA#  (.SHR ;                                                  \\ 'UNSIZED' IN/DECREMENTS               ч A&: .INCR  & INC  0= ?[ &+1 INC ]? ;A  ч A&: .DECR  & LDY  0= ?[ &+1 DEC ]?                  & DEC ;A                                                             ч A&: .2INCR  & LDY  $FE # CPY                         CS ?[ &+1 INC ]?                         & INC  & INC    ;A         ч A&: .2DECR  & LDY    2 # CPY                         CC ?[ &+1 DEC ]?                         & DEC  & DEC    ;A        \   ASSEMBLER: ARITHMETICS     24MAY91PZ                                          э A&: .CMP#  0 # LDY   >& # CPX                       SEC 0< ?[ CLC ]?                         0= ?[ <& # CMP ]? ;A                                                 э A: .CMP-ZP 0 # LDY   $ZP+1 CPX                      SEC 0< ?[ CLC ]?                         0= ?[ $ZP   CMP ]? ;A       э  : .CMP .STA-ZP .PLA .CMP-ZP ;                                                                                           э A: (.EQ   0=  ?[ DEY ]? TYA TAX  ;A    э A: (.NE   0<> ?[ DEY ]? TYA TAX  ;A    э A: (.GE   CS  ?[ DEY ]? TYA TAX  ;A    э A: (.LT   CC  ?[ DEY ]? TYA TAX  ;A    э A: (.GT   CS  ?[ 0<> ?[ DEY ]? ]?                                TYA TAX  ;A    э A: (.LE   HERE 4 + BCC  0= ?[ DEY ]?                             TYA TAX  ;A                                                                                                                                                                                                                \   ASSEMBLER: ARITHMETICS     24MAY91PZ                                          ч : .EQ   .CMP    (.EQ ;                 ч : .NE   .CMP    (.NE ;                 ч : .EQ#  .CMP#   (.EQ ;                 ч : .NE#  .CMP#   (.NE ;                                                          ч : .GE   .CMP    (.GE ;                 ч : .LT   .CMP    (.LT ;                 ч : .GE#  .CMP#   (.GE ;                 ч : .LT#  .CMP#   (.LT ;                                                          ч : .GT   .CMP    (.GT ;                 ч : .LE   .CMP    (.LE ;                 ч : .GT#  .CMP#   (.GT ;                 ч : .LE#  .CMP#   (.LE ;                                                                                                                                                                                                                                                                                                                                                                                                 \   ASSEMBLER: 'SIZED'         18APR94PZ                                          ч : .SIZE  SIZE ! ;                      \ EVTL NOCH BEI SIZE <>1,2 : ERROR                                                ч A&: .LDA#.S                               <& # LDA  W: >& # LDX ;W ;A                                                                                             ч A&: .LDA.S                                & LDA W: &+1 LDX ;W B: 0 # LDX ;B ;A                                           ч A&: .STA.S  & STA  W: &+1 STX ;W ;A                                                                                      ч A: .LDA.S(ZP)                             W: 1 # LDY  $ZP )Y LDA  TAX  DEY ;W      B: 0 # LDX 0 # LDY ;B  $ZP )Y LDA ;A                                           ч A: .STA.S(ZP)                             0 # LDY  $ZP )Y STA  W: PHA TXA              INY  $ZP )Y STA     PLA ;W ;A                                                                                                                               \   ASSEMBLER: 'SIZED'         18APR94PZ                                          э A&: .LDA(BASE),&                          <& # LDY  $BASE )Y LDA  W: TAX DEY                 $BASE )Y LDA ;W                 B: 0 # LDX ;B ;A                                                              ч : .LDA.S(BASE),#                             DUP 254 U>                                 иф .LDA-BASE  .ADD#                         .STA-ZP    .LDA.S(ZP)                 елсе SIZE @ 1- иф 1+ тхен                   .LDA(BASE),& тхен ;                                                                                             э A&: .STA(BASE),&                          <& # LDY  $BASE )Y STA  W: PHA TXA            INY  $BASE )Y STA     PLA ;W ;A                                           ч : .STA.S(BASE),#                             DUP 254 U>                                 иф .PHA'  .LDA-BASE  .ADD#                  .STA-ZP  .PLA  .STA.S(ZP)             елсе .STA(BASE),& тхен ;                                                 \   ASSEMBLER: 'SIZED'         27MAY91PZ                                          ч A&: .INCR.S                                   & INC W: 0= ?[ &+1 INC ]? ;W ;A                                            ч A&: .DECR.S                                   W: & LDY  0= ?[ &+1 DEC ]? ;W            & DEC ;A                                                                   ч A&: .2INCR.S                                  W: & LDY  $FE # CPY                      CS ?[ &+1 INC ]? ;W                      & INC  & INC ;A                                                            ч A&: .2DECR.S                                  W: & LDY    2 # CPY                      CC ?[ &+1 DEC ]? ;W                      & DEC  & DEC ;A                                                                                                                                                                                                                                                                                                                 \   ASSEMBLER: JUMPS           24MAY91PZ                                          ч A&: .JMP  & JMP ;A                            ' PC                              ч алиас .LABEL                                                                    ч : .JMP-AHEAD    PC  0 .JMP ;           ч : .RESOLVE-JMP  PC SWAP 1+ W! ;                                                 э A: .SKIP0<>   $ZP STX  $ZP ORA                         HERE 5 + BNE ;A          э A: .SKIP0=    $ZP STX  $ZP ORA                         HERE 5 + BEQ ;A                                                   ч : .JMZ        .SKIP0<>  .JMP ;         ч : .JMN        .SKIP0=   .JMP ;                                                  ч : .JMZ-AHEAD  .SKIP0<>  .JMP-AHEAD ;   ч : .JMN-AHEAD  .SKIP0=   .JMP-AHEAD ;                                                                                                                                                                                                                                                        \   ASSEMBLER: OLD COMPS       24MAY91PZ                                          э A&: .CMP#        >& # CPX                           0< ?[ CLC ]?                             0= ?[ <& # CMP ]? ;A        э A: .CMP-ZP       $ZP+1 CPX                          0< ?[ CLC ]?                             0= ?[ $ZP   CMP ]? ;A       э  : .CMP .STA-ZP .PLA .CMP-ZP ;                                                  э A: .BEQ   HERE 5 + BEQ ;A              э A: .BGE   HERE 5 + BCS ;A              э A: .BGT   HERE 4 + BEQ                             HERE 5 + BCS ;A              э A: .0/-1    0 # LDA  $2C C,                        $FF # LDA  TAX ;A            э A: .-1/0  $FF # LDA  $2C C,                          0 # LDA  TAX ;A            э : (.EQ  .BEQ  .0/-1 ;                  э : (.NE  .BEQ  .-1/0 ;                  э : (.GE  .BGE  .0/-1 ;                  э : (.LT  .BGE  .-1/0 ;                  э : (.GT  .BGT  .0/-1 ;                  э : (.LE  .BGT  .-1/0 ;                                                                                         02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ PREPROCESSOR LOADSCREEN      20SEP94PZ                                          \ TERMINOLOGIE:                                                                   \  PREPROCESS                                                                       .( MODULE PREPROCESSOR ) CR                                                      1 6 +THRU                                                                        \\ тHE PREPROCESSOR IS A REALLY BAD       HACK WHICH DEPENDS DEEPLY ON SPECIAL     PROPERTIES OF INPUT, SCANNER AND         CODEGEN.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \   PREPROCESSOR:              11SEP94PZ                                          э : CLEARLINE ( -- )                          LINEBUF OFF RES-INPTR ;                                                      э : CPP-ERROR  ( -- )                         *PREPROCESSOR* ERROR  CLEARLINE ;                                            э : CHECK-EOL  ( -- )                         SKIPBLANKS  CHAR> 0=                        иф RDROP  CPP-ERROR тхен ;                                                э : ?CPP-ERROREXIT  ( FLAG -- )                 иф RDROP CPP-ERROR тхен ;                                                  э : ?CPP-FATAL *PREPROCESSOR* ?FATAL ;                                            э CREATE INCLUDE-NAME /FILENAME ALLOT                                             э CREATE DELIM  1 ALLOT                                                                                                                                                                                                                              \   PREPROCESSOR:              11SEP94PZ                                          э : INCLUDE ( -- )                            CHECK-EOL                                CHAR> ASCII < =                          CHAR> ASCII " =                          OR NOT ?CPP-ERROREXIT                    CHAR> ASCII < CASE? иф ASCII > тхен      DELIM C!  +CHAR                          INCLUDE-NAME 1+ 16 BOUNDS                до CHAR> 0= ?CPP-ERROREXIT                  CHAR> DELIM C@ =                            иф и INCLUDE-NAME - 1-                   унлооп DUP INCLUDE-NAME C!               0= ?CPP-ERROREXIT                        INCLUDE-NAME OPEN-INCLUDE                EXIT тхен                          CHAR> и C! +CHAR лооп                    бегин CHAR> 0= ?CPP-ERROREXIT            CHAR> +CHAR DELIM C@ = унтил             /FILENAME 1- INCLUDE-NAME C!             INCLUDE-NAME OPEN-INCLUDE ;                                                                                                                                   \   PREPROCESSOR:              19APR94PZ                                          э VARIABLE MINUS                                                                  э : CPP-NUMBER? ( -- N FALSE/ -- TRUE )       SKIPBLANKS                               CHAR> NUM? 0= ?DUP ?EXIT                 NUMBER DROP  FALSE ;                                                         э : DEFINE ( -- )                             CHECK-EOL                                CHAR> ALPHA? 0= ?CPP-ERROREXIT           GET-ID                                   ID-BUF KEYWORD?                             иф DROP *PREPROCESSOR* ERROR             CLEARLINE  EXIT тхен                  CHAR> BL - ?CPP-ERROREXIT                CHECK-EOL                                1  CHAR> ASCII - =                          иф NEGATE +CHAR тхен MINUS !          CPP-NUMBER? ?CPP-ERROREXIT               MINUS @ *                                DUP $FF00 AND 0<> 1 AND                  ID-BUF PUTGLOBAL 2!  CLEARLINE ;                                            \   PREPROCESSOR:              19APR94PZ                                          э CREATE CPP-WORD 17 ALLOT                                                        э : CPP-NEXTWORD  ( -- ADR )                  SKIPBLANKS                               CPP-WORD 1+ 16 BOUNDS до                 CHAR> 0= CHAR> BL = OR                      иф и CPP-WORD - 1- CPP-WORD C!           CPP-WORD унлооп EXIT тхен             CHAR> и C! +CHAR лооп                    бегин CHAR> 0= CHAR> BL = OR 0=          вхиле +CHAR репеат                       16 CPP-WORD C!  CPP-WORD ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \   PREPROCESSOR:              07MAY95PZ                                          э : PRAGMA  ( -- )                            CPP-NEXTWORD " CC64" STRCMP                        0= ?CPP-ERROREXIT              CPP-NUMBER? ?CPP-FATAL   >BASE !         CPP-NUMBER? ?CPP-FATAL   >ZP   !         CPP-NUMBER? ?CPP-FATAL                   LIB.FIRST !                              CPP-NUMBER? ?CPP-FATAL                   >RUNTIME !                               CPP-NUMBER? ?CPP-FATAL                   DUP CODE.FIRST !        *=               CPP-NUMBER? ?CPP-FATAL                   DUP STATICS.LIBFIRST !  >STATICADR       CPP-NUMBER? ?CPP-FATAL                   STATICS.LAST !                           CPP-NEXTWORD DUP C@ 0= ?CPP-FATAL        DUP LIB.CODENAME STRCPY                      LIB.INITNAME STRCPY                  CODE.SUFFIX LIB.CODENAME STRCAT          INIT.SUFFIX LIB.INITNAME STRCAT          CODELAYOUT.OK   CLEARLINE ;                                                                                          \   PREPROCESSOR:              07MAY95PZ                                          э STRINGTAB CPP-KEYWORDS                                                          э X #DEFINE    X" DEFINE"                э X #INCLUDE   X" INCLUDE"               э X #PRAGMA    X" PRAGMA"                                                         ENDTAB                                                                            э CREATE CPP-COMMANDS                     ' DEFINE ,  ' INCLUDE ,  ' PRAGMA ,                                                                                       MAKE PREPROCESS ( -- )                      $PENDING @                                  иф *PREPROCESS-IN-STRING* ERROR          CLEARLINE  EXIT тхен                  COMMENT-STATE @ ?EXIT                    CHAR> ASCII # - ?EXIT  +CHAR             CPP-NEXTWORD CPP-KEYWORDS SCANWORD          иф 2* CPP-COMMANDS + PERFORM             EXIT тхен                             CPP-ERROR ;                                                                                                  02MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ FILE-I/O                     20SEP94PZ                                            .( MODULE FILE-I/O ) CR                                                           1 4 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \   FILE-I/O                   21SEP94PZ                                          ч : FHANDLE  CREATE 6 ALLOT ;                                                     ч : SET-FHANDLE  ( DEV 2ND HANDLE -- )        DUP OFF  2+ 2! ;                                                             э VARIABLE >HANDLE                       э : HANDLE  >HANDLE @ ;                  ч -1 CONSTANT #EOF                                                                ч : FEOF?  ( HANDLE -- FLAG ) @ ;                                                                                          \\                                                                                ч VARIABLE FDELAY  10 FDELAY !                                                    э : FWAIT  ( -- )                             FDELAY @ 0 ?до                           $00A1 @ бегин DUP $00A1 @ - унтил        DROP лооп ;                                                                                                                                                   \   FILE-I/O                   21SEP94PZ                                          э : FOPEN  ( MODE TYPE NAME HANDLE -- )       DUP OFF                                  2+ 2@ BUSOPEN  COUNT BUSTYPE             ASCII , BUS!  BUS!                       ASCII , BUS!  BUS!  BUSOFF ;                                                 э : FCLOSE  ( HANDLE -- )                     2+ 2@ BUSCLOSE ;                                                             э : FSETIN  ( HANDLE -- )                     DUP >HANDLE ! 2+ 2@ BUSIN ;                                                  э : FSETOUT  ( HANDLE -- )                    DUP >HANDLE ! 2+ 2@ BUSOUT ;                                                 э ' BUSOFF алиас FUNSET  ( -- )                                                                                                                                                                                                                                                                                                        \   FILE-I/O                   13SEP94PZ                                          э : FGETC  ( -- C )                           HANDLE @ иф #EOF елсе BUS@                      I/O-STATUS? HANDLE ! тхен ;                                           э : FGETS  ( ADR N -- N' )                    HANDLE @ иф 2DROP 0 EXIT тхен            0 -ROT BOUNDS  ?до BUS@ и C! 1+          I/O-STATUS? иф леаже тхен  лооп          I/O-STATUS? HANDLE ! ;                                                       э : FGET2DELIM ( ADR N DELIM -- N' F )        HANDLE @ иф 2DROP DROP 0. EXIT тхен      -ROT 0 -ROT BOUNDS                       до 1-  OVER BUS@ UNDER =                    иф DROP NEGATE леаже тхен             и C!   I/O-STATUS?                          иф NEGATE леаже тхен  лооп            DUP 0<                                      иф бегин 1- OVER BUS@ - вхиле            I/O-STATUS? унтил NEGATE NIP -1          елсе NIP 0 тхен                       I/O-STATUS? HANDLE ! ;                                                      \   FILE-I/O                   11SEP94PZ                                          э : FSKIP  ( N -- )                           HANDLE @ иф DROP EXIT тхен               0 ?до BUS@ DROP I/O-STATUS?                 иф леаже тхен   лооп                  I/O-STATUS? HANDLE ! ;                                                                                                                                         э ' BUS! алиас FPUTC  ( C -- )                                                    э ' BUSTYPE алиас FPUTS  ( ADR N -- )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \   FILE-I/O                   21SEP94PZ                                          ч : FCMD  ( HANDLE STRING -- )                2+ 2+ @ 15 BUSOUT                        COUNT BUSTYPE BUSOFF ;                                                       ч : FERROR?  ( HANDLE -- ) DROP ;                                                 ч : FRESET  ( HANDLE -- )                     " UJ" SWAP FCMD ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \ TRANSIENT аSSEMBLER         C09MAY94PZ                                          \NEEDS CODE  1 +LOAD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \ фORTH-6502 аSSEMBLER         20SEP94PZ \ бASIS: фORTH дIMENSIONS жол иии нO. 5)                                           .( TRANSIENT FORTH ASSEMBLER) CR                                                                                          HERE   $800 HALLOT  HEAP DP !                                                     оNLYFORTH  аSSEMBLER ALSO DEFINITIONS             1 7 +THRU                                                                \ : .BLK  ( -) BLK @ ?DUP                \    иф  ."  бLK " U. ?CR  тхен ;        \ ' .BLK иS .STATUS                                                               : RR ." ERROR IN SCR " SCR @ .                ."  AT POSITION " R# @ . CR ;                                                DP !                                                                              оNLYFORTH                                                                                                                                                                                                   \ фORTH-83 6502-аSSEMBLER      20OCT87RE                                          : END-CODE   CONTEXT 2- @  CONTEXT ! ;                                            цREATE INDEX                             $0909 , $1505 , $0115 , $8011 ,          $8009 , $1д0д , $8019 , $8080 ,          $0080 , $1404 , $8014 , $8080 ,          $8080 , $1ц0ц , $801ц , $2ц80 ,                                                   э жARIABLE MODE                                                                   : мODE:  ( N -)   цREATE C,                дOES>  ( -)     C@ MODE ! ;                                                     0   мODE: .а        1    мODE: #         2 э мODE: MEM       3    мODE: ,ь        4   мODE: ,ы        5    мODE: ь)        6   мODE: )ы       $ф    мODE: )                                                                                                                                                                                                                                                              \ UPMODE  CPU                  20OCT87RE                                          э : UPMODE ( ADDR0 F0 - ADDR1 F1)         иф MODE @  8 OR MODE !   тхен            1 MODE @  $ф AND ?DUP иф                 0 до  DUP +  лооп тхен                   OVER 1+ @ AND 0= ;                                                               : CPU  ( 8B -)   цREATE  C,                дOES>  ( -)    C@ C, MEM ;                                                       00 CPU BRK $18 CPU CLC $д8 CPU CLD      $58 CPU CLI $б8 CPU CLV $ца CPU DEX      $88 CPU DEY $е8 CPU INX $ц8 CPU INY      $еа CPU NOP $48 CPU PHA $08 CPU PHP      $68 CPU PLA $28 CPU PLP $40 CPU RTI      $60 CPU RTS $38 CPU SEC $ф8 CPU SED      $78 CPU SEI $аа CPU TAX $а8 CPU TAY      $ба CPU TSX $8а CPU TXA $9а CPU TXS      $98 CPU TYA                                                                                                                                                                                                                                          \ M/CPU                        20OCT87RE                                          : M/CPU  ( MODE OPCODE -)  цREATE C, ,    дOES>                                    DUP 1+ @ $80 AND иф $10 MODE +! тхен     OVER $фф00 AND UPMODE UPMODE             иф MEM TRUE аBORT" INVALID" тхен         C@ MODE @ INDEX + C@ + C, MODE @ 7 AND   иф MODE @  $ф AND 7 <                     иф C, елсе , тхен тхен MEM ;                                                    $1ц6е $60 M/CPU ADC $1ц6е $20 M/CPU AND  $1ц6е $ц0 M/CPU CMP $1ц6е $40 M/CPU EOR  $1ц6е $а0 M/CPU LDA $1ц6е $00 M/CPU ORA  $1ц6е $е0 M/CPU SBC $1ц6ц $80 M/CPU STA  $0д0д $01 M/CPU ASL $0ц0ц $ц1 M/CPU DEC  $0ц0ц $е1 M/CPU INC $0д0д $41 M/CPU LSR  $0д0д $21 M/CPU ROL $0д0д $61 M/CPU ROR  $0414 $81 M/CPU STX $0486 $е0 M/CPU CPX  $0486 $ц0 M/CPU CPY $1496 $а2 M/CPU LDX  $0ц8е $а0 M/CPU LDY $048ц $80 M/CPU STY  $0480 $14 M/CPU JSR $8480 $40 M/CPU JMP  $0484 $20 M/CPU BIT                                                                                                       \ аSSEMBLER CONDITIONALS       20OCT87RE                                          э : RANGE?   ( BRANCH -- BRANCH )         DUP ABS  $7ф U> аBORT" OUT OF RANGE " ;                                          : [[  ( бегин)  HERE ;                                                            : ?]  ( унтил)  C, HERE 1+ - RANGE? C, ;                                          : ?[  ( иф)     C,  HERE 0 C, ;                                                   : ?[[ ( вхиле)  ?[ SWAP ;                                                         : ]?  ( тхен)   HERE OVER C@  иф SWAP !   елсе OVER 1+ - RANGE? SWAP C! тхен ;                                             : ][  ( елсе)   HERE 1+   1 JMP           SWAP HERE OVER 1+ - RANGE?  SWAP C! ;                                            : ]]  ( агаин)  JMP ;                                                             : ]]? ( репеат) JMP ]? ;                                                                                                                                           \ аSSEMBLER CONDITIONALS       20OCT87RE                                          $90 цONSTANT цс     $б0 цONSTANT цц      $д0 цONSTANT 0=     $ф0 цONSTANT 0<>     $10 цONSTANT 0<     $30 цONSTANT 0>=     $50 цONSTANT жс     $70 цONSTANT жц                                               : NOT    $20 [ фORTH ] XOR ;                                                      : BEQ    0<> ?] ;   : BMI   0>= ?] ;     : BNE    0=  ?] ;   : BPL   0<  ?] ;     : BCC    цс  ?] ;   : BVC   жс  ?] ;     : BCS    цц  ?] ;   : BVS   жц  ?] ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ 2INC/2DEC   WINC/WDEC        20OCT87RE                                          : 2INC  ( ADR -- )                        DUP LDA  CLC  2 # ADC                    DUP STA  цс ?[  SWAP 1+ INC  ]?  ;                                               : 2DEC  ( ADR -- )                        DUP LDA  SEC  2 # SBC                    DUP STA  цц ?[  SWAP 1+ DEC  ]?  ;                                               : WINC  ( ADR -- )                        DUP INC  0= ?[  SWAP 1+ INC  ]?  ;                                               : WDEC  ( ADR -- )                        DUP LDA  0= ?[  OVER 1+ DEC  ]?  DEC  ;                                          : ;C:                                     RECOVER JSR  END-CODE ]  0 LAST !  0 ;                                                                                                                                                                                                                                                                                                \ ;CODE цODE CODE>          BP/RE03FEB85                                          оNLYFORTH                                                                         : аSSEMBLER                               аSSEMBLER   [ аSSEMBLER ] MEM ;                                                  : ;цODE                                   [COMPILE] дOES>  -3 ALLOT                [COMPILE] ;      -2 ALLOT   аSSEMBLER ; IMMEDIATE                                                                         : цODE  цREATE HERE DUP 2- ! аSSEMBLER ;                                          : >LABEL  ( ADR -)                        HERE э цREATE  IMMEDIATE  SWAP ,         4 HALLOT HEAP 1 AND HALLOT ( 6502-ALIG)  HERE 4 - HEAP  4  CMOVE                  HEAP LAST @ COUNT $1ф AND + !  DP !       дOES>  ( - ADR)   @                      STATE @ иф  [COMPILE] лITERAL  тхен ;                                           : лABEL                                   [ аSSEMBLER ]  HERE >LABEL аSSEMBLER ;                                          \ 2! 2@ 2VARIABLE 2CONSTANT CLV12MAY94PZ                                          ч цODE 2!  ( D ADR --)                    TYA  SETUP JSR  3 # LDY                  [[  сп )ы LDA  н )ы STA  DEY  0< ?]      1 # LDY  пOPTWO JMP  END-CODE                                                    ч цODE 2@  ( ADR -- D)                    сп ь) LDA  н STA  сп )ы LDA  н 1+ STA    сп 2DEC  3 # LDY                         [[  н )ы LDA  сп )ы STA  DEY  0< ?]      XYнEXT JMP  END-CODE                                                             ч : 2жARIABLE  ( --)   цREATE 4 ALLOT ;               ( -- ADR)                                                            ч : 2цONSTANT  ( D --)   цREATE , ,        дOES> ( -- D)   2@ ;                                                                                                                                                                                                                                                                                                                 \ SAVESYSTEM                   12APR20PZ                                          \NEEDS SAVESYSTEM (                      \\ )                                                                                DEFER SAVESYSDEV                         : DEV8 8 ;  ' DEV8 ис SAVESYSDEV                                                                                         э : (SAVSYS ( ADR LEN -- )                [ аSSEMBLER ] нEXT  [ фORTH ]            ['] PAUSE  DUP PUSH  !  \ SINGLETASK     I/O PUSH  I/O OFF  BUSTYPE ;                                                       : SAVESYSTEM   \ NAME MUSS FOLGEN       SAVE  SAVESYSDEV 2 BUSOPEN               0 PARSE BUSTYPE                          " ,P,W" COUNT BUSTYPE  BUSOFF            SAVESYSDEV 2 BUSOUT  ORIGIN $17 -        DUP  $100 U/MOD  SWAP BUS! BUS!          HERE OVER - (SAVSYS  BUSOFF              SAVESYSDEV 2 BUSCLOSE                    0 (DRV ! DERROR? ABORT" SAVE-ERROR" ;                                                                                    \ TEST *COMPILER* ERROR        04SEP94PZ                                            : TEST-ERR                                  *COMPILER* FATAL                    ;                                          : TEST-ERR2                                 *COMPILER* ?FATAL ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ INCLUDE LOADSCREEN           02SEP19PZ                                            : MARK ;                                                                          1 3 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \   FLOAD-DEV FREADLINE        19AUG19PZ                                            CREATE FLOAD-DEV  8 ,                    CREATE FLOAD-2ND  1 ,                  э 132 CONSTANT /FIB                        CREATE FIB /FIB ALLOT                    VARIABLE #FIB                                                                   э : EOL? ( C -- F )                         DUP 0= SWAP #CR = OR иф 0 EXIT тхен      I/O-STATUS? иф 1 EXIT тхен  -1 ;                                               э : FREADLINE ( -- EOF )                  FLOAD-DEV @ FLOAD-2ND @ BUSIN            FIB /FIB BOUNDS                          до BUS@ DUP EOL? UNDER                       иф и C! елсе DROP тхен               DUP 0<                                     иф DROP елсе и + FIB - #FIB ! унлооп     I/O-STATUS? BUSOFF EXIT тхен           лооп /FIB #FIB !                         ." WARNING: LINE EXCEEDS MAX " /FIB .    CR ." EXTRA CHARS IGNORED" CR            бегин BUS@ EOL? 1+ унтил                 I/O-STATUS? BUSOFF ;                   \   FLOAD-OPEN  FLOAD-CLOSE    19AUG19PZ                                          э : FLOAD-OPEN ( ADDR C -- )              FLOAD-DEV @                              FLOAD-2ND @ 1+ DUP FLOAD-2ND !           BUSOPEN                                  2DUP CR TYPE BUSTYPE                     " ,S,R" COUNT BUSTYPE BUSOFF ;                                                   э : FLOAD-CLOSE ( -- )                    FLOAD-DEV @ FLOAD-2ND @                  DUP 1- FLOAD-2ND !                       BUSCLOSE ;                                                                         : FACTIVE? ( -- FLAG )                  FLOAD-2ND @ 1 > ;                                                                  : FLOAD-CLOSE-ALL ( -- )                FACTIVE? иф 2 FLOAD-2ND @ до               FLOAD-DEV @ и BUSCLOSE  -1 +лооп       1 FLOAD-2ND ! тхен ;                                                               : \ ( -- )                              BLK @ иф [COMPILE] \ EXIT тхен           #TIB @ >IN ! ; IMMEDIATE               \   INCLUDE                    02SEP19PZ                                           CREATE >TIB-ORIG >TIB @ ,                                                          : (INCLUDE-ERROR ( -- )                 FLOAD-CLOSE-ALL                          >TIB-ORIG @ >TIB ! #TIB OFF              ['] (ERROR ERRORHANDLER !                (ERROR ;                                                                           : INTERPRET-VIA-FIB                     бегин FREADLINE >R  >IN OFF              #FIB @ #TIB !  INTERPRET  R> унтил ;                                               : INCLUDE ( -- )                        BLK @ аBORT" NO INCLUDE FROM BLK"        ['] (INCLUDE-ERROR ERRORHANDLER !        BL PARSE  FLOAD-OPEN                     FIB >TIB !                                 INTERPRET-VIA-FIB                      FLOAD-CLOSE                              FACTIVE? 0= иф >TIB-ORIG @ >TIB ! тхен   #TIB OFF >IN OFF ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ TESTCODEOUTPUT 2             26MAY91PZ                                          MAKE FLUSHSTATIC ( -- )                     BASE PUSH HEX ." STATICS: "              STATIC> @ STATIC[                        ?до ?CR и C@ . лооп ." ;END" CR          STATIC[ STATIC> @ - STATIC-OFFSET +!     CLEARSTATIC ;                                                                                                           э : TABELLE  ( +N -- )                    цREATE     0 до                          BL WORD NUMBER DROP , лооп               дOES> ( 8B1 -- 8B2 +N )                  + COUNT SWAP C@ ;                                                                -->                                                                                                                                                                                                                                                                                                                                                                             \ DIS SHORTCODE0               20OCT87RE                                          BASE @  HEX                                                                       $80 э TABELLE SHORTCODE0                 0б10 0000 0000 0341 2510 0320 0000 0332  0ац1 0000 0000 03а1 0е10 0000 0000 0362  1д32 0000 0741 2841 2710 2820 0732 2832  08ц1 0000 0000 28а1 2д10 0000 0000 2862  2а10 0000 0000 2141 2410 2120 1ц32 2132  0цц1 0000 0000 21а1 1010 0000 0000 2162  2б10 0000 0000 2941 2610 2920 1цд2 2932  0дц1 0000 0000 29а1 2ф10 0000 0000 2962  0000 0000 3241 3141 1710 3610 3232 3132  04ц1 0000 32а1 31б1 3810 3710 0000 0000  2051 1ф51 2041 1ф41 3410 3310 2032 1ф32  05ц1 0000 20а1 1фб1 1110 3510 2062 1ф72  1451 0000 1441 1541 1б10 1610 1432 1532  09ц1 0000 0000 15а1 0ф10 0000 0000 1562  1351 0000 1341 1941 1а10 2210 1332 1932  06ц1 0000 0000 19а1 2е10 0000 0000 1962                                           BASE !                                                                            -->                                     \ DIS SCODE ADRMODE            20OCT87RE                                          э цREATE SCODE                            $23 C, $02 C, $18 C, $01 C,              $30 C, $1E C, $12 C, $2C C,                                                      э цREATE ADRMODE                          $81 C, $41 C, $51 C, $32 C,              $91 C, $A1 C, $72 C, $62 C,                                                      э : SHORTCODE1 ( 8B1 - 8B2 +N)            2/ DUP 1 AND                             иф  0= 0  EXIT  тхен                     2/ DUP $7 AND ADRMODE + C@               SWAP 2/ 2/ 2/ $7 AND SCODE + C@ ;                                                э жARIABLE MODE                                                                   э жARIABLE LENGTH                                                                 -->                                                                                                                                                                                                         \ DIS SHORTCODE TEXTTAB        06MAR86RE                                          э : SHORTCODE ( 8B1 -- +N )               DUP 1 AND         ( UNGERADE CODES)      иф  DUP $89 =                             иф  DROP 2  тхен  SHORTCODE1            елсе  SHORTCODE0  ( GERADE CODES)        тхен                                     SWAP DUP 3 AND LENGTH !                  2/ 2/ 2/ 2/ MODE ! ;                                                             э : TEXTTAB   ( CHAR +N 8B -- )           цREATE                                   DUP C, SWAP 0 до >R DUP WORD             1+ HERE R@ CMOVE R@ ALLOT R>             лооп 2DROP                               дOES>  ( +N -- )                         COUNT >R SWAP R@ * + R> TYPE ;                                                   -->                                                                                                                                                                                                                                                  \ DIS TEXT-TABELLEN            06MAR86RE                                          BL $39 3 э TEXTTAB .MNEMONIC             *BY ADC AND ASL BCC BCS BEQ BIT BMI BNE  BPL BRK BVC BVS CLC CLD CLI CLV CMP CPX  CPY DEC DEX DEY EOR INC INX INY JMP JSR  LDA LDX LDY LSR NOP ORA PHA PHP PLA PLP  ROL ROR RTI RTS SBC SEC SED SEI STA STX  STY TAX TAY TSX TXA TXS TYA              ( +N -- )                                                                         аSCII / $е 1 э TEXTTAB .VOR                 / /A/ /Z/#/ / /(/(/Z/Z/ /(/                                                                                             аSCII / $е 3 э TEXTTAB .NACH                  /   /   /   /   /   /,X              /,Y /,X)/),Y/,X /,Y /   /)  /                                                    -->                                                                                                                                                                                                                                                  \ DIS 2U.R 4U.R                26MAY91PZ                                          э : 4U.R ( U -)                               0 <# # # # # #> TYPE ;                                                       э : 2U.R ( U -)                               0 <# # # #> TYPE ;                                                                                                    э : B@   >CODEADR C@ ;                   э : W@   >CODEADR  @ ;                                                                                                     -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ FLUSHCODE                    27MAY91PZ                                          MAKE FLUSHCODE     BASE PUSH HEX          CODE[ CODEOFFSET @ +                    бегин DUP PC U< вхиле                     CR DUP 4U.R SPACE DUP B@ DUP 2U.R SPACE  SHORTCODE >R LENGTH @ DUP                иф OVER 1+ B@ 2U.R SPACE тхен DUP 2 =    иф OVER 2+ B@ 2U.R SPACE тхен            2 SWAP - 3 * SPACES                      R> .MNEMONIC SPACE 1+                    MODE @ DUP .VOR $ц =                     иф DUP B@ DUP $80 AND иф $100 - тхен      OVER + 1+ 4U.R                          елсе LENGTH @ DUP 2 SWAP - 2* SPACES      ?DUP                                     иф 2 =                                    иф   DUP W@ 4U.R                         елсе DUP B@ 2U.R                       тхен тхен тхен MODE @ .NACH LENGTH @ +  репеат DROP CLEARCODE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ дир: TEST                    26MAY91PZ                                          ..              -&149                    CODEOUTPUT2       -&9                    INPUT              &1                    :SYMTAB            &3                    ERRORHANDLER       &4                    ASSEMBLER          &5                    CODEOUTPUT1       &13                    SAVESTACK         &15                    DUMPSYMTAB        &17                    :SAVESTACK        &18                    :DO$              &19                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ TESTINPUT                    26FEB91PZ                                          э VARIABLE SRC э VARIABLE LPT            э VARIABLE INPTR                         ч VARIABLE COMMENT-STATE                 ч VARIABLE COMMENT-LINE                  ч VARIABLE LINE                          э VARIABLE EOF                           ч -1 CONSTANT #EOF                                                                э : RES-INPTR  LINEBUF INPTR ! ;                                                    : CHAR>  ( -- C )  INPTR @ C@               ?DUP 0= иф EOF @ тхен ;               : +CHAR  ( -- )  1 INPTR +! ;                                                     -->                                                                                                                                                                                                                                                                                                                                                                           \   TESTINPUT                  13MAR91PZ                                            : NEWLINE ( -- )                           1 LINE +!                                LPT @ DUP 1023 >                            иф DROP LINEBUF OFF  #EOF EOF !          елсе SRC @ BLOCK +                       LINEBUF 40 CMOVE                         LINEBUF 40 -TRAILING                     2DUP CR ." SRC> " TYPE CR                + 0 SWAP C!                              41 LPT +! тхен                        RES-INPTR ;                                                                     : OPENBLK ( BLK -- )                       LINE OFF  COMMENT-STATE OFF EOF OFF      SRC ! 41 LPT !                           LINEBUF OFF  RES-INPTR ;                                                        : :INPUT  4 OPENBLK ;                      INIT: :INPUT                                                                                                                                                                                            \ SYMTABTESTER                 26SEP90PZ                                            : LOCAL ( OBJ -- )                          BL WORD PUTLOCAL 2! ;                                                          : GLOBAL ( OBJ -- )                         BL WORD PUTGLOBAL 2! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ TESTERRORHANDLER             08MAR91PZ                                          ч : ERROR ( ERRNUM -- )                       ERRORMESSAGE SWAP STRING[]               CR >STRING COUNT TYPE  CR ;                                                  ч : ?ERROR ( FLAG ERRNUM -- )                SWAP иф ERROR елсе DROP тхен ;                                                                                                                                  ч : FATAL ( ERRNUM -- )                     ERROR  TRUE ABORT" FATAL ERROR" ;                                              ч : ?FATAL ( FLAG ERRNUM -- )               SWAP иф FATAL елсе DROP тхен ;                                                                                                                                                                                                                                                                                                                                                                                        \ TESTASSEMBLER LOADSCREEN     27MAY91PZ                                            1 6 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \ TESTASSEMBLER: ALLGEMEINES   27MAY91PZ                                            : .LDA# ( N )  ." LDA #" U. CR ;         : .PHA         ." PHA"      CR ;         : .PHA'        ." PHA'"     CR ;         : .PLA         ." PLA"      CR ;                                                  : .WORD ( N )  ." .WORD " U. CR ;        : .BYTE ( C )  DUP U. 0= иф CR тхен                                  ?CR ;        : .JSR  ( N )  ." JSR  " U. CR ;         : .JSR(ZP)     ." JSR (ZP)" CR ;         : .RTS         ." RTS"      CR ;         : .ARGS        U. ." ARGUMENTS" CR ;     : .LINK# ( N ) ." LINK# " . CR ;         : .LDA-BASE    ." LDA $BASE" CR ;        : .POP-ZP      ." POP $ZP" CR ;          : .LDA-ZP      ." LDA $ZP" CR ;          : .STA-ZP      ." STA $ZP" CR ;                                                   : .SHLA        ." SHLA"     CR ;         : .SHRA        ." SHRA"     CR ;         : .AND#255 ( ) ." AND#255" CR ;          : .SWITCH      ." JSR $SWITCH" CR ;                                            \   TESTASSEMBLER: 'SIZED'     27MAY91PZ                                            : .SIZE ( N )  ." SIZE: " . CR ;                                                  : .LDA#.S ( N ) ." LDA.S #" U. CR ;                                               : .LDA.S  ( N )  ." LDA.S  " U. CR ;     : .LDA.S(ZP)     ." LDA.S (ZP)" CR ;     : .LDA.S(BASE),# ( OFFS )                   ." LDA.S (BASE),#" U.  CR ;                                                    : .STA.S  ( N )  ." STA.S  " U. CR ;     : .STA.S(ZP)     ." STA.S (ZP)" CR ;     : .STA.S(BASE),# ( OFFS )                   ." STA.S (BASE),#" U.  CR ;                                                                                             : .INCR.S ( N )  ." INCR.S " U.  CR ;    : .2INCR.S ( N ) ." 2INCR.S " U. CR ;    : .DECR.S ( N )  ." DECR.S " U.  CR ;    : .2DECR.S ( N ) ." 2DECR.S " U. CR ;                                                                                                                                                                     \   TESTASSEMBLER: ARITHMETICS 13MAR91PZ \ ARITHMETIK AUF DEM STAPEL                                                         : .NOT   ." NOT A"    CR ;               : .NEG   ." NEG A"    CR ;               : .INV   ." INV A"    CR ;                                                        : .MULT  ." MULT"      CR ;              : .MULT# ." MULT# " U. CR ;              : .DIV   ." DIV"       CR ;              : .DIV#  ." DIV# " U.  CR ;              : .#DIV  ." #DIV " U.  CR ;              : .MOD   ." MOD"       CR ;              : .MOD#  ." MOD# " U.  CR ;              : .#MOD  ." #MOD " U.  CR ;                                                       : .ADD   ." ADD"       CR ;              : .ADD#  ." ADD# " U.  CR ;              : .SUB   ." SUB"       CR ;              : .SUB#  ." SUB# " U.  CR ;              : .#SUB  ." #SUB " U.  CR ;                                                                                                                                                                               \   TESTASSEMBLER: ARITHMETICS 13MAR91PZ                                            : .SHL   ." SHL"      CR ;               : .SHL#  ." SHL# " U. CR ;               : .#SHL  ." #SHL " U. CR ;               : .SHR   ." SHR"      CR ;               : .SHR#  ." SHR# " U. CR ;               : .#SHR  ." #SHR " U. CR ;                                                        : .LT    ." LT"       CR ;               : .LT#   ." LT# " U.  CR ;               : .LE    ." LE"       CR ;               : .LE#   ." LE# " U.  CR ;               : .GT    ." GT"       CR ;               : .GT#   ." GT# " U.  CR ;               : .GE    ." GE"       CR ;               : .GE#   ." GE# " U.  CR ;               : .EQ    ." EQ"       CR ;               : .EQ#   ." EQ# " U.  CR ;               : .NE    ." NE"       CR ;               : .NE#   ." NE# " U.  CR ;                                                                                                                                                                                \   TESTASSEMBLER: ARITHMETICS 27MAY91PZ                                            : .AND   ." AND"      CR ;               : .AND#  ." AND# " U. CR ;               : .XOR   ." XOR"      CR ;               : .XOR#  ." XOR# " U. CR ;               : .OR    ." OR"       CR ;               : .OR#   ." OR# " U.  CR ;                                                      \\ 'UNSIZED' IN/DECREMENTS                                                          : .INCR ( N )  ." INCR " U.  CR ;        : .2INCR ( N ) ." 2INCR " U. CR ;        : .DECR ( N )  ." DECR " U.  CR ;        : .2DECR ( N ) ." 2DECR " U. CR ;                                                                                                                                                                                                                                                                                                                                                                                                                               \   TESTASSEMBLER:JUMPS/LABELS 03MAR94PZ                                          \ VARIABLE >PC                           \ : PC >PC @ ;                           э : +PC   1 >PC +! ;                                                                : .JMP       ( ADR -- )                     ." JMP " U. CR ;                      : .LABEL      ( -- ADR )                    PC DUP ." *LABEL*: " U. +PC CR ;    \ LABEL 0 IST VERBOTEN WG. FOR & SWITCH    : .JMP-AHEAD ( -- ADR )                     ." JMP AHEAD " PC DUP U. +PC CR ;     : .RESOLVE-JMP ( ADR -- )                   ." PATCH " U. CR ;                                                           э : .BEQ    ." CMP #0: BEQ *+5 :" ;      э : .BNE    ." CMP #0: BNE *+5 :" ;                                                 : .JMZ        .BNE  .JMP ;               : .JMN        .BEQ  .JMP ;                                                        : .JMZ-AHEAD  .BNE  .JMP-AHEAD ;         : .JMN-AHEAD  .BEQ  .JMP-AHEAD ;                                                                              27MAY91PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ TESTCODEOUTPUT 1             25MAY91PZ                                          MAKE FLUSHSTATIC ( -- )                     BASE PUSH HEX ." STATICS: "              STATIC> @ STATIC[                        ?до ?CR и C@ . лооп ." ;END" CR          STATIC[ STATIC> @ - STATIC-OFFSET +!     CLEARSTATIC ;                                                                  MAKE FLUSHCODE ( -- )                        ." ------ CODE FLUSHED ------" CR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              26MAY91PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ TESTSAVESTACK                26FEB91PZ                                          ч : +SAVESTACK  ?STACK ;                                                          ч : ?SAVESTACK  ?STACK ;                                                          ч : ?LOADSTACK         ;                                                          ч : -SAVESTACK         ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ TESTSTORESTRING              23FEB91PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ DUMPSYMTAB                   08MAR91PZ                                            : DUMPGLOBALS                               ]HASH HASH[ до и @ ?DUP                    иф DUP COUNT CR TYPE BL EMIT             COUNT + 2@ U. U.                         елсе CR ." ----" тхен                  2 +лооп ;                                                                      : DUMPLOCALS                                ]SYMTAB LOCALS> @ до  CR                   и C@ /NAME >                                иф ." *** MARKE: " и C@ .  1             елсе и COUNT TYPE BL EMIT                и COUNT + 2@ U. U.                       и C@ 5 + тхен                         +лооп ;                                                                                                                                                                                                                                                                                                                                                                  \ TESTSAVESTACK                18FEB91PZ                                            : FILLSTACK                                до и ?SAVESTACK лооп ;                                                                                                   : READSTACK                                до ?LOADSTACK                            и - иф ." ERROR" UNLOOP EXIT тхен        -1 +лооп ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \ TEST:DO$:                    13MAR91PZ                                          э : TEST$[ ( -- )                             CR ." STRING: " ;                                                            э : TEST$, ( C -- )                           ?CR  BASE PUSH HEX . ;                                                       э : TEST]$ ( -- ADR )                         CR $801 ;                                                                    ч DO$: TEST$  ( -- ADR )                         TEST$[ TEST$, TEST]$ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      KKKK