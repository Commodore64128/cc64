\ SIMPLE FORTH TEXTFILE EDITOR 10SEP94PZ                                                                                   TESTLOAD         3                       PEDDI4CC64       4                       STANDALONE       5                       TEST3            6                       WHICHKEY         7                       LOGO             8                       SHELL            9                       FRAME          &12                       EDIT           &18                                                                                                         TESTINCLUDE   &150                                                                                                                                                                                                                                                                                                                                                                                                                                                \ MEMORY SETTINGS FOR CC64     14SEP94PZ                                            SAVE                                     $CBD0 SET-HIMEM                          $C000 ' LIMIT >BODY !                    0 INK-POT !  15 INK-POT 2+ C!            1024 1024 SET-STACKS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ MEMORY SETTINGS STANDALONE   07MAY95PZ                                            SAVE                                                                            э : RELOCATE-TASKS  ( NEWуп -- )          UP@ DUP бегин  1+ UNDER @ 2DUP -         вхиле  ROT DROP  репеат  2DROP ! ;                                               э : RELOCATE  ( STACKLEN RSTACKLEN -- )   EMPTY  256 MAX 8192 MIN  SWAP            256 MAX 8192 MIN  PAD + 256 +            2DUP + 2+ LIMIT U>                       ABORT" STACKS BEYOND LIMIT"              UNDER  +   ORIGIN $а + !        \ R0     DUP RELOCATE-TASKS                       UP@ 1+ @   ORIGIN   1+ !        \ TASK         6 -  ORIGIN  8 + ! COLD ; \ S0                                               $CBD0 ' LIMIT >BODY !                    0 INK-POT !  15 INK-POT 2+ C!            256 256 RELOCATE                                                                                                                                                                                          \ PEDDI LOADSCREEN TEST        15SEP94PZ                                            : э ;                                                                             ONLYFORTH  DECIMAL                       VOCABULARY PEDDI                         VOCABULARY SHELL                         PEDDI ALSO DEFINITIONS                                                             CREATE DEV#  8 C,                       : DEV  DEV# C@ ;                                                                \ : TEXT[   R0 @ ;                       \ ' LIMIT алиас ]TEXT                    CREATE TEXT[ 4000 ALLOT                  HERE CONSTANT ]TEXT                        18 LOAD   \ EDITOR FUNCTIONS             12 LOAD   \ EDITOR FRAMEWORK           \\                                         SHELL ALSO DEFINITIONS                                                          ' ED алиас ED                                                                       8 10 THRU  \ SHELL & SAVESYSTEM                                                \ PEDDI LOADSCREEN FOR CC64    07MAY95PZ                                            ONLYFORTH  DECIMAL                     э VOCABULARY PEDDI                         COMPILER ALSO PEDDI ALSO DEFINITIONS                                            э ' LOMEM    ALIAS TEXT[                 э ' HIMEM    ALIAS ]TEXT                 э ' DEV      ALIAS DEV                                                              ONLYFORTH PEDDI ALSO DEFINITIONS                                                  18 LOAD   \ EDITOR FUNCTIONS             12 LOAD   \ EDITOR FRAMEWORK                                                      SHELL ALSO DEFINITIONS                                                          ' ED алиас ED                                                                        6 LOAD   \ COMBINED LOGO                                                          1 LOAD   \ SAVE & SET MEMORY                                                                                                                                    \ PEDDI LOADSCREEN STANDALONE  07MAY95PZ                                            ONLYFORTH  DECIMAL                     э VOCABULARY PEDDI                         VOCABULARY SHELL                         PEDDI ALSO DEFINITIONS                                                          э  CREATE DEV#  8 C,                     э : DEV  DEV# C@ ;                                                                э : TEXT[   R0 @ ;                       э ' LIMIT алиас ]TEXT                                                               18 LOAD   \ EDITOR FUNCTIONS             12 LOAD   \ EDITOR FRAMEWORK                                                      SHELL ALSO DEFINITIONS                                                          ' ED алиас ED                                                                     ' BYE алиас BYE                                                                     7 10 THRU  \ SHELL & SAVESYSTEM          2 LOAD     \ SET MEMORY                                                        \   COMBINED LOGO              14APR20PZ                                          э : .LOGO  ( -- )                           [ ' 'RESTART >BODY @ , ]                 ." PEDDI TEXT EDITOR ж0.3 PRESENT"       CR ;                                                                           ' .LOGO ис 'RESTART                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \   SHELL: COLD' LOGO          14APR20PZ                                          э CREATE CHARSET    HERE HERE 2- !          ALSO ASSEMBLER   HERE 6 +  $20 C, ,      XYнEXT $4C C, ,  $CBFA     $6C C, ,      TOSS                                                                           \NEEDS 2@  э : 2@  DUP 2+ @ SWAP @ ;                                              э : INIT-SHELL  ( -- )                        ONLY SHELL                               $CBFC 2@  $65021103. D=                     иф CHARSET тхен ;                                                         ' INIT-SHELL ис 'COLD                                                             э : .LOGO  ( -- )                             ."     RUNNING" CR                       ." PEDDI TEXT EDITOR ж0.3" CR            ." 1995 BY пHILIP зEMBROD" CR            $CBFC 2@  $65021103. D= NOT ?EXIT        ." ц CHARSET IN USE" CR ;                                                    ' .LOGO ис 'RESTART                                                              \   SHELL:                     03SEP94PZ                                          : DIR  ( -- )                               DEV 0 BUSOPEN  ASCII $ BUS! BUSOFF       DEV 0 BUSIN BUS@ BUS@ 2DROP              бегин CR BUS@ BUS@ 2DROP                 I/O-STATUS? 0= вхиле                     BUS@ BUS@ 256 * + U.                     бегин BUS@ ?DUP вхиле CON! репеат        репеат BUSOFF DEV 0 BUSCLOSE ;                                                 : DOS  ( -- )                               BL WORD COUNT ?DUP                          иф  DEV 15 BUSOUT  BUSTYPE               BUSOFF  CR елсе DROP тхен             DEV 15 BUSIN                             бегин BUS@ CON! I/O-STATUS? унтил        BUSOFF ;                                                                       : CAT    ( -- )  CR                         DEV 2 BUSOPEN  BL WORD COUNT BUSTYPE     BUSOFF  DEV 2 BUSIN  бегин BUS@ CON!     I/O-STATUS? унтил BUSOFF                 DEV 2 BUSCLOSE ;                                                              \   SHELL: COLD' LOGO          14APR20PZ                                            : DEVICE  ( N -- )                          DEV# C! ;                                                                      : DEVICE?  ( -- )                           ." ACTUAL DEVICE NUMBER IS "             DEV# C@ . ;                                                                    : HELP  ( -- )                              ." AVAILABLE COMMANDS:" CR WORDS ;                                           \\                                       э : INIT-SHELL  ( -- )                        ONLY SHELL ;                                                                 ' INIT-SHELL ис 'COLD                                                             э : .LOGO  ( -- )                             ."     RUNNING" CR                       ." PEDDI TEXT EDITOR ж0.3" CR            ." 1995 BY пHILIP зEMBROD" CR ;                                              ' .LOGO ис 'RESTART                                                              \ SAVESYSTEM                   07MAY95PZ                                          \NEEDS SAVESYSTEM (                      \\ )                                                                              э : (SAVSYS ( ADR LEN -- )                [ аSSEMBLER ] нEXT  [ фORTH ]            ['] PAUSE  DUP PUSH  !  \ SINGLETASK     I/O PUSH  I/O OFF  BUSTYPE ;                                                       : SAVEALL      \ NAME MUSS FOLGEN       SAVE  DEV 2 BUSOPEN  0 PARSE BUSTYPE     " ,P,W" COUNT BUSTYPE  BUSOFF            DEV 2 BUSOUT  ORIGIN $17 -               DUP  $100 U/MOD  SWAP BUS! BUS!          HERE OVER - (SAVSYS  BUSOFF              DEV 2 BUSCLOSE                           0 (DRV ! DERROR? ABORT" SAVE-ERROR" ;                                                                                                                                                                                                                                                                                                 \ ALLOCATE COMPILER            28AUG94PZ                                            ' LINEBUFFER ALIAS TEXT[                 ' HIMEM      ALIAS ]TEXT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \ CORE LOADSCREEN              14SEP94PZ                                          э : RESET  ( -- )                             $0287 @ $FC00 AND >R                     SCR> $3FF AND R@ OR                      [ ' SCR> >BODY ] LITERAL !               <SCR $3FF AND R@ OR                      [ ' <SCR >BODY ] LITERAL !               LAST-ROW> $3FF AND R> OR                 [ ' LAST-ROW> >BODY ] LITERAL !                                                   TEXT[ DUP 1ST-LINE> ! LINE> !            CHAR OFF  1.COLUMN OFF                   VIR-CHAR OFF                             #CR TEXT[ C!  #CR ]TEXT 1- C!            TEXT[ 1+ )TEXT !                         ]TEXT 1- TEXT( ! ;                                                                                                      1 3 +THRU                                                                                                                                                                                                                                          \   EDLOOP                     14SEP94PZ                                          \ 100 101 THRU                                                                    э : EDLOOP ( -- )                             CREATE  64 0 до ' , лооп                DOES> ( PFA -- )                          >R  END? OFF                             бегин KEY DUP $60 AND                       иф .CHAR                                 елсе DUP $1F AND 2* SWAP $80             AND 2/ + R@ + @ EXECUTE тхен     \    CHECK-MEM                                END? @ унтил RDROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \   EDLOOP                     15SEP94PZ                                          э EDLOOP EDIT-PAGE                                                                 .DEL-TO  .BOL     NOOP     QUIT-ED       .DEL-UNDER .EOL   NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     .SPLIT-LINE NOOP  NOOP          .DEL-LINE .DOWN   NOOP     .SCREEN       .DEL-LEFT NOOP    NOOP     SAVETEXT      EXIT-ED  NOOP     NOOP     NOOP          NOOP     .RIGHT   .DEL-FROM NOOP                                                  NOOP     NOOP     NOOP     NOOP          NOOP     .20UP    NOOP     NOOP          .20DOWN  NOOP     NOOP     NOOP          NOOP     .CR      NOOP     NOOP          NOOP     .UP      NOOP     .KILL-LINE    .INST-LINE NOOP   NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     .LEFT    NOOP     NOOP                                                   CR .( EDIT-PAGE OKAY ! ) CR                                                                                              \   ED                         14SEP94PZ                                          э : ED  ( -- )                                BL WORD FILENAME /FILENAME MOVE          FILENAME C@ /FILENAME 1- UMIN            FILENAME C!                              RESET LOADTEXT EDIT-PAGE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           2SEP94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       02SEP94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ VARIABLES & LOADSCREEN       14SEP94PZ                                          э 17 CONSTANT /FILENAME                                                           э  VARIABLE 1.COLUMN                     э  VARIABLE CHAR                         э  VARIABLE VIR-CHAR                     э  VARIABLE BLANKLINES                   э  CREATE FILENAME  /FILENAME ALLOT      э  VARIABLE CHANGED?                     э  VARIABLE END?                                                                  э VARIABLE 1ST-LINE>                     э VARIABLE LINE>                         э VARIABLE )TEXT                         э VARIABLE TEXT(                         э VARIABLE LAST-LINE>                                                             э : CHAR>  LINE> @ CHAR @ + ;                                                                                                1 26 +THRU                                                                                                                                                       \   DISPLAY                    02AUG94PZ                                          \NEEDS CODE ASCII @ WORD DROP                                                     лABEL (CBM>SCR                            н 8 + STA $7ф # AND $20 # CMP            цс ?[ $40 # CMP                             цс ?[ $1ф # AND  н 8 + BIT                  0< ?[ $40 # ORA  ]?  ]?  RTS  ]?   аSCII . # LDA  RTS                                                               э цODE CBM>SCR  ( 8B1 -- 8B2 )            сп ь) LDA  (CBM>SCR JSR  сп ь) STA       нEXT JMP  END-CODE                                                               \\ @                                                                              э CREATE CSTAB                              $80 C,  $00 C,  $40 C,  $20 C,           $C0 C,  $40 C,  $80 C,  $80 C,                                                 э : CBM>SCR  ( 8B1 -- 8B2 )                   DUP $FF = иф DROP $5E EXIT тхен          DUP $E0 AND 2/ 2/ 2/ 2/ 2/               CSTAB + C@ - $FF AND ;             \   DISPLAY                    02SEP94PZ                                          э : KEY ( -- C )                              бегин PAUSE C64KEY? унтил GETKEY ;                                           э 40   CONSTANT COL/SCR                  э 1024 CONSTANT SCR>                     э 1024 CONSTANT CHR/SCR                  э 2024 CONSTANT <SCR                     э 1984 CONSTANT LAST-ROW>                э ' SCR> алиас 1ST-ROW>                  э 25   CONSTANT ROWS/SCR                                                          э VARIABLE CSR.ROW>                      э VARIABLE CSR.COL                                                                э : COL/SCR*  2* 2* 2* DUP 2* 2* + ;     э : TH-ROW>  ( N -- ADR )                     COL/SCR* SCR> + ;                                                            э : CURSOR> ( -- ADR )                        CSR.ROW> @ CSR.COL @ + ;            э : FLIP  ( -- ) $80 CURSOR> CTOGGLE ;                                                                                    \   DISPLAY                    02SEP94PZ                                          э : (.LINE  ( LINE ROW -- )                   SWAP 1.COLUMN @ 0 ?до DUP C@ #CR =          иф DROP COL/SCR BL FILL                  унлооп EXIT тхен  1+ лооп             ( ROW LINE ) OVER COL/SCR BOUNDS         до ( ROW LINE ) DUP C@ DUP #CR =            иф 2DROP COL/SCR + и ?до                 BL и C! лооп унлооп EXIT тхен         CBM>SCR и C! 1+ лооп 2DROP ;                                                 э $D020 CONSTANT BORDER                  э : HALF  ( N - )                             BORDER C! PAUSE $80 0 до лооп ;                                              э : WARN-SIGNAL ( -- )                        BORDER PUSH  0 HALF  1 HALF                           0 HALF  1 HALF ;                                                                                                                                                                                                                                                            \   DISPLAY                    02SEP94PZ \\  \NEEDS CODE  \\                      э цODE (>PREVLINE  ( LINE> -- LINE'> )      сп )Y LDA  TAY  сп X) LDA                TEXT( CMP 0= ?[ TEXT( 1+ CPY ]?          0= ?[ LINE> LDA  LINE> 1+ LDY         лABEL END  сп X) STA  TYA  1 # LDY                  сп )Y STA  нEXT JMP ]?           SEC  1 # SBC  CC ?[ DEY ]?               [[ TEXT( CMP  0= ?[ TEXT( 1+ CPY ]?      END BEQ                                  >TEXT[ CMP  0= ?[ >TEXT[ 1+ CPY ]?       END BEQ   SEC  1 # SBC  CC ?[ DEY ]?     н STA  н 1+ STY н X) LDA  #CR # CMP      0= ?]  CLC  1 # ADC  0= ?[ INY ]?        END JMP  END-CODE                     э цODE (>NEXTLINE  ( LINE> -- LINE'> )      сп X) LDA н STA  сп )Y LDA н 1+ STA      [[ н X) LDA  #CR # CMP  0<> ?[[          н WINC ]]?                               н 1+ LDY  н INC  0= ?[ INY ]?  н LDA     )TEXT CMP 0= ?[ )TEXT 1+ CPY ]?          0= ?[ TEXT( LDA  TEXT( 1+ LDY ]?         сп X) STA  TYA  1 # LDY  сп )Y STA       нEXT JMP  END-CODE                   \   DISPLAY                    02SEP94PZ                                          \NEEDS >PREVLINE (                       \\ )                                                                              э : >PREVLINE  ( LINE> -- LINE'> )            DUP TEXT( @ =                               иф DROP LINE> @ EXIT тхен             1- бегин DUP TEXT( @ = ?EXIT                      DUP TEXT[   = ?EXIT             1- DUP C@ #CR = унтил 1+ ;                                                   э : >NEXTLINE  ( LINE> -- LINE'> )            бегин DUP C@ #CR - вхиле 1+ репеат       1+ DUP )TEXT @ =                            иф DROP TEXT( @ тхен ;           \\                                       э : >PREVLINE ( LINE> -- LINE'> )             DUP  >PREVLINE1                          SWAP (>PREVLINE  OVER -                     иф WARN-SIGNAL тхен ;            э : >NEXTLINE ( LINE> -- LINE'> )             DUP  >NEXTLINE1                          SWAP (>NEXTLINE  OVER -                     иф WARN-SIGNAL тхен ;           \   DISPLAY                    31AUG94PZ                                          э : SETCUR ( SCRLINE -- )                     CSR.ROW> !                               CHAR @ 1.COLUMN @ - CSR.COL !            FLIP ;                                                                       \ : .LINE ( -- )                         \    CSR.ROW> @  LINE> @ OVER            \    (.LINE SETCUR ;                                                              э : .SCREEN ( -- )                            1ST-LINE> @   <SCR SCR>                  до DUP и (.LINE                          DUP LINE> @ = иф и SETCUR тхен           >NEXTLINE DUP ]TEXT 1- =                    иф >PREVLINE LAST-LINE> !                и COL/SCR +  <SCR OVER -                 DUP COL/SCR / BLANKLINES !               BL FILL унлооп EXIT тхен              COL/SCR +лооп                            >PREVLINE LAST-LINE> !                   BLANKLINES OFF ;                                                                                                     \   DISPLAY                    31AUG94PZ                                          э : SCROLL-RIGHT? ( --  FLAG )                CSR.COL @ 0= ;                                                               э : SCROLL-LEFT? ( --  FLAG )                 CSR.COL @ COL/SCR 1- = ;                                                     э 8 CONSTANT #TAB                                                                 э : SCROLL-LEFT ( -- )                        #TAB 1.COLUMN +!    .SCREEN ;                                                э : SCROLL-RIGHT ( -- )                       1.COLUMN @ #TAB UMIN                     NEGATE 1.COLUMN +!  .SCREEN ;                                                                                         э : MEM?  ( N -- FLAG )                       )TEXT @ + TEXT( @ U>                     DUP иф WARN-SIGNAL тхен ;                                                                                                                                                                              \   DISPLAY                    14SEP94PZ                                          э : .CHAR ( C -- )  VIR-CHAR OFF              1 MEM? ?EXIT   CHANGED? ON               SCROLL-LEFT? иф SCROLL-LEFT тхен         CHAR> DUP 1+  )TEXT @ 1+                 DUP )TEXT !   OVER - CMOVE>              DUP CHAR> C!  1 CHAR +!                  FLIP  CURSOR> DUP 1+                     COL/SCR CSR.COL @ - 1- CMOVE>            CBM>SCR  CURSOR> C!                      1 CSR.COL +!  FLIP ;                                                         э : .LEFT  ( -- )   VIR-CHAR OFF              CHAR @ 0= ?EXIT                          SCROLL-RIGHT? иф SCROLL-RIGHT тхен       -1 CHAR +!                               FLIP -1 CSR.COL +! FLIP ;                                                    э : .RIGHT  ( -- )  VIR-CHAR OFF              CHAR> 1+ )TEXT @ = ?EXIT                 SCROLL-LEFT? иф SCROLL-LEFT тхен         1 CHAR +!                                FLIP  1 CSR.COL +!  FLIP ;                                                  \   DISPLAY                    14SEP94PZ                                          э : 1ST-LINE-UP ( -- )                        1ST-LINE> @ >PREVLINE                    1ST-LINE> ! ;                                                                э : 1ST-LINE-DOWN ( -- )                      1ST-LINE> @ >NEXTLINE                    1ST-LINE> ! ;                                                                э : LAST-LINE-UP ( -- )                       BLANKLINES @                                иф -1 BLANKLINES +!                      елсе LAST-LINE> @                        >PREVLINE LAST-LINE> ! тхен ;                                             э : LAST-LINE-DOWN ( -- )                     LAST-LINE> @ >NEXTLINE                   DUP ]TEXT 1- = иф 1 BLANKLINES +!                       DROP EXIT тхен            LAST-LINE> ! ;                                                                                                                                                                                         \   DISPLAY                    31AUG94PZ                                          э : .VIR-LEFT  ( -- )                         )TEXT @ LINE> @ - 1- >R                  VIR-CHAR @ 0=                               иф CHAR @ R@ U>                             иф CHAR @ VIR-CHAR !                     елсе RDROP EXIT тхен  тхен         VIR-CHAR @  DUP R> UMIN CHAR @ -         ?DUP 0= иф DROP EXIT тхен >R             R@ CHAR @ + DUP CHAR !                   OVER = 0= AND VIR-CHAR !                 R@ CSR.COL @ +  DUP COL/SCR <            SWAP -1 > AND                               иф FLIP R> CSR.COL +! FLIP               елсе 1.COLUMN @ R> +                     DUP 0< иф CSR.COL +!                            1.COLUMN OFF                             елсе 1.COLUMN ! тхен              .SCREEN тхен ;                                                                                                                                                                                                                               \   DISPLAY                    13SEP94PZ                                          э : (DEL-LINE  ( LINE -- )                    DUP COL/SCR + UNDER                      <SCR SWAP - CMOVE                        LAST-ROW> COL/SCR BL FILL ;                                                  э : LINE-UP  ( -- )                           TEXT( @  DUP LAST-LINE> @ = >R                    ( FROM )   DUP >NEXTLINE        DUP TEXT( !         OVER - >R            )TEXT @ ( FROM TO ) DUP LINE> !          DUP R@ + )TEXT !    R> CMOVE             R> иф LINE> @ LAST-LINE> ! тхен ;                                            э : .DOWN ( -- )                              TEXT( @ 1+ ]TEXT = ?EXIT                 LINE-UP                                  FLIP  CSR.ROW> @ LAST-ROW> =                иф SCR> (DEL-LINE                        1ST-LINE-DOWN LAST-LINE-DOWN             LAST-LINE> @ LAST-ROW> (.LINE            елсе COL/SCR CSR.ROW> +! тхен         FLIP  .VIR-LEFT ;                                                           \   DISPLAY                    13SEP94PZ                                          э : (INST-LINE  ( LINE -- )                   DUP  DUP COL/SCR +                       <SCR OVER - CMOVE>                            COL/SCR BL FILL ;                                                       э : LINE-DOWN  ( -- )                         LINE> @  DUP LAST-LINE> @ = >R                   )TEXT @ OVER - >R                TEXT( @ R@ -  DUP TEXT( !                R>  CMOVE>   LINE> @ DUP )TEXT !         >PREVLINE LINE> !                        R> иф TEXT( @ LAST-LINE> ! тхен ;                                            э : .UP ( -- )                                LINE> @ TEXT[ = ?EXIT                    LINE-DOWN                                FLIP  CSR.ROW> @ SCR> =                     иф 1ST-LINE-UP LAST-LINE-UP              SCR> (INST-LINE                          1ST-LINE> @ SCR> (.LINE                  елсе COL/SCR NEGATE                      CSR.ROW> +! тхен                      FLIP  .VIR-LEFT ;                  \   DISPLAY                    14SEP94PZ                                          э : .DEL-FROM  ( -- )                         VIR-CHAR OFF  CHANGED? ON                CHAR> #CR OVER C!  1+ )TEXT !            CURSOR> COL/SCR CSR.COL @ -              BL FILL  FLIP ;                                                              э : .DEL-TO  ( -- )                           VIR-CHAR OFF  CHANGED? ON                LINE> @ CHAR> OVER - BL FILL             CSR.ROW> @ CSR.COL @ BL FILL ;                                               э : .DEL-LINE  ( -- )                         .DEL-TO .DEL-FROM ;                                                                                                                                                                                                                                                                                                                                                                                                                                          \   DISPLAY                    14SEP94PZ                                          э : (SPLIT-MEM  ( -- )                        CHAR> )TEXT @ OVER -  OVER 1+ SWAP       CMOVE>  #CR CHAR> C!  1 )TEXT +!         CHAR> 1+ LINE> !  CHAR OFF ;                                                 э : .SPLIT-LINE ( -- )  VIR-CHAR OFF          1 MEM? ?EXIT   CHANGED? ON               LINE> @ LAST-LINE> @ =  (SPLIT-MEM          иф CHAR> LAST-LINE> !                    BLANKLINES @                                иф -1 BLANKLINES +!                      елсе 1ST-LINE-DOWN тхен               елсе LAST-LINE-UP тхен                1.COLUMN @ иф 1.COLUMN OFF                          .SCREEN EXIT тхен             CURSOR> COL/SCR CSR.COL @ - BL FILL      CSR.COL OFF                              CSR.ROW> @ LAST-ROW> =                      иф 1ST-ROW> (DEL-LINE                    елсе COL/SCR CSR.ROW> +!                 CSR.ROW> @ (INST-LINE тхен            LINE> @ CSR.ROW> @ (.LINE  FLIP ;                                           \   DISPLAY                    15SEP94PZ                                          э : (JOIN-MEM  ( -- )                         LINE> @  DUP >PREVLINE >R                DUP R@ - 1- CHAR !                  ( LINE )    )TEXT @ OVER -   OVER 1-     ( LINE LEN LINE-1 ) SWAP CMOVE   ( -- )       -1 )TEXT +!   R> LINE> !  ;                                                  э : (JOIN-1STLAST  ( N -- )                   0 CASE? иф LAST-LINE-DOWN EXIT тхен      2 CASE? иф TEXT( @ 1+ ]TEXT =                       иф LINE> @ LAST-LINE> !                  1 BLANKLINES +!                          елсе TEXT( @                             LAST-LINE> ! тхен                     EXIT тхен                        1 =     иф LINE> @ 1ST-LINE> !                   EXIT тхен                        LINE> @ DUP 1ST-LINE> !                  LAST-LINE> ! 1 BLANKLINES +! ;                                                                                                                                                                         \   DISPLAY                    14SEP94PZ                                          э : .JOIN-LINES  ( -- )  VIR-CHAR OFF         LINE> @ TEXT[ = ?EXIT                    CHANGED? ON                              LINE> @ 1ST-LINE>  @ =  1 AND            LINE> @ LAST-LINE> @ =  2 AND OR         (JOIN-MEM   (JOIN-1STLAST                CHAR @ 1.COLUMN @ -    ( CSR.COL )       DUP COL/SCR U<                              иф CSR.COL !                             CSR.ROW> @  1ST-ROW> -                      иф CSR.ROW> @ (DEL-LINE                  COL/SCR NEGATE CSR.ROW> +!               BLANKLINES @ 0=                             иф LAST-LINE> @ LAST-ROW>                (.LINE тхен                           тхен                                  LINE> @ CSR.ROW> @ (.LINE FLIP           елсе COL/SCR - #TAB +                    1.COLUMN +! .SCREEN тхен ;                                                                                                                                                                          \   DISPLAY                    14SEP94PZ                                          э : .DEL-UNDER  ( -- )  VIR-CHAR OFF          CHAR> C@ #CR = ?EXIT                     CHANGED? ON                              CHAR> DUP 1+ SWAP )TEXT @ 1-             DUP )TEXT !  OVER - CMOVE                CURSOR> DUP 1+ SWAP                      COL/SCR CSR.COL @ - 1- CMOVE             LINE> @ 1.COLUMN @ + COL/SCR + 1-        DUP )TEXT @ 1- U<                           иф C@ елсе DROP BL тхен CBM>SCR       CSR.ROW> @ COL/SCR + 1- C!               FLIP ;                                                                       э : .DEL-LEFT  ( -- )                         CSR.COL @                                   иф .LEFT .DEL-UNDER                      елсе .JOIN-LINES тхен  ;                                                                                                                                                                                                                                                              \   FOLD/UNFOLD                31AUG94PZ                                          э : UNFOLD  ( -- )                            CHAR OFF  1.COLUMN OFF                   TEXT[ DUP 1ST-LINE> ! DUP LINE> !        >NEXTLINE DUP TEXT( @ =                     иф DROP EXIT тхен   ( FROM )          )TEXT @ OVER - >R  DUP )TEXT !           TEXT( @ R@ -       DUP TEXT( !           R> CMOVE> ;                                                                  \\                                                                                э : FOLD  ( -- )                              TEXT( @  ]TEXT 1- OVER -                 ?DUP 0= иф DROP EXIT тхен                )TEXT @ SWAP   DUP )TEXT +!              CMOVE   ]TEXT 1- TEXT( ! ;                                                                                                                                                                                                                                                                                                        \   LOADTEXT                   07MAY95PZ                                          э : (LOADTEXT  ( -- )                         #CR  ]TEXT 1-  DUP TEXT( !               DUP 1- )TEXT !  C!                       ]TEXT 2- TEXT[ до I/O-STATUS?               иф и )TEXT ! леаже тхен               BUS@ и C! лооп                           )TEXT @ DUP 1- C@ #CR =                     иф DROP елсе #CR OVER C!                 1+ )TEXT ! тхен  1 MEM? DROP ;                                            э : LOADTEXT  ( -- )                          DEV 2 BUSOPEN                            FILENAME COUNT BUSTYPE                   " ,S,R"  COUNT BUSTYPE BUSOFF            PAGE  DERROR?                               иф DEV 2 BUSCLOSE                        CHANGED? OFF  .SCREEN                    EXIT тхен                             DEV 2 BUSIN  (LOADTEXT  BUSOFF           DEV 2 BUSCLOSE                           CHANGED? OFF  UNFOLD  .SCREEN ;                                                                                      \   SAVESYSTEM                 07MAY95PZ                                          э : (SAVETEXT  ( -- FLAG )                    CR ." WRITING " FILENAME                 COUNT TYPE CR CR                         DEV 15 BUSOUT " S0:/" COUNT              BUSTYPE FILENAME COUNT BUSTYPE           BUSOFF  DEV 15 BUSOUT " R0:/"            COUNT BUSTYPE FILENAME COUNT 2DUP        BUSTYPE ASCII =  BUS! BUSTYPE            BUSOFF   \ DERROR? ?DUP ?EXIT            DEV 2 BUSOPEN FILENAME COUNT             BUSTYPE " ,S,W" COUNT BUSTYPE            BUSOFF  DEV 2 BUSOUT                     TEXT[   )TEXT @  OVER - BUSTYPE          TEXT( @ ]TEXT 1- OVER - BUSTYPE          DEV 2 BUSCLOSE  DERROR? ;                                                    э : SAVETEXT  ( -- )                          PAGE (SAVETEXT                              иф ." WRITE OPERATION FAILED"            CR KEY DROP                              елсе CHANGED? OFF тхен                .SCREEN ;                                                                   \   DISPLAY                    31AUG94PZ                                          э : .BOL  ( -- )                              CHAR OFF  VIR-CHAR OFF  1.COLUMN @          иф 1.COLUMN OFF .SCREEN                  елсе FLIP CSR.COL OFF FLIP               тхен ;                                                                    э : .EOL  ( -- )                              VIR-CHAR OFF                             )TEXT @ 1- CHAR> - DUP >R  CHAR +!       CSR.COL @ R@ + COL/SCR - DUP 0<             иф DROP FLIP R> CSR.COL +! FLIP          елсе 1+ 1.COLUMN +!                      RDROP .SCREEN тхен ;                                                      э : .CR  ( -- )                               .BOL .DOWN ;                                                                                                                                                                                                                                                                                                                      \   EXIT                       14SEP94PZ                                          э : (QUIT-ED  ( -- )  CR                 ." DO YOU WANT TO QUIT WITHOUT SAVING ?"      KEY ASCII Y = DUP END? !                 0= иф .SCREEN тхен ;                                                         э : QUIT-ED  ( -- )                           PAGE  CHANGED? @                            иф (QUIT-ED елсе END? ON тхен ;                                           э : EXIT-ED  ( -- )                           PAGE  CHANGED? @                            иф (SAVETEXT                                иф (QUIT-ED EXIT тхен тхен         END? ON ;                                                                                                                                                                                                                                                                                                                                                                                                           \   INST/DELLINE               15SEP94PZ                                          э : .KILL-LINE ( -- )                         VIR-CHAR OFF                             TEXT( @ 1+ ]TEXT = ?EXIT                 CHANGED? ON                              LAST-LINE-DOWN                           LINE> @ )TEXT ! LINE-UP                  CSR.ROW> @  (DEL-LINE                    BLANKLINES @ 0=                            иф LAST-LINE> @ LAST-ROW>                (.LINE тхен                            FLIP  .VIR-LEFT ;                                                            э : .INST-LINE ( -- )                         VIR-CHAR OFF   1 MEM? ?EXIT              CHANGED? ON                              LAST-LINE> @ LINE> @ =                      иф 1 LAST-LINE> +! тхен               CHAR @ CHAR OFF (SPLIT-MEM CHAR !        LINE-DOWN  LAST-LINE-UP                  FLIP  CSR.ROW> @ (INST-LINE              FLIP  .VIR-LEFT ;                                                                                                    \   FAST UP/DOWN               15SEP94PZ                                          э : N>PREVLINE  ( LINE +N -- LINE' )          0 до DUP TEXT[ =                            иф унлооп EXIT тхен                   >PREVLINE лооп ;                                                             э : N>NEXTLINE  ( LINE +N -- LINE' )          0 до DUP >NEXTLINE  DUP 1+ ]TEXT =          иф DROP унлооп EXIT тхен              NIP лооп ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \   FAST UP/DOWN               15SEP94PZ                                          э : N-LINE-DOWN  ( +N -- )                    LINE> @ TEXT[ = иф DROP EXIT тхен        LINE> @ SWAP N>PREVLINE                  DUP LINE> ! >NEXTLINE                    )TEXT @ OVER - >R  DUP )TEXT !           TEXT( @ R@ - DUP TEXT( !                 R> CMOVE> ;                                                                  э : N-LINE-UP  ( +N -- )                      TEXT( @ DUP ROT N>NEXTLINE               2DUP = иф 2DROP EXIT тхен                OVER - >R  )TEXT @  R@ CMOVE             R@ )TEXT +!  R> TEXT( +!                 )TEXT @ >PREVLINE LINE> ! ;                                                                                                                                                                                                                                                                                                                                                                                         \   FAST UP/DOWN               15SEP94PZ                                          э : .20UP  ( -- )                             1ST-LINE> @ 20 N>PREVLINE                1ST-LINE> !  20 N-LINE-DOWN              CHAR OFF  .SCREEN ;                                                          э : .20DOWN  ( -- )                           20 N-LINE-UP                             1ST-LINE> @ 20 N>NEXTLINE                1ST-LINE> !                              CHAR OFF  .SCREEN ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   EDIT PAGE                  20FEB92PZ                                          э : LINE-UP ( -- )                            )TEXT @ DUP LINE> !                      TEXT( @ UNDER                            COUNT UNDER + 1+ TEXT( !                 2+ 2DUP + )TEXT ! CMOVE ;                                                    э : DOWN ( -- )                               END-OF-PAGE? ?EXIT                       FOLD-LINE LINE-UP .DOWN ;                                                    э : SCROLLUP ( -- )                           END-OF-PAGE? ?EXIT                       FOLD-LINE LINE-UP .SCROLL-UP ;                                                                                                                                                                                                                                                                                                                                                                                                                               \   EDIT PAGE                  12APR92PZ                                          э : DELTA-CHAR ( -- N )                       LINE> @ 1+  CHAR @  UNDER                -TRAILING NIP - NEGATE 2+ ;                                                  э : LEN(REST) ( -- N )                        LINE> @ C@ CHAR @ - ;                                                        э : SPLITLINE ( -- )                          FOLD-LINE  2 MEM? ?EXIT                  LEN(REST) >R  CHAR>                      DELTA-CHAR DUP )TEXT +! CHAR +!          CHAR> R@ MOVE                            R@ CHAR> 1- C!  R> )TEXT @ 1- C!         CHAR @ 2- DUP  LINE> @ C!                CHAR> 1-  DUP LINE> !  1- C!             CHAR OFF                                 .DEL-FROM .DOWN .INST-LINE               1.COLUMN @                                  иф 1.COLUMN OFF  .SCREEN                 елсе .CR .LINE тхен                   CHANGED! ;                                                                                                           \   EDIT PAGE                  12APR92PZ                                          э : CONCATLINES ( -- )                        BEGIN-OF-PAGE? ?EXIT  FOLD-LINE          LINE> @ DUP C@ >R DUP 1- C@              DUP CHAR !  2+ NEGATE LINE> +!           1+ DUP 2- R@ CMOVE                       R> CHAR @ + DUP                          )TEXT @ 2- DUP )TEXT !  1- C!            LINE> @ C!                               .DEL-LINE .UP                            CHAR @ 1.COLUMN @ - COL/SCR U<              иф .LINE                                 елсе CHAR @ COL/SCR 2/ -                 1.COLUMN !  .SCREEN тхен              CHANGED! ;                                                                   э : DELLEFT' ( -- )                           CHAR @                                      иф DELLEFT                               елсе CONCATLINES тхен ;                                                                                                                                                                             \   EDIT PAGE                  12APR92PZ                                          э : CREATELINE.AFTER ( -- )                   TEXT( @ 2- DUP OFF TEXT( ! ;                                                 э : CREATELINE.BEFORE ( -- )                  LINE> @  DUP  DUP 2+  DUP LINE> !        )TEXT @ 2+  DUP )TEXT !                  OVER - CMOVE>  OFF ;                                                         э : INSTLINE ( -- )                           FOLD-LINE  2 MEM? ?EXIT                  CREATELINE.BEFORE LINE-DOWN              .INST-LINE  CHANGED! ;                                                       э : NEXTLINE ( -- )                           FOLD-LINE  END-OF-PAGE?                     иф 2 MEM? ?EXIT                          CREATELINE.AFTER тхен                 LINE-UP .DOWN                            CHAR OFF  1.COLUMN @                        иф 1.COLUMN OFF  .SCREEN                 елсе .CR тхен                         CHANGED! ;                                                                  \   EDIT PAGE                  12APR92PZ                                          э : CLEARLINE ( -- )                          LINE> @ DUP OFF 2+ )TEXT !               .CLEAR-LINE  CHANGED! ;                                                      э : DELLINE ( -- )                            END-OF-PAGE?                                иф CLEARLINE                             елсе FOLD-LINE                           LINE> @ )TEXT !  LINE-UP                 .DEL-LINE тхен                        CHANGED! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   EDIT PAGE: PROTOTYP        19APR92PZ                                          э : HOME-PAGE ( -- )                          LINE> @ PAGE[ @ =                           иф HOME-LINE                             елсе UNSPLITTEXT                         CHAR OFF  1.COLUMN OFF                   PAGE[ @ DUP 1ST-LINE> !                  DUP LINE> !  COUNT + 1+                  DUP )TEXT !  TEXT( !                     SPLITTEXT .SCREEN тхен ;                                                  э : END-PAGE ( -- )                           TEXT( @ ]PAGE @ = BLANKLINES @ 0=       AND иф HOME-LINE                             елсе UNSPLITTEXT                         CHAR OFF  1.COLUMN OFF                   ]PAGE @ DUP TEXT( ! DUP )TEXT !          1- COUNT - 2- DUP LINE> !                ROWS/SCR 1- 0                            ?до DUP PAGE[ @ = иф леаже тхен          1- COUNT - 2- лооп 1ST-LINE> !           SPLITTEXT .SCREEN тхен ;                                                                                          KKKK\ FEATURES и                   15APR92PZ                                            1 8 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   FEATURES и                 15APR92PZ                                          э : INSERT-STRING ( ADR +N )                  BOUNDS ?до и C@ PUTCHAR лооп ;                                               э : DEL-STRING ( +N )                         0 до DELUNDER лооп ;                                                                                                  \ : STRNCPY ( SRC DST MAXLEN -- )        \    ROT COUNT ROT UMIN ROT 2DUP >R >R   \    1+ SWAP MOVE R> R> C! ;                                                      \    >R OVER C@ R> UMIN 2DUP >R >R       \    1+ MOVE R> R> SWAP C! ;                                                      э : STRCPY ( SRC DST -- )                     OVER C@ 1+ MOVE ;                                                            э : MEMCAT                                ( DST DLEN SRC SLEN -- DST DLEN+SLEN )       >R >R 2DUP + R> SWAP R@ MOVE             R> + ;                                                                                                               \   FEATURES и                 17APR92PZ                                          э CREATE (1MSG 1 ALLOT                                                            э : .1CHARMSG ( C -- )                        (1MSG C! (1MSG 1 .MSG ;                                                                                               э : SWITCH2TEXT# ( N -- )                     UNSPLITTEXT TEXT#!                       TEXT[ @ ]TEXT @ =                        SPLITTEXT  иф CLEARTEXT тхен             .SCREEN ;                                                                    э : SWITCHTEXT ( -- )                         " GOTO TEXT NO. ?" COUNT .MSG            KEY ASCII 0 -                            DUP 1 #TEXTS UWITHIN                        иф DUP SWITCH2TEXT#  ASCII 0 +           елсе DROP ASCII ? тхен                .1CHARMSG ;                                                                                                                                                                                            \   FEATURES и                 12APR92PZ                                          э : LINECPY ( SRC DST -- )                    OVER C@ 2+ MOVE ;                                                            э : (COPYLINE ( -- )                          LINE> @ DUP  C@ 2+ NEGATE                TEXT( LINESTACK> MOVETEXTS               LINESTACK> @ LINECPY ;                                                       э : COPYLINE ( -- )                           257 MEM? ?EXIT                           (COPYLINE DOWN ;                                                             э : CUTLINE ( -- )                            0 MEM? ?EXIT                             (COPYLINE DELLINE ;                                                                                                                                                                                                                                                                                                                                                        \   FEATURES и                 12APR92PZ                                          э : PASTELINE ( -- )                          LINESTACK> @ CHARSTACK[ @ =                 иф WARN-SIGNAL EXIT тхен              0 MEM? ?EXIT  INSTLINE                   LINESTACK> @ DUP C@ >R                   LINE> @ LINECPY  R@ )TEXT +!             R> 2+ TEXT( LINESTACK> MOVETEXTS         .LINE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   FEATURES и                 16APR92PZ                                          э 40 CONSTANT ALLOT-UNIT                                                          э : (COPYCHAR ( -- )                          CHARSTACK[ @ CHARSTACK> @ =                 иф ALLOT-UNIT NEGATE                     TEXT( CHARSTACK[ MOVETEXTS тхен       CHAR @ LINE> @ C@ U<                        иф CHAR> C@ елсе BL тхен              CHARSTACK> @ 1- DUP CHARSTACK> !         C! ;                                                                         э : COPYCHAR ( -- )                           ALLOT-UNIT MEM? ?EXIT                    (COPYCHAR RIGHT ;                                                            э : CUTCHAR ( -- )                            ALLOT-UNIT MEM? ?EXIT                    (COPYCHAR DELUNDER ;                                                                                                                                                                                                                            \   FEATURES и                 12APR92PZ                                          э : PASTECHAR ( -- )                          CHARSTACK> @ ]EDIT =                        иф WARN-SIGNAL EXIT тхен              1 MEM? ?EXIT                             INSERT? PUSH  INSERT? ON                 CHARSTACK> @ DUP 1+ CHARSTACK> !         C@ PUTCHAR LEFT                          CHARSTACK> @ CHARSTACK[ @ -              CHARSTACK> @ ]EDIT XOR                      иф ALLOT-UNIT 2* U< 0=                   ALLOT-UNIT AND тхен                   ?DUP                                        иф TEXT( CHARSTACK[ MOVETEXTS            тхен ;                                                                                                                                                                                                                                                                                                                                                                                                           \   FEATURES и                 17APR92PZ                                          э VARIABLE (CANCEL (CANCEL OFF           э : CANCEL ( -- )   (CANCEL ON  END! ;   э : .CANCEL  " CANCELLED" COUNT .MSG ;   э : CANCELLED? ( -- FLAG )                    (CANCEL @  (CANCEL OFF                   DUP иф .CANCEL тхен ;                                                        э : STRMEMCAT ( ADR LEN STR -- ADR L' )       COUNT MEMCAT ;                                                               э : PROCEED? ( ADR LEN -- FLAG )              " PROCEED ? (Y/N)" STRMEMCAT .MSG        KEY ASCII Y = DUP 0=                        иф .CANCEL тхен ;                                                         э : UNSAVED? ( -- FLAG )                      CHANGED? @ DUP                              иф DROP  PAD 0                           " CHANGES NOT SAVED! "                   STRMEMCAT PROCEED? 0= тхен ;                                                                                                                               \   FEATURES и                 18APR92PZ                                          э : .LOGO ( -- )                              " PEDDI V1.0" COUNT .MSG ;                                                   э : KILLTEXT ( -- )                           PAD 0 " KILL TEXT: " STRMEMCAT           PROCEED?                                    иф CLEARTEXT .LOGO .SCREEN               тхен ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \   FEATURES и                 17APR92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   FEATURES и                 12APR92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   FEATURES и                 12APR92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   STUFF                      12APR92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   STUFF                      12APR92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   STUFF                      12APR92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   STUFF                      12APR92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        KKKKKKKKKKKKKKKK\ FEATURES ии                  19APR92PZ                                           1 12 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   FEATURES ии                15APR92PZ                                          э EDLOOP EDIT-LINE                                                                 COPYCHAR NOOP     NOOP     NOOP          DELUNDER NOOP     NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     END!     NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          DELLEFT  NOOP     NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     RIGHT    NOOP     NOOP                                                   NOOP     NOOP     NOOP     NOOP          NOOP     NOOP     NOOP      PASTECHAR    NOOP     NOOP     NOOP     CUTCHAR       NOOP     CANCEL   NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          +-INST   NOOP     NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     LEFT     NOOP     NOOP                                                   CR .( EDIT-LINE OKAY ! ) CR                                                                                              \   FEATURES ии                12APR92PZ                                          э : EDIT-STRING ( ADR MAXLEN -- )             2ND-SCREEN  TEXT#@ >R                    UNSPLITTEXT 0 TEXT#! SPLITTEXT           .SCREEN OVER COUNT INSERT-STRING         EDIT-LINE                                LINE> @ COUNT ROT UMIN ROT 2DUP C!       1+ SWAP CMOVE  CLEARTEXT                 UNSPLITTEXT R> TEXT#! SPLITTEXT          1ST-SCREEN ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   FEATURES ии                17APR92PZ                                          э : CR=    C@   $0D = ;                  э : LF=    C@   $0A = ;                  э : CRLF=   @ $0A0D = ; \ LO/HI-бYTE IM  э : LFCR=   @ $0D0A = ; \ иNTEL-фORMAT                                            э CREATE EOL-CFA                            ' CR= , ' LF= , ' CRLF= , ' LFCR= ,   э CREATE EOL-SEQ                            $0D ,  $0A ,  $0A0D ,  $0D0A ,        э CREATE EOL-LEN                            1 C, 1 C, 2 C, 2 C,                   э CREATE EOL-NAME                           ," CR" ," LF"                            ," CRLF" ," LFCR"                                                              э DEFER EOL=                             э VARIABLE EOL                           э VARIABLE /EOL                                                                                                                                                                                                                                      \   FEATURES ии                17APR92PZ                                          э VARIABLE EOL#  EOL# OFF                                                         э : .EOL-NAME ( -- )                          PAD 0 " EOL:" STRMEMCAT                  EOL-NAME  EOL# @ 3 AND  0                ?до COUNT + лооп STRMEMCAT .MSG ;                                            э : SET-EOL ( -- )                            EOL# @ 3 AND                                DUP EOL-LEN + C@ /EOL !               2* DUP EOL-CFA + @ ис EOL=                      EOL-SEQ + @ EOL ! ;                                                   э : SWITCH-EOL ( -- )                         1 EOL# +!  SET-EOL  .EOL-NAME ;                                                                                                                                                                                                                                                                                                                                            \   FEATURES ии                12APR92PZ                                          э : CHR, ( ADR C -- ADR+1 )                   OVER C! 1+ ;                                                                 э : BREAK-LINE ( N1 N2 -- N3 N4 )             UNDER OVER - 1-                          UNDER SWAP C!  CHR, DUP 1+ ;                                                 ( /???/...ASCII-TEXT.../                     ^ - N1              ^ - N2                         ---                          /LEN/...ASCII-TEXT.../LEN/???/                                 N3 - ^  ^ - N4 )                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   FEATURES ии                12APR92PZ                                          э : ASCII>LIST ( -- )                         PAGE[ @ )TEXT @ 2DUP ]PAGE @             SWAP - + >R  OVER - R@ SWAP CMOVE>       PAGE[ @ DUP 1+                           ]PAGE @ /EOL @ - 1+ R>                   до и EOL=                                   иф BREAK-LINE  /EOL @                    елсе 2DUP - -255 <                          иф BREAK-LINE  /EOL @                    " SPLIT LONG LINE" COUNT .MSG            елсе и C@ CHR,  1 тхен тхен        +лооп                                    2DUP 1- - иф BREAK-LINE тхен DROP        DUP )TEXT ! 1- COUNT - 2-                DUP LINE> !  1ST-LINE> !                 CHAR OFF  ]PAGE @ TEXT( ! ;                                                                                                                                                                                                                                                                                                       \   FEATURES ии                17APR92PZ                                          э : (.FILENAME ( STR -- )                     PAD 0 ROT STRMEMCAT                      "  FILENAME ?" STRMEMCAT .MSG ;                                              э : GETFILENAME  ( STR -- NAME )              (.FILENAME                               FILENAME PAD STRCPY                      PAD /FILENAME EDIT-STRING                DUP C@ 0=  CANCELLED?  OR                   иф RDROP EXIT тхен                    FILENAME C@ 0=                              иф PAD FILENAME STRCPY тхен           PAD ;                                                                        э : RENAMEFILE  ( -- )                        " NEW" (.FILENAME                        FILENAME /FILENAME EDIT-STRING ;                                                                                                                                                                                                                                                         \   FEATURES ии                19APR92PZ                                          э ASCII , CONSTANT ','                                                            э : CHECKTYPESPEC ( ADR L -- ADR' L' )        ?DUP иф OVER 1+ C@ ASCII @ U>                    иф $FFFF0001. D+ ',' SCAN                тхен тхен ;                                                          э : SETLENGTH ( STR X L -- STR X L )          2 PICK C@ OVER - 3 PICK C! ;                                                 э : SCANFILENAME                             ( NAME[,GA[,SA]] -- NAME GA SA )          DUP COUNT  2DUP + 0 SWAP C!              ',' SCAN  CHECKTYPESPEC  SETLENGTH       0= иф DROP 8 2 EXIT тхен                 0 0 ROT CONVERT NIP                      DUP C@ ',' -                                иф DROP 2 EXIT тхен                   0 0 ROT CONVERT 2DROP ;                                                                                                                                                                                \   FEATURES ии                19APR92PZ                                          э 2VARIABLE FADDR                                                                 э : DERROR? ( -- FLAG )                       2ND-SCREEN .CLS                          FADDR 2@ DROP 15 BUSIN                   BUS@ DUP ASCII 0 - SWAP                  бегин .CHAR BUS@ I/O-STATUS? унтил       DROP BUSOFF 1ST-SCREEN ;                                                     э : FILEOPEN ( NAME GA SA R/W -- )            >R                                       BUSOPEN COUNT 2DUP BUSTYPE               + 2- C@ ',' -                               иф ',' BUS! ASCII S BUS! тхен         ',' BUS! R> BUS! BUSOFF ;                                                                                                                                                                                                                                                                                                                                                  \   FEATURES ии                18APR92PZ                                          э : READASCII ( NAME -- )                     CLEARTEXT                                SCANFILENAME 2DUP FADDR 2!               BUSOPEN COUNT BUSTYPE                    " ,S,R" COUNT BUSTYPE BUSOFF             DERROR? ?EXIT                            FADDR 2@ BUSIN                           PAGE[ @ ]PAGE @ OVER - MIN.FREE -        BUSREAD                                     иф )TEXT !                               елсе ]TEXT @ MIN.FREE - )TEXT !          " MEMORY FULL" COUNT .MSG тхен        BUSOFF  FADDR 2@ BUSCLOSE                DERROR? DROP ;                                                               э : READTEXT ( -- )                           UNSAVED? ?EXIT                           " READ:" GETFILENAME READASCII           ASCII>LIST  CHANGED? OFF                 HOME-PAGE ;                                                                                                                                                   \   FEATURES ии                12APR92PZ                                          э : BACKUP-FILE ( GA NAME -- )                OVER 15 BUSOUT                           " S0:/" COUNT BUSTYPE                    DUP COUNT BUSTYPE BUSOFF                 SWAP 15 BUSOUT                           " R0:/" COUNT BUSTYPE                    DUP COUNT BUSTYPE ASCII = BUS!           COUNT BUSTYPE BUSOFF ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \   FEATURES ии                17APR92PZ                                          э : WRITETEXT ( -- )                          " WRITE:" GETFILENAME SCANFILENAME       2DUP FADDR 2!                            OVER 3 PICK BACKUP-FILE                  BUSOPEN COUNT BUSTYPE                    " ,S,W" COUNT BUSTYPE BUSOFF             DERROR? ?EXIT                            FADDR 2@ BUSOUT                          PAGE[ @ бегин DUP COUNT BUSTYPE                  EOL C@ BUS!  /EOL @ 1-                      иф EOL 1+ C@ BUS! тхен                >NEXTLINE DUP ]PAGE @ =                  унтил                            BUSOFF  FADDR 2@ BUSCLOSE                DERROR? DROP  CHANGED? OFF ;                                                                                                                                                                                                                                                                                                                                               \   FRAME                      12APR92PZ                                          э EDLOOP EDIT-PAGE                                                                 COPYCHAR NOOP     NOOP     NOOP          DELUNDER READTEXT NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     SPLITLINE NOOP    NOOP          NOOP     DOWN     NOOP     NOOP          DELLEFT' NOOP     NOOP     NOOP          END!     NOOP     NOOP     NOOP          NOOP     RIGHT    COPYLINE NOOP                                                   NOOP     NOOP     NOOP     NOOP          NOOP     INSTLINE PASTELINE PASTECHAR    SCROLLUP DELLINE  CUTLINE  CUTCHAR       SCROLLDOWN NEXTLINE NOOP   NOOP          WRITETEXT UP      SWITCH-EOL CLEARLINE   +-INST   NOOP     NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     LEFT     NOOP     RENAMEFILE                                             CR .( EDIT-PAGE OKAY ! ) CR                                                                                              \   FRAME                      01MAY92PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        KKKKKKKKKA                                                                                                                                             EDI═══════════════37═2A════                                                                                      Ъ                                                                                                                                                                                                                                                              KKKK\ ALLOCATE                     01MAY92PZ                                            1 1 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   ALLOCATE                   01MAY92PZ                                          \ ULTRAфортх-SPECIFIC DEFINITION:                                                 э 2048 CONSTANT STACKSIZE                э : HEAPSPACE ( -- N )                        S0 @  HERE -  STACKSIZE UMAX             STACKSIZE - ;                                                                э VARIABLE (EDIT[                        э VARIABLE (]EDIT                        э : EDIT[  (EDIT[ @ ;                    э : ]EDIT  (]EDIT @ ;                                                             э : EDIT[]-ALLOCATE ( -- N )                  HEAP (]EDIT !                            HEAPSPACE DUP HALLOT                     HEAP (EDIT[ ! ;                                                              э : EDIT[]-FREE ( -- )                        HEAP EDIT[ =                                иф EDIT[ ]EDIT - HALLOT елсе             ." EDITOR CAN'T RELEASE MEMORY"          тхен ;                                                                   KKKKKKKKKKKKKKKK\ FRAME                        01MAY92PZ                                           1 3 +THRU                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \   FRAME                      18APR92PZ                                          э EDLOOP EDIT-PAGE                                                                 COPYCHAR NOOP     SCROLLDOWN NOOP        DELUNDER WRITETEXT NOOP    NOOP          NOOP     NOOP     NOOP     KILLTEXT      NOOP     SPLITLINE SCROLLUP HOME-LINE    END-LINE DOWN     NOOP     HOME-PAGE     DELLEFT' NOOP     NOOP     NOOP          END!     NOOP     NOOP     NOOP          RENAMEFILE RIGHT  COPYLINE SWITCHTEXT                                             NOOP     NOOP     NOOP     NOOP          NOOP     INSTLINE PASTELINE PASTECHAR    HTAB>    DELLINE  CUTLINE  CUTCHAR       <HTAB    NEXTLINE CLEARLINE NOOP         READTEXT UP       SWITCH-EOL END-PAGE    +-INST   NOOP     NOOP     NOOP          NOOP     NOOP     NOOP     NOOP          NOOP     LEFT     NOOP     NOOP                                                   CR .( EDIT-PAGE OKAY ! ) CR                                                                                              \   FRAME                      01MAY92PZ                                          э VARIABLE ANY-CHANGED?                                                           э : SHOW-UNSAVED ( -- )                       ANY-CHANGED? OFF  TEXT#@  PAD 0          " UNSAVED TEXTS: " STRMEMCAT             #TEXTS 1 до и TEXT#!  CHANGED? @            иф и [ ASCII 0  BL 256 * + ]             LITERAL + OVER 3 PICK + !  2+            ANY-CHANGED? ON тхен                  лооп                                     ANY-CHANGED? @                              иф 1- .MSG елсе 2DROP тхен            TEXT#! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   FRAME                      01MAY92PZ                                          э : PEDDI ( -- )                              EDIT[]-ALLOCATE  1000 U< иф              ." TOO LITTLE MEMORY FOR EDITOR"         EXIT тхен                                                                         INIT-MEM  INIT-DISPLAY  SET-EOL          1 SWITCH2TEXT#  .LOGO                                                             бегин EDIT-PAGE SHOW-UNSAVED             " EXIT? (Y/N)" COUNT .MSG                KEY ASCII Y =                               DUP 0= иф .CANCEL тхен                унтил                                                                             PAGE EDIT[]-FREE ;                                                                                                                                                                                                                                                                                                                                                         \ CHECK-MEM                    13SEP94PZ                                            : CHECK-MEM  ( -- )                         LINE> @ 1ST-LINE> @ LAST-LINE> @         1+ UWITHIN NOT                              иф WARN-SIGNAL 1 1060 C! тхен    \    )TEXT @ 1ST-LINE> @ LAST-LINE> @    \    1+ UWITHIN NOT                      \       иф WARN-SIGNAL 2 1061 C! тхен    \    TEXT( @ 1ST-LINE> @ LAST-LINE> @    \    1+ UWITHIN NOT                      \       иф WARN-SIGNAL 3 1062 C! тхен         1ST-LINE> @   24 BLANKLINES @ до         >NEXTLINE лооп LAST-LINE> @ = 0=            иф WARN-SIGNAL 4 1063 C! тхен         )TEXT @ LINE> @ TEXT( @                  UWITHIN NOT                                 иф WARN-SIGNAL 5 1059 C! тхен         LINE> @ >NEXTLINE TEXT( @ -                 иф WARN-SIGNAL 6 1058 C! тхен      ;                                                                                                                                                                                                         \                              14SEP94PZ                                          э : PR-MEM  ( -- )                          PAGE ." TEXT[ " TEXT[ U. CR              ." 1ST-LINE> " 1ST-LINE> @ U. CR         ." LINE> " LINE> @ U. CR                 ." CHAR> " CHAR>   U. CR                 ." )TEXT " )TEXT @ U. CR                 ." TEXT( " TEXT( @ U. CR                 ." LAST-LINE> " LAST-LINE> @ U. CR       ." ]TEXT " ]TEXT U. CR                   ." BLANKLINES " BLANKLINES @ U. CR       1ST-LINE> @   24 BLANKLINES @ до         DUP U. ?CR >NEXTLINE лооп U. CR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \                              14SEP94PZ                                          э : .INST-LINE ( -- )                         VIR-CHAR OFF   1 MEM? ?EXIT              LINE> @  )TEXT @ OVER - >R               TEXT( @ R@ -  DUP TEXT( !                R> CMOVE>                                )TEXT @ DUP LINE> !  #CR OVER C!         1+ )TEXT !     LAST-LINE-UP              FLIP  CSR.ROW> @ (INST-LINE              FLIP  .VIR-LEFT ;                                                                       иф .UP тхен                           CSR.ROW> @ (DEL-LINE                     COL/SCR NEGATE CSR.ROW> +!               BLANKLINES @ 0=                             иф LAST-LINE> @ LAST-ROW>                (.LINE тхен                                                                                                                                                                                                                                                                                                                                                14SEP94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK\ TRANSIENT аSSEMBLER         C09MAY94PZ                                          \NEEDS CODE  1 +LOAD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \ фORTH-6502 аSSEMBLER        C18JUN94PZ                                          \ бASIS: фORTH дIMENSIONS жол иии нO. 5)                                          \ INTERNAL LOADING         04MAY85бп/RE)                                          HERE   $800 HALLOT  HEAP DP !                                                     оNLYFORTH  аSSEMBLER ALSO DEFINITIONS             1 7 +THRU                                                                                                         ' NOOP иS .STATUS                                                                 : .BLK  ( -)                              BLK @ ?DUP иф  ."  бLK " U. ?CR  тхен ;                                          ' .BLK иS .STATUS                                                                                                          DP !                                                                              оNLYFORTH                                                                                                                 \ фORTH-83 6502-аSSEMBLER      20OCT87RE                                          : END-CODE   CONTEXT 2- @  CONTEXT ! ;                                            цREATE INDEX                             $0909 , $1505 , $0115 , $8011 ,          $8009 , $1д0д , $8019 , $8080 ,          $0080 , $1404 , $8014 , $8080 ,          $8080 , $1ц0ц , $801ц , $2ц80 ,                                                   э жARIABLE MODE                                                                   : мODE:  ( N -)   цREATE C,                дOES>  ( -)     C@ MODE ! ;                                                     0   мODE: .а        1    мODE: #         2 э мODE: MEM       3    мODE: ,ь        4   мODE: ,ы        5    мODE: ь)        6   мODE: )ы       $ф    мODE: )                                                                                                                                                                                                                                                              \ UPMODE  CPU                  20OCT87RE                                          э : UPMODE ( ADDR0 F0 - ADDR1 F1)         иф MODE @  8 OR MODE !   тхен            1 MODE @  $ф AND ?DUP иф                 0 до  DUP +  лооп тхен                   OVER 1+ @ AND 0= ;                                                               : CPU  ( 8B -)   цREATE  C,                дOES>  ( -)    C@ C, MEM ;                                                       00 CPU BRK $18 CPU CLC $д8 CPU CLD      $58 CPU CLI $б8 CPU CLV $ца CPU DEX      $88 CPU DEY $е8 CPU INX $ц8 CPU INY      $еа CPU NOP $48 CPU PHA $08 CPU PHP      $68 CPU PLA $28 CPU PLP $40 CPU RTI      $60 CPU RTS $38 CPU SEC $ф8 CPU SED      $78 CPU SEI $аа CPU TAX $а8 CPU TAY      $ба CPU TSX $8а CPU TXA $9а CPU TXS      $98 CPU TYA                                                                                                                                                                                                                                          \ M/CPU                        20OCT87RE                                          : M/CPU  ( MODE OPCODE -)  цREATE C, ,    дOES>                                    DUP 1+ @ $80 AND иф $10 MODE +! тхен     OVER $фф00 AND UPMODE UPMODE             иф MEM TRUE аBORT" INVALID" тхен         C@ MODE @ INDEX + C@ + C, MODE @ 7 AND   иф MODE @  $ф AND 7 <                     иф C, елсе , тхен тхен MEM ;                                                    $1ц6е $60 M/CPU ADC $1ц6е $20 M/CPU AND  $1ц6е $ц0 M/CPU CMP $1ц6е $40 M/CPU EOR  $1ц6е $а0 M/CPU LDA $1ц6е $00 M/CPU ORA  $1ц6е $е0 M/CPU SBC $1ц6ц $80 M/CPU STA  $0д0д $01 M/CPU ASL $0ц0ц $ц1 M/CPU DEC  $0ц0ц $е1 M/CPU INC $0д0д $41 M/CPU LSR  $0д0д $21 M/CPU ROL $0д0д $61 M/CPU ROR  $0414 $81 M/CPU STX $0486 $е0 M/CPU CPX  $0486 $ц0 M/CPU CPY $1496 $а2 M/CPU LDX  $0ц8е $а0 M/CPU LDY $048ц $80 M/CPU STY  $0480 $14 M/CPU JSR $8480 $40 M/CPU JMP  $0484 $20 M/CPU BIT                                                                                                       \ аSSEMBLER CONDITIONALS       20OCT87RE                                          э : RANGE?   ( BRANCH -- BRANCH )         DUP ABS  $7ф U> аBORT" OUT OF RANGE " ;                                          : [[  ( бегин)  HERE ;                                                            : ?]  ( унтил)  C, HERE 1+ - RANGE? C, ;                                          : ?[  ( иф)     C,  HERE 0 C, ;                                                   : ?[[ ( вхиле)  ?[ SWAP ;                                                         : ]?  ( тхен)   HERE OVER C@  иф SWAP !   елсе OVER 1+ - RANGE? SWAP C! тхен ;                                             : ][  ( елсе)   HERE 1+   1 JMP           SWAP HERE OVER 1+ - RANGE?  SWAP C! ;                                            : ]]  ( агаин)  JMP ;                                                             : ]]? ( репеат) JMP ]? ;                                                                                                                                           \ аSSEMBLER CONDITIONALS       20OCT87RE                                          $90 цONSTANT цс     $б0 цONSTANT цц      $д0 цONSTANT 0=     $ф0 цONSTANT 0<>     $10 цONSTANT 0<     $30 цONSTANT 0>=     $50 цONSTANT жс     $70 цONSTANT жц                                               : NOT    $20 [ фORTH ] XOR ;                                                      : BEQ    0<> ?] ;   : BMI   0>= ?] ;     : BNE    0=  ?] ;   : BPL   0<  ?] ;     : BCC    цс  ?] ;   : BVC   жс  ?] ;     : BCS    цц  ?] ;   : BVS   жц  ?] ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ 2INC/2DEC   WINC/WDEC        20OCT87RE                                          : 2INC  ( ADR -- )                        DUP LDA  CLC  2 # ADC                    DUP STA  цс ?[  SWAP 1+ INC  ]?  ;                                               : 2DEC  ( ADR -- )                        DUP LDA  SEC  2 # SBC                    DUP STA  цц ?[  SWAP 1+ DEC  ]?  ;                                               : WINC  ( ADR -- )                        DUP INC  0= ?[  SWAP 1+ INC  ]?  ;                                               : WDEC  ( ADR -- )                        DUP LDA  0= ?[  OVER 1+ DEC  ]?  DEC  ;                                          : ;C:                                     RECOVER JSR  END-CODE ]  0 LAST !  0 ;                                                                                                                                                                                                                                                                                                \ ;CODE цODE CODE>          BP/RE03FEB85                                          оNLYFORTH                                                                         : аSSEMBLER                               аSSEMBLER   [ аSSEMBLER ] MEM ;                                                  : ;цODE                                   [COMPILE] дOES>  -3 ALLOT                [COMPILE] ;      -2 ALLOT   аSSEMBLER ; IMMEDIATE                                                                         : цODE  цREATE HERE DUP 2- ! аSSEMBLER ;                                          : >LABEL  ( ADR -)                        HERE э цREATE  IMMEDIATE  SWAP ,         4 HALLOT HEAP 1 AND HALLOT ( 6502-ALIG)  HERE 4 - HEAP  4  CMOVE                  HEAP LAST @ COUNT $1ф AND + !  DP !       дOES>  ( - ADR)   @                      STATE @ иф  [COMPILE] лITERAL  тхен ;                                           : лABEL                                   [ аSSEMBLER ]  HERE >LABEL аSSEMBLER ;                                          KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK\ TEST-INCLUDE                 10SEP94PZ                                          : O1 8 2 BUSOPEN " IO.C,S,R" COUNT         BUSTYPE BUSOFF ;                                                                : O2 8 3 BUSOPEN " BASELIB.H,S,R" COUNT    BUSTYPE BUSOFF ;                                                                : C1 8 2 BUSCLOSE ;                      : C2 8 3 BUSCLOSE ;                                                               : T1  8 2 BUSIN 0 ?до BUS@ CON! лооп           BUSOFF ;                                                                    : T2  8 3 BUSIN 0 ?до BUS@ CON! лооп           BUSOFF ;                                                                                                                                                                                                                                                                                                                                                                                                           KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK