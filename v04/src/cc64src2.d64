\ COMPILER (2)                 24AUG94PZ                                          .                  0                     ..                 0                                                              LOADSCREEN        &2                                                              UNRAVEL           &5                     CODEGEN          &12                     PARSER           &48                     INVOKE          &100                     PASS2           &108                     SHELL           &126                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ MEMORY SETTINGS              03SEP94PZ                                            SAVE                                     $CBD0 SET-HIMEM                          $C000 ' LIMIT >BODY !                    1024 1024 SET-STACKS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ DEVELOPMENT LOADSCREEN 2     24AUG94PZ                                            ONLYFORTH  DECIMAL                     \ : Ü ;   ( )                              COMPILER ALSO DEFINITIONS                                                         ^ CODEGEN         LOAD                   ^ PARSER          LOAD                   ^ PASS2           LOAD                   ^ INVOKE          LOAD                                                            ONLYFORTH                              Þ VOCABULARY SHELL                         COMPILER ALSO  SHELL DEFINITIONS                                                  ^ SHELL           LOAD                                                                                                                                                                                                                                                                                                                                                                                                 \ TESTING LOADSCREEN 2         13SEP94PZ                                            ONLYFORTH  DECIMAL                       COMPILER ALSO DEFINITIONS                 BLK/DRV  ERR-BLK ! \ FOR *COMPILER*                                            \NEEDS Þ  Ü : Þ   ;                      \NEEDS .BLK : .BLK ( -)  BLK @ ?DUP  (   \ ) ÉÆ  ."  ÂLK " U. ?CR  ÔÈÅÎ ;                                                  ' .BLK ÉS .STATUS                                                                    12 LOAD \     CODEGEN                    48 LOAD \     PARSER                    108 LOAD \     PASS2                     100 LOAD \     INVOKE                      8 LOAD \     SAVESYSTEM                                                       Þ ONLYFORTH   VOCABULARY SHELL             COMPILER ALSO  SHELL DEFINITIONS                                                  126 LOAD \     SHELL                                                              ONLYFORTH    5 LOAD                                                            \ ENDCOMPILE LOADSCREEN 2      20SEP94PZ                                            ONLYFORTH  DECIMAL  CR                   COMPILER ALSO DEFINITIONS                                                          BLK/DRV  ERR-BLK ! \ FOR *COMPILER*                                               12 LOAD \     CODEGEN                    48 LOAD \     PARSER                    108 LOAD \     PASS2                     100 LOAD \     INVOKE                      8 LOAD \     SAVESYSTEM                                                         ONLYFORTH                                VOCABULARY SHELL                         COMPILER ALSO  SHELL DEFINITIONS                                                  126 LOAD \     SHELL                                                              ONLYFORTH                                                                         ' NOOP IS .STATUS                                                                                                                                                \ UNRAVEL                      20AUG94PZ                                            : UNRAVEL RDROP RDROP RDROP                 CR ." TRACE DUMP ON ABORT IS :" CR       ÂÅÇÉÎ RP@ R0 @ - ×ÈÉÌÅ                    R> DUP 8 U.R SPACE                       2- @ >NAME .NAME CR ÒÅÐÅÁÔ              (ERROR ;                                                                        ' UNRAVEL  ERRORHANDLER !                                                                                               \\ VERWENDUNG:                                                                       ' UNRAVEL  ERRORHANDLER !                                                                                               \\ ABSCHALTEN:                                                                       ' (ERROR   ERRORHANDLER !                                                                                                                                                                                                                         \ KLEINKRAM                    14MAR91PZ                                            : ? @ . ;                                : _ NEXTWORD WORD. ;                     : ID? ID-BUF COUNT TYPE ;                : TY. ( TYPE -- )                           %REFERENCE IS? ÉÆ ." R " ÔÈÅÎ            %POINTER   IS? ÉÆ ." P " ÔÈÅÎ            %FUNCTION  IS? ÉÆ ." F " ÔÈÅÎ            %OFFSET    IS? ÉÆ ." O " ÔÈÅÎ            %STDFCTN   IS? ÉÆ ." S " ÔÈÅÎ            %EXTERN    IS? ÉÆ ." E " ÔÈÅÎ            %PROTO     IS? ÉÆ ." T " ÔÈÅÎ            IS-INT? ÉÆ ." INT " ÅÌÓÅ ." CHAR "               ÔÈÅÎ                            U. ;                                   VARIABLE #L                              : DUMPLIST ( LIST -- )  #L OFF              ÂÅÇÉÎ @ ?DUP ×ÈÉÌÅ DUP U. ." : "         DUP 2+ DUP @ U. 2+ @ U. CR 1 #L +!       ÒÅÐÅÁÔ ." LENGTH:" #L @ U. ;          : INIT-VAR $8000 >STATICADR                         TOS-OFFS OFF                             1 >PC ! ;                     INIT: INIT-VAR                        \ TESTSEQUENZ                  09APR94PZ                                          []INIT'D OFF                             #INITS OFF                               INITIALIZER                              CR []INIT'D ?                            #INITS ?                                 CR .S                                    CLEARSTACK                               _                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ SAVESYSTEM                   03SEP94PZ                                          \NEEDS SAVESYSTEM (                      \\ )                                                                              Ü : (SAVSYS ( ADR LEN -- )                [ ÁSSEMBLER ] ÎEXT  [ ÆORTH ]            ['] PAUSE  DUP PUSH  !  \ SINGLETASK     I/O PUSH  I/O OFF  BUSTYPE ;                                                     Þ : SAVESYSTEM   \ NAME MUSS FOLGEN       SAVE  DEV 2 BUSOPEN  0 PARSE BUSTYPE     " ,P,W" COUNT BUSTYPE  BUSOFF            DEV 2 BUSOUT  ORIGIN $17 -               DUP  $100 U/MOD  SWAP BUS! BUS!          HERE OVER - (SAVSYS  BUSOFF              DEV 2 BUSCLOSE                           0 (DRV ! DERROR? ABORT" SAVE-ERROR" ;                                                                                                                                                                                                                                                                                                                                01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ CODEGEN LOADSCREEN           21SEP94PZ                                                                                     .( MODULE CODEGEN )                                                               1 25 +THRU                                                                        CR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ CODEGEN: OBJECTS             13JAN91PZ                                          \ AN OBJECT IS 8 OR 16 BIT NUMERICAL     \ VALUE ON THE RUNTIME-STACK.            \ AT COMPILE TIME IT IS REPRESENTED BY   \ A 16 BIT DESCIPTOR AND A 16 BIT        \ VALUE  ( OBJ ) = ( VAL DESC ).                                                  \ THE DESCRIPTOR CONSTISTS OF DATA TYPE                                           Ü 1 CONSTANT %INT                                                                 \ AND OBJECT TYPE                                                                 Þ  $100 CONSTANT %REFERENCE \ PROVIDED   Þ  $200 CONSTANT %POINTER   \ BY THE     Þ  $400 CONSTANT %FUNCTION  \ SYMBOL     Þ  $800 CONSTANT %OFFSET    \ TABLE      Þ $1000 CONSTANT %STDFCTN   \            Þ $2000 CONSTANT %EXTERN    \            Þ $4000 CONSTANT %PROTO                                                           Ü $8000 CONSTANT %CONSTANT  \ GENERATED  \ INTERNALLY FOR OPTIMIZATION.                                                   \   CODEGEN: OBJECTS           26SEP90PZ                                          \  HANDLE DATA TYPE                      Þ : SET-CHAR     %INT NOT AND ;          Þ : SET-INT      %INT OR ;                    ( N1 -- N2 )                                                                 Þ : IS-CHAR?     DUP %INT AND 0= ;       Þ : IS-INT?      IS-CHAR? 0= ;                ( N -- N FLAG )                                                              \  HANDLE OBJECT TYPE                    Þ : SET          OR ;                    Þ : CLR          NOT AND ;                    ( N1 MASK -- N2 )                                                            Þ : IS?          2DUP XOR AND 0= ;       Þ : ISN'T?       OVER AND 0= ;                ( N MASK -- N FLAG )                     ( FLAG = TRUE <=> ALLE GESETZTEN           MASK-BITS IN N GESETZT BZW.              GELOESCHT )                                                                                                                                                 \   CODEGEN: OBJECTS           11MAR91PZ                                          Ü : SIZE? ( OBJ -- OBJ SIZE )                 %POINTER %FUNCTION + ISN'T? >R           IS-CHAR? R> AND 2+ ;                                                         \ SIZE? UND .SIZE MACHEN NUR BEI         \ %REFERENCE-OBJEKTEN SINN !                                                                                               Þ 0 SET-INT  CONSTANT %DEFAULT             ( DEFAULT DATA TYPE, E.G TYPE OF           A MULTIPICATION'S RESULT )                                                      0 SET-INT %REFERENCE %EXTERN + SET     Þ CONSTANT %GLOBAL                         0 SET-INT %REFERENCE %OFFSET + SET     Þ CONSTANT %LOCAL                          ( DEFAULT DEFINITION TYPES )                                                    Þ $0701 CONSTANT %COND.MASK              Þ $9F01 CONSTANT %EXPR.MASK              Þ $3F01 CONSTANT %DECL.MASK                ( MASKS FOR TYPE COMPARISONS )                                                 \ CODEGEN: REFERENCE/VALUE     26SEP90PZ                                          Ü DEFER 'VALUE      ( OBJ1 -- OBJ2 )                                              Ü : VALUE ( OBJ1 -- OBJ2 )                  %REFERENCE IS?                              ÉÆ 'VALUE  %REFERENCE CLR                %FUNCTION %POINTER + ISN'T?                 ÉÆ SET-INT ÔÈÅÎ ÔÈÅÎ ;                                                   Ü : REFERENCE ( OBJ1 -- OBJ2 )              %REFERENCE IS?                              ÉÆ %REFERENCE CLR                        ÅÌÓÅ *NOREF* ERROR ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ CODEGEN: CONSTANT, DOIT      18APR94PZ                                          Ü VARIABLE A-USED                                                                 Ü : REQUIRE-ACCU                              A-USED @ ÉÆ .PHA' ÔÈÅÎ                   A-USED ON ;                                                                  Þ : RELEASE-ACCU                              A-USED OFF ;                                                                 Ü : NON-CONSTANT ( OBJ1 -- OBJ2 )             %CONSTANT IS?  ÉÆ %CONSTANT CLR            REQUIRE-ACCU  OVER .LDA# ÔÈÅÎ ;                                               INIT: RELEASE-ACCU                                                                                                      Ü VARIABLE VECTOR                                                                 Ü : DOIT ( N -- )                             VECTOR @ + PERFORM ;                  ( FOR UNOP, INCOP AND DO-BINOP, WHO        ALL USE VECTORS )                                                            \ CODEGEN: COMBINED TYPE TESTS 01MAR91PZ                                          Ü : POINTER? ( TYPE -- TYPE FLAG )            %POINTER IS? >R %FUNCTION ISN'T?         R> AND ;                              ( FOR DO-ADD AND DO-SUB )                                                       Ü : INT-POINTER? ( TYPE -- TYPE FLAG )        POINTER? >R IS-INT? R> AND ;          ( FOR INCOP )                            ( BOTH FOR POINTER SCALING )                                                    Ü : ARRAY? ( TYPE -- TYPE FLAG )              %REFERENCE %FUNCTION + ISN'T? >R         %POINTER IS? R> AND ;                 ( FOR DEFINITIONS )                                                             Ü : FUNCTION? ( TYPE -- TYPE FLAG )           %FUNCTION IS? >R %REFERENCE ISN'T?       R> AND ;                              ( FOR PREPARE-CALL AND DEFINITIONS )                                                                                                                                                                      \ CODEGEN: ATOM                18APR94PZ                                          Ü : DO-NUMATOM ( VAL -- OBJ )                 [ %DEFAULT  %CONSTANT SET ]              LITERAL ;                                                                    Ü : DO-STRINGATOM ( ADR -- OBJ )              REQUIRE-ACCU  .LDA#                      [ %DEFAULT %POINTER SET SET-CHAR ]       0  LITERAL ;                                                                                                          Ü : DO-LDA(A) ( OBJ1 -- OBJ2 )                SIZE? .SIZE                              %CONSTANT IS?                               ÉÆ   REQUIRE-ACCU                        OVER .LDA.S  %CONSTANT CLR               ÅÌÓÅ .STA-ZP .LDA.S(ZP) ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                 \   CODEGEN: ATOM              27MAY91PZ                                          Ü : DO-LDA(BASE),# ( OBJ1 -- OBJ2 )           %OFFSET ISN'T? *COMPILER* ?FATAL         REQUIRE-ACCU  SIZE? .SIZE                OVER .LDA.S(BASE),#                      %OFFSET CLR ;                                                                Ü : DO-IDATOM ( NAME -- OBJ )                 DUP FINDLOCAL ?DUP                          ÉÆ NIP                                   ÅÌÓÅ FINDGLOBAL ?DUP 0=                     ÉÆ *UNDEF* ERROR                         0 DO-NUMATOM EXIT ÔÈÅÎ                ÔÈÅÎ 2@                               %EXPR.MASK AND                           %OFFSET ISN'T?                              ÉÆ ['] DO-LDA(A)  ÉÓ 'VALUE              %CONSTANT SET  EXIT ÔÈÅÎ              %REFERENCE IS?                              ÉÆ ['] DO-LDA(BASE),# ÉÓ 'VALUE          ÅÌÓÅ REQUIRE-ACCU  .LDA-BASE             OVER .ADD#  %OFFSET CLR ÔÈÅÎ ;                                                                                    \ CODEGEN: PRIMARY             22AUG94PZ                                          Ü : PUT-STD-ARGUMENT ( OBJ -- )               VALUE NON-CONSTANT 2DROP ;                                                   Ü : DROP-STD-ARGUMENT ( OBJ -- )              VALUE NON-CONSTANT 2DROP .PLA ;                                              Ü : DO-STD-CALL ( OBJ1 -- OBJ2 )              %STDFCTN %CONSTANT + CLR                 OVER .JSR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \   CODEGEN: PRIMARY           27MAY91PZ                                          Ü : PREPARE-CALL ( OBJ1 -- OBJ2 ARGS )        FUNCTION? NOT *NOFUNC* ?ERROR            VALUE 0 ;                                                                    Ü : PUT-ARGUMENT  ( ARGS OBJ -- ARGS' )       VALUE  NON-CONSTANT  2DROP               2 .SIZE                                  2 DYN-ALLOT .STA.S(BASE),#               RELEASE-ACCU  2- ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \   CODEGEN: PRIMARY           27MAY91PZ                                          Ü : DO-CALL ( OBJ2 ARGS -- OBJ3 )             DYN-ALLOT TOS-OFFS @ - 2/ >R             %CONSTANT ISN'T?                         ÉÆ .STA-ZP ÅÌÓÅ REQUIRE-ACCU ÔÈÅÎ        TOS-OFFS @ .LINK#                        R> .ARGS                                 %CONSTANT IS?                               ÉÆ OVER .JSR                             ÅÌÓÅ .JSR(ZP) ÔÈÅÎ                    TOS-OFFS @ NEGATE .LINK#                 %CONSTANT %FUNCTION + CLR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \   CODEGEN: PRIMARY           23FEB91PZ                                          Ü : DO-POINTER ( OBJ1 -- OBJ2 )             %REFERENCE IS? >R  VALUE                 %FUNCTION IS?                               ÉÆ R>                                       ÉÆ %REFERENCE CLR                        ÅÌÓÅ DROP %DEFAULT                       *NOVECTOR* ERROR ÔÈÅÎ                 ÅÌÓÅ RDROP  %POINTER ISN'T?                 *NOPTR* ?ERROR                        %POINTER CLR  %REFERENCE SET             ['] DO-LDA(A) ÉÓ 'VALUE                  ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ CODEGEN: UNARY               27MAY91PZ                                          Ü : DO-ADRESS ( OBJ1 -- OBJ2 )              REFERENCE                                %OFFSET IS?                                 ÉÆ REQUIRE-ACCU                          .LDA-BASE  OVER .ADD#                    %OFFSET CLR ÔÈÅÎ                      SIZE? 1- ÉÆ SET-INT ÔÈÅÎ                 %POINTER SET  %FUNCTION CLR ;                                                                                           Ü : UNOP ( CFA2 CFA0 -- )                     CREATE , ,                              DOES> ( OBJ1 PFA -- OBJ2 ) VECTOR !       VALUE  %CONSTANT IS? NIP                    ÉÆ 2 DOIT                                %DEFAULT  %CONSTANT SET                  ÅÌÓÅ 0 DOIT %DEFAULT ÔÈÅÎ ;                                               Ü ' NEGATE  ' .NEG  UNOP DO-NEG          Ü ' 0=      ' .NOT  UNOP DO-NOT          Ü ' NOT     ' .INV  UNOP DO-INV                                                                                           \   CODEGEN: UNARY             18APR94PZ                                          Ü : INCOP ( CFA6 CFA4 CFA2 CFA0 -- )          CREATE , , , ,                          DOES> ( OBJ1 PFA -- OBJ2 ) VECTOR !       REFERENCE  SIZE? .SIZE                   %CONSTANT IS?                               ÉÆ %CONSTANT CLR  REQUIRE-ACCU           INT-POINTER? 2 AND DOIT               ÅÌÓÅ %OFFSET IS?                            ÉÆ %OFFSET CLR  REQUIRE-ACCU             INT-POINTER? 1 AND 1+                    2 PICK  DUP .LDA.S(BASE),#               SWAP  6 DOIT                          ÅÌÓÅ .STA-ZP  .LDA.S(ZP)                    INT-POINTER? 1 AND 1+  4 DOIT         ÔÈÅÎ ÔÈÅÎ                                %FUNCTION IS?                               ÉÆ DROP %DEFAULT ÔÈÅÎ ;                                                   \\ THE COMPLICATIONS ARE DUE TO THE         DIFFERENT ADRESSING MODES AND TO         THE SCALING OF POINTERS.                                                                                               \   CODEGEN: UNARY             27MAY91PZ                                          Ü : ++X0 OVER DUP .INCR.S   .LDA.S ;     Ü : ++X2 OVER DUP .2INCR.S  .LDA.S ;     Ü : ++X4 .ADD#  .STA.S(ZP) ;             Ü : ++X6 .ADD#  .STA.S(BASE),# ;                                                  Ü : --X0 OVER DUP .DECR.S   .LDA.S ;     Ü : --X2 OVER DUP .2DECR.S  .LDA.S ;     Ü : --X4 .SUB#  .STA.S(ZP) ;             Ü : --X6 .SUB#  .STA.S(BASE),# ;                                                  Ü : X++0 OVER DUP .LDA.S  .INCR.S ;      Ü : X++2 OVER DUP .LDA.S  .2INCR.S ;     Ü : X++4 .PHA .ADD#  .STA.S(ZP) .PLA ;   Ü : X++6 .PHA .ADD#  .STA.S(BASE),#                                      .PLA ;                                            Ü : X--0 OVER DUP .LDA.S  .DECR.S ;      Ü : X--2 OVER DUP .LDA.S  .2DECR.S ;     Ü : X--4 .PHA .SUB#  .STA.S(ZP) .PLA ;   Ü : X--6 .PHA .SUB#  .STA.S(BASE),#                                      .PLA ;                                                                                    \   CODEGEN: UNARY             27SEP90PZ                                             ' ++X6 ' ++X4 ' ++X2 ' ++X0           Ü INCOP DO-PREINC                                                                    ' --X6 ' --X4 ' --X2 ' --X0           Ü INCOP DO-PREDEC                                                                    ' X++6 ' X++4 ' X++2 ' X++0           Ü INCOP DO-POSTINC                                                                   ' X--6 ' X--4 ' X--2 ' X--0           Ü INCOP DO-POSTDEC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ CODEGEN: BINARY              11SEP94PZ                                          Ü VARIABLE TYP                                                                    Ü : SETCONST ( -- )                           TYP @  %CONSTANT SET  TYP ! ;                                                    ' SETCONST ' SWAP ' NOOP ' DROP      Ü CREATE CONST-VEC    , , , ,                                                     Ü : DO-BINOP ( OBJ1 OBJ2 VEC -- OBJ3 )        VECTOR !                                 %CONSTANT IS? 2 AND >R DROP  SWAP        %CONSTANT IS? 4 AND R> OR >R DROP        CONST-VEC R@ + PERFORM                   R> DOIT  TYP @ ;                                                                                                                                                                                                                                                                                                                                                                                                    \   CODEGEN: BINARY            11SEP94PZ                                          Ü : DO-SHLA  ( OBJ1 -- OBJ2 )                 %CONSTANT IS?                             ÉÆ SWAP 2* SWAP ÅÌÓÅ .SHLA ÔÈÅÎ ;                                           Ü : DO-SHRA  ( OBJ1 -- OBJ2 )                 %CONSTANT IS?                             ÉÆ SWAP 2/ SWAP ÅÌÓÅ .SHRA ÔÈÅÎ ;                                           Ü CREATE ADD-VEC                           ' + ' .ADD# ' .ADD# ' .ADD , , , ,                                              Ü : DO-ADD ( OBJ1 OBJ2 -- OBJ3 )              2SWAP POINTER?                              ÉÆ DUP %CONSTANT CLR TYP !               IS-INT? >R  2SWAP R>                        ÉÆ DO-SHLA ÔÈÅÎ                       ÅÌÓÅ %DEFAULT TYP ! ÔÈÅÎ              ADD-VEC DO-BINOP ;                                                           \\ COMPLICATIONS ARE DUE TO POINTER         SCALING.                                                                                                               \   CODEGEN: BINARY            11SEP94PZ                                          Ü VARIABLE SHRA-FLAG                     Ü CREATE SUB-VEC                           ' - ' .#SUB ' .SUB# ' .SUB , , , ,                                              Ü : DO-SUB ( OBJ1 OBJ2 -- OBJ3 )              SHRA-FLAG OFF  %DEFAULT TYP !            2SWAP POINTER?                              ÉÆ DUP >R 2SWAP POINTER?                    ÉÆ IS-INT? R> IS-INT?                    NIP AND                                     ÉÆ SHRA-FLAG ON ÔÈÅÎ                  ÅÌÓÅ R> IS-INT?                          SWAP %CONSTANT CLR  TYP !                   ÉÆ DO-SHLA ÔÈÅÎ                       ÔÈÅÎ                                  ÅÌÓÅ 2SWAP ÔÈÅÎ                       SUB-VEC DO-BINOP                         SHRA-FLAG @ ÉÆ DO-SHRA ÔÈÅÎ ;                                                \\ COMPLICATIONS ARE DUE TO POINTER         SCALING.                                                                                                               \   CODEGEN: BINARY            12SEP90PZ                                          Ü : BINOP ( CFA3 CFA2 CFA1 CFA0 -- )          CREATE , , , ,                          DOES>   ( OBJ1 OBJ2 VEC -- OBJ3 )         %DEFAULT TYP !  DO-BINOP ;                                                      ' * ' .MULT# ' .MULT# ' .MULT         Ü BINOP DO-MULT                             ' / ' .#DIV ' .DIV# ' .DIV            Ü BINOP DO-DIV                              ' MOD ' .#MOD ' .MOD# ' .MOD          Ü BINOP DO-MOD                              ' AND ' .AND# ' .AND# ' .AND          Ü BINOP DO-AND                              ' XOR ' .XOR# ' .XOR# ' .XOR          Ü BINOP DO-XOR                              ' OR ' .OR# ' .OR# ' .OR              Ü BINOP DO-OR                                                                                                                                                                                                                                                                                 \   CODEGEN: BINARY            03SEP94PZ                                          \ > UND < SOLLTEN 0 ODER -1 ERGEBEN !                                             Þ : <=  SWAP > ;                         Þ : >=  SWAP < ;                         Þ : !=  = 0= ;                                                                       ' < ' .GT# ' .LT# ' .LT               Ü BINOP DO-LT                               ' > ' .LT# ' .GT# ' .GT               Ü BINOP DO-GT                               ' <= ' .GE# ' .LE# ' .LE              Ü BINOP DO-LE                               ' >= ' .LE# ' .GE# ' .GE              Ü BINOP DO-GE                               ' = ' .EQ# ' .EQ# ' .EQ               Ü BINOP DO-EQ                               ' != ' .NE# ' .NE# ' .NE              Ü BINOP DO-NE                                                                                                                                                                                                                                        \   CODEGEN: BINARY            27SEP90PZ                                          Þ : << ( N1 N2 -- N3 )                        0 ?ÄÏ 2* ÌÏÏÐ ;                     Þ : >> ( N1 N2 -- N3 )                        0 ?ÄÏ 2/ ÌÏÏÐ ;                                                                 ' << ' .#SHL ' .SHL# ' .SHL           Ü BINOP DO-SHL                              ' >> ' .#SHR ' .SHR# ' .SHR           Ü BINOP DO-SHR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   CODEGEN: BINARY            22FEB91PZ                                          Ü : DO-L-AND.1 ( OBJ -- ADR )                 VALUE NON-CONSTANT  2DROP                .JMZ-AHEAD                               RELEASE-ACCU ;                                                               Ü : DO-L-AND.2 ( ADR OBJ1 -- OBJ2 )           VALUE NON-CONSTANT  2DROP                .RESOLVE-JMP                             0 %DEFAULT ;                                                                 Ü : DO-L-OR.1 ( OBJ -- )                      VALUE NON-CONSTANT  2DROP                .JMN-AHEAD                               RELEASE-ACCU ;                                                               Ü ' DO-L-AND.2 ÁÌÉÁÓ DO-L-OR.2                                                                                                                                                                                                                                                                                                         \   CODEGEN: CONDITIONAL       22FEB91PZ                                          Ü : IS0? ( OBJ -- OBJ FLAG )                  %CONSTANT IS? >R OVER 0= R> AND ;                                            Ü : DO-COND1 ( OBJ1 -- ADR1 )                 VALUE NON-CONSTANT                       2DROP  RELEASE-ACCU                      .JMZ-AHEAD ;                                                                 Ü : DO-COND2 ( ADR1 OBJ2 -- OBJ' ADR2 )       VALUE IS0? -ROT NON-CONSTANT NIP         ROT .JMP-AHEAD SWAP .RESOLVE-JMP         RELEASE-ACCU ;                                                               Ü : DO-COND3 ( OBJ' ADR2 OBJ3 -- OBJ )        VALUE IS0? -ROT NON-CONSTANT NIP         ROT .RESOLVE-JMP                         2 PICK OVER XOR %COND.MASK AND 0=           ÉÆ 2DROP EXIT ÔÈÅÎ                    OVER   ÉÆ 2DROP EXIT ÔÈÅÎ                3 PICK ÉÆ NIP NIP EXIT ÔÈÅÎ              2DROP DROP %DEFAULT                      *!=TYPE* ERROR ;                                                            \   CODEGEN: ASSIGN            27MAY91PZ                                          Ü : PREPARE-ASGNOP ( OBJ1 -- OBJ2 OBJ3 )      REFERENCE                                %CONSTANT %OFFSET + ISN'T?                  ÉÆ .PHA ÔÈÅÎ                          2DUP %REFERENCE SET  VALUE ;                                                 Ü : PREPARE-ASSIGN ( OBJ1 -- OBJ2 )           REFERENCE ;                                                                  Ü : DO-ASSIGN ( OBJ1 OBJ2 -- OBJ1 )           ( VALUE ) NON-CONSTANT  2DROP            ( 'OBJ2' IS ALWAYS 'VALUE' )             SIZE? DUP .SIZE  1 =                        ÉÆ .AND#255 ÔÈÅÎ                      %CONSTANT IS?                               ÉÆ %CONSTANT CLR                         OVER .STA.S                              ÅÌÓÅ %OFFSET IS?                            ÉÆ %OFFSET CLR                           OVER .STA.S(BASE),#                      ÅÌÓÅ .POP-ZP .STA.S(ZP) ÔÈÅÎ          ÔÈÅÎ ;                                                                                                  01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       01MAR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ PARSER LOADSCREEN            21SEP94PZ                                            .( MODULE PARSER: ) CR                                                          Ü : TESTSTACK  ( -- )                         HERE $80 + SP@ U> *STACK* ?FATAL         UP@ UDP @ + $40 + RP@ U>                                  *RSTACK* ?FATAL ;                                             .( SUBMODULE EXPRESSION )                1 13 +THRU  CR   \ EXPRESSION                                                     .( SUBMODULE STATEMENT )                14 24 +THRU  CR   \ STATEMENT                                                      .( SUBMODULE DEFINITION )               25 48 +THRU  CR   \ DEFINITION                                                                                                                                                                                                                                                                                                                                                 \ PARSER: TOOLS                22FEB91PZ                                          Ü : COMES? ( WORD WORDTYPE -- FLAG )         NEXTWORD DNEGATE D+ OR                   ÉÆ BACKWORD FALSE ÅÌÓÅ TRUE ÔÈÅÎ ;                                            Ü : COMES-A? ( WORDTYPE -- WORD TRUE )                ( WORDTYPE -- FALSE )           NEXTWORD ROT = DUP NOT                   ÉÆ NIP BACKWORD ÔÈÅÎ ;                                                        Ü : EXPECT ( WORD WORDTYPE -- )              2DUP COMES?                                 ÉÆ 2DROP                                 ÅÌÓÅ *EXPECTED* ERROR WORD.              ÔÈÅÎ ;                                                                     \ : SKIPWORD ( -- )                      \    *IGNORED* ERROR NEXTWORD WORD. ;                                                                                                                                                                                                                                                         \ PARSER: ATOM                 13SEP94PZ                                          Ü : CP$[ ( -- JMP ADR )                       .JMP-AHEAD  .LABEL ;                                                         Ü : CP]$ ( JMP ADR -- ADR )                   SWAP .RESOLVE-JMP ;                                                          Þ DO$: COMPILE$  ( -- ADR )                      CP$[ .BYTE CP]$ ;                                                                                                  Ü : ATOM ( -- OBJ )                         #NUMBER# COMES-A?                           ÉÆ DO-NUMATOM  EXIT ÔÈÅÎ              #ID#     COMES-A?                           ÉÆ DO-IDATOM   EXIT ÔÈÅÎ              #STRING# COMES-A?                           ÉÆ DROP COMPILE$                         DO-STRINGATOM  EXIT ÔÈÅÎ              ." A VALUE" *EXPECTED* ERROR             0 DO-NUMATOM ;                                                                                                                                                  \ PARSER: PRIMARY              15MAR91PZ                                          Ü DOER EXPRESSION                        Ü DOER ASSIGN                                                                     Ü : PRIMARY[] ( OBJ1 -- OBJ2 )              VALUE                                    EXPRESSION VALUE  DO-ADD                 DO-POINTER                               ASCII ] #CHAR# EXPECT ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   PARSER: PRIMARY            22FEB91PZ                                          Ü : STD-ARGUMENTS ( -- )                      ASSIGN PUT-STD-ARGUMENT                  ÂÅÇÉÎ ASCII , #CHAR# COMES? ×ÈÉÌÅ        ASSIGN DROP-STD-ARGUMENT ÒÅÐÅÁÔ ;                                            Ü : ARGUMENTS  ( -- )                         ÂÅÇÉÎ ASSIGN PUT-ARGUMENT                ASCII , #CHAR# COMES? NOT ÕÎÔÉÌ ;                                            Ü : PRIMARY() ( OBJ1 -- OBJ2 )                %STDFCTN IS?                                ÉÆ ASCII ) #CHAR# COMES?                    ÉÆ 0 DO-NUMATOM                          ÅÌÓÅ STD-ARGUMENTS                       ASCII ) #CHAR# EXPECT ÔÈÅÎ            DO-STD-CALL                              ÅÌÓÅ PREPARE-CALL                        ASCII ) #CHAR# COMES? NOT                   ÉÆ ARGUMENTS                             ASCII ) #CHAR# EXPECT ÔÈÅÎ            DO-CALL ÔÈÅÎ ;                                                                                                    \   PARSER: PRIMARY            11SEP94PZ                                          Ü : PRIMARY ( -- OBJ )                        TESTSTACK                                ASCII ( #CHAR# COMES?                       ÉÆ EXPRESSION                            ASCII ) #CHAR# EXPECT                    ÅÌÓÅ ATOM ÔÈÅÎ                        ÂÅÇÉÎ MARK >R                            ASCII ( #CHAR# COMES?                       ÉÆ PRIMARY() ÔÈÅÎ                     %STDFCTN IS?                                ÉÆ DROP %DEFAULT ÔÈÅÎ                 ASCII [ #CHAR# COMES?                       ÉÆ PRIMARY[] ÔÈÅÎ                     R> ADVANCED? NOT ÕÎÔÉÌ ;                                                                                                                                                                                                                                                                                                                                                                                            \ PARSER: UNARY                22FEB91PZ                                          Ü : UNARY ( -- OBJ )  RECURSIVE                                                      #OPER# COMES-A? ÉÆ                        <-> CASE? ÉÆ UNARY DO-NEG EXIT ÔÈÅÎ      <!> CASE? ÉÆ UNARY DO-NOT EXIT ÔÈÅÎ      <INV> CASE?                                    ÉÆ UNARY DO-INV     EXIT ÔÈÅÎ      <*> CASE?                                      ÉÆ UNARY DO-POINTER EXIT ÔÈÅÎ      <AND> CASE?                                    ÉÆ UNARY DO-ADRESS  EXIT ÔÈÅÎ      <++> CASE?                                     ÉÆ UNARY DO-PREINC  EXIT ÔÈÅÎ      <--> CASE?                                     ÉÆ UNARY DO-PREDEC  EXIT ÔÈÅÎ      DROP  BACKWORD ÔÈÅÎ                     PRIMARY                                  #OPER# COMES-A? ÉÆ                        <++> CASE? ÉÆ DO-POSTINC  EXIT ÔÈÅÎ      <--> CASE? ÉÆ DO-POSTDEC  EXIT ÔÈÅÎ      DROP  BACKWORD ÔÈÅÎ ;                                                                                                 \ PARSER: BINARY               06MAR91PZ                                          Ü : COMES-OP? ( TAB -- CFA TRUE )                      ( TAB -- FALSE )                #OPER# COMES-A?                             ÉÆ SWAP  DUP 2+ SWAP @ BOUNDS            ÄÏ DUP É @ =                               ÉÆ DROP  É 2+ @  TRUE                    ÕÎÌÏÏÐ EXIT ÔÈÅÎ                       4 +ÌÏÏÐ                                  BACKWORD ÔÈÅÎ                         DROP  FALSE ;                                                                Ü : BINARY  ( TAB -- )                       CREATE , DUP 4 * ,  0                     ÄÏ SWAP , , ÌÏÏÐ                        DOES>   ( TAB -- OBJ )                    DUP @ EXECUTE                            ÂÅÇÉÎ 2 PICK 2+ COMES-OP? ×ÈÉÌÅ >R       VALUE  2 PICK @ EXECUTE VALUE            R> EXECUTE ÒÅÐÅÁÔ                        2 ROLL DROP ;                                                                \\ FUER ASSIGN WIRD 'VON HAND' EINE         'COMES-OP?'-TABELLE ANGELEGT !       \   PARSER: BINARY             08APR90PZ                                            <*>   ' DO-MULT                          </>   ' DO-DIV                           <%>   ' DO-MOD                           3  ' UNARY   Ü BINARY PRODUCT                                                     <+>   ' DO-ADD                           <->   ' DO-SUB                           2  ' PRODUCT Ü BINARY SUM                                                         <<<>  ' DO-SHL                           <>>>  ' DO-SHR                           2  ' SUM     Ü BINARY SHIFT                                                       <<>   ' DO-LT                            <<=>  ' DO-LE                            <>>   ' DO-GT                            <>=>  ' DO-GE                            4  ' SHIFT   Ü BINARY COMP                                                        <==>  ' DO-EQ                            <!=>  ' DO-NE                            2  ' COMP    Ü BINARY EQUAL                                                    \   PARSER: BINARY             09OCT90PZ                                            <AND> ' DO-AND                           1  ' EQUAL   Ü BINARY BIT-AND                                                     <XOR> ' DO-XOR                           1  ' BIT-AND Ü BINARY BIT-XOR                                                     <OR>  ' DO-OR                            1  ' BIT-XOR Ü BINARY BIT-OR                                                    Ü : L-AND ( -- OBJ )                          BIT-OR                                   ÂÅÇÉÎ  <L-AND> #OPER# COMES? ×ÈÉÌÅ       DO-L-AND.1  BIT-OR                       DO-L-AND.2  ÒÅÐÅÁÔ ;                                                         Ü : L-OR ( -- OBJ )                           L-AND                                    ÂÅÇÉÎ  <L-OR> #OPER# COMES? ×ÈÉÌÅ        DO-L-OR.1  L-AND                         DO-L-OR.2  ÒÅÐÅÁÔ ;                                                                                                                                           \   PARSER: BINARY             07APR90PZ                                          Ü : CONDITIONAL ( -- OBJ )                    L-OR                                     ASCII ? #CHAR# COMES?                       ÉÆ DO-COND1                              RECURSIVE CONDITIONAL                    DO-COND2                                 ASCII : #CHAR# EXPECT                    RECURSIVE CONDITIONAL                    DO-COND3 ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ PARSER: ASSIGN               06MAR91PZ                                          Ü CREATE ASSIGN-OPER  11  4 * ,            <=>      0          SWAP  , ,            <*=>   ' DO-MULT    SWAP  , ,            </=>   ' DO-DIV     SWAP  , ,            <%=>   ' DO-MOD     SWAP  , ,            <+=>   ' DO-ADD     SWAP  , ,            <-=>   ' DO-SUB     SWAP  , ,            <<<=>  ' DO-SHL     SWAP  , ,            <>>=>  ' DO-SHR     SWAP  , ,            <AND=> ' DO-AND     SWAP  , ,            <XOR=> ' DO-XOR     SWAP  , ,            <OR=>  ' DO-OR      SWAP  , ,                                                   \\ HIER WIRD EINE TABELLE ANGELEGT,         DIE MIT DEM FORMAT DER 'BINARY'-         TABELLEN UEBEREINSTIMMT, ALSO            MIT 'COMES-OP?' DURCHSUCHT WIRD.                                                                                                                                                                                                                                                           \   PARSER: ASSIGN             08APR90PZ                                            MAKE ASSIGN ( -- OBJ )                      CONDITIONAL                              ASSIGN-OPER COMES-OP?                       ÉÆ ?DUP                                     ÉÆ >R  PREPARE-ASGNOP                    RECURSIVE ASSIGN VALUE                   R> EXECUTE                               ÅÌÓÅ PREPARE-ASSIGN                      RECURSIVE ASSIGN VALUE ÔÈÅÎ           DO-ASSIGN ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ PARSER: EXPRESSION           29OCT90PZ                                            MAKE EXPRESSION  ( -- OBJ )               ASSIGN                                   ASCII , #CHAR# COMES?                       ÉÆ VALUE NON-CONSTANT                    ÂÅÇÉÎ 2DROP RELEASE-ACCU                 ASSIGN VALUE NON-CONSTANT                ASCII , #CHAR# COMES? 0= ÕÎÔÉÌ           ÔÈÅÎ ;                                                                                                               Þ : CONSTANT-EXPRESSION ( -- VAL )            ASSIGN VALUE  %CONSTANT ISN'T?           *NOCONST* ?ERROR  DROP ;                                                     Þ : EXPRESSION  ( -- )                        EXPRESSION VALUE NON-CONSTANT            2DROP RELEASE-ACCU ;                                                                                                                                                                                                                                                                     \ PARSER: STATEMENT            12MAR91PZ                                          Þ DOER COMPOUND                          Ü DOER STATEMENT                                                                  Ü : EXPECT';'  ASCII ; #CHAR# EXPECT ;                                            Ü : EXPRESSION-STMT ( -- )                     EXPRESSION  EXPECT';' ;                                                     Ü : RETURN-STMT ( -- )                         ASCII ; #CHAR# COMES? NOT                   ÉÆ EXPRESSION-STMT ÔÈÅÎ               .RTS ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \   PARSER: STATEMENT          22FEB91PZ                                          Ü : (EXPRESSION)  ( -- )                      ASCII ( #CHAR# EXPECT                    EXPRESSION                               ASCII ) #CHAR# EXPECT ;                                                      Ü : IF-STMT  ( -- )                           (EXPRESSION)                             .JMZ-AHEAD                               STATEMENT                                <ELSE> #KEYWORD# COMES?                     ÉÆ .JMP-AHEAD SWAP .RESOLVE-JMP          STATEMENT ÔÈÅÎ                        .RESOLVE-JMP ;                                                                                                                                                                                                                                                                                                                                                                                                                                               \   PARSER: STATEMENT          12MAR91PZ                                          Ü : ?DROP&EXIT ( N FLAG -- N / -- )            ÉÆ DROP RDROP ÔÈÅÎ ;                                                        Ü : NEW  ( LIST -- )                          HEAP> ?DUP 0= ?DROP&EXIT                 DUP 2+ OFF  SWAP HOOK-INTO ;                                                 Ü : RESOLVE  ( LIST -- )                      ÂÅÇÉÎ DUP HOOK-OUT  DUP >HEAP            2+ @ ?DUP ×ÈÉÌÅ                          .RESOLVE-JMP ÒÅÐÅÁÔ DROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   PARSER: STATEMENT          12MAR91PZ                                          Ü VARIABLE BREAKS                        Ü VARIABLE CONTS                                                                  Ü : ANOTHER  ( LIST -- )                      DUP @ 0= ÉÆ *ILL-BRK* ERROR                       DROP EXIT ÔÈÅÎ                  HEAP> ?DUP 0= ?DROP&EXIT                 .JMP-AHEAD OVER 2+ !                     SWAP HOOK-INTO ;                                                             Ü : BREAK-STMT ( -- )                         BREAKS ANOTHER  EXPECT';' ;                                                  Ü : CONTINUE-STMT ( -- )                      CONTS ANOTHER  EXPECT';' ;                                                   Þ : INIT-BREAKS  BREAKS OFF CONTS OFF ;       INIT: INIT-BREAKS                                                                                                                                                                                                                               \   PARSER: STATEMENT          18APR94PZ                                          Ü VARIABLE SWITCH-STATE ( 0/-1/DEF.ADR)  Ü VARIABLE CASES                                                                  Þ : INIT-SWITCH   SWITCH-STATE OFF            CASES OFF ;                             INIT: INIT-SWITCH                                                             Ü : CASE-STMT ( -- )                          CONSTANT-EXPRESSION                      ASCII : #CHAR# EXPECT                    SWITCH-STATE @ 0=   ÉÆ DROP                 *NOSWITCH* ERROR EXIT ÔÈÅÎ            HEAP> ?DUP 0= ?DROP&EXIT                 DUP  CASES HOOK-INTO                     2+ .LABEL OVER !  2+ ! ;                                                     Ü : DEFAULT-STMT ( -- )                       ASCII : #CHAR# EXPECT                    SWITCH-STATE @ 1+                           ÉÆ *ILL-DEFAULT* ERROR                   ÅÌÓÅ .LABEL SWITCH-STATE !               ÔÈÅÎ ;                                                                   \   PARSER: STATEMENT          27MAY91PZ                                          Ü : CASES-RESOLVE ( -- )                      ÂÅÇÉÎ CASES HOOK-OUT  DUP >HEAP          2+ DUP @ ?DUP ×ÈÉÌÅ                      .WORD 2+ @ .WORD ÒÅÐÅÁÔ                  DROP  0 .WORD ;                                                              Ü : SWITCH-STMT  ( -- )                       SWITCH-STATE @ SWITCH-STATE ON           BREAKS NEW  CASES NEW                    (EXPRESSION)  .JMP-AHEAD                 STATEMENT                                .JMP-AHEAD  SWAP  .RESOLVE-JMP           .SWITCH  CASES-RESOLVE                   SWITCH-STATE @ NOT ?DUP                     ÉÆ NOT .JMP ÔÈÅÎ  \ DEFAULT           .RESOLVE-JMP  BREAKS RESOLVE             SWITCH-STATE ! ;                                                             \\ $SWITCH TAY:PLA:INA:STA ZP:TYA:LDY#0     [[ PHA:LDA(ZP):NE?[[ STA VEC:WINC ZP      PLA:CMP(ZP):EQ?[ JMP(VEC) ]?             WINC ZP ]]? WINC ZP:JMP(ZP)                                                  \   PARSER: STATEMENT          22FEB91PZ                                          Ü : DO-STMT  ( -- )                           BREAKS NEW  CONTS NEW                    .LABEL  STATEMENT  CONTS RESOLVE         <WHILE> #KEYWORD# EXPECT                 (EXPRESSION)  .JMN                       BREAKS RESOLVE  EXPECT';' ;                                                  Ü : WHILE-STMT  ( -- )                        BREAKS NEW  CONTS NEW                    .LABEL  (EXPRESSION)                     .JMZ-AHEAD                               STATEMENT  CONTS RESOLVE                 SWAP .JMP  .RESOLVE-JMP                  BREAKS RESOLVE ;                                                                                                                                                                                                                                                                                                                                                                                                    \   PARSER: STATEMENT          22FEB91PZ                                          \ : 1ST-EXPRESSION  ( -- )               \    ASCII ; #CHAR# COMES? NOT           \      ÉÆ EXPRESSION  EXPECT';' ÔÈÅÎ ;                                            Ü : 2ND-EXPRESSION? ( -- FLAG )               ASCII ; #CHAR# COMES? NOT DUP              ÉÆ EXPRESSION  EXPECT';' ÔÈÅÎ ;                                            Ü : 1ST-EXPRESSION  ( -- )                    2ND-EXPRESSION? DROP ;                                                       Ü : 3RD-EXPRESSION  ( -- )                    ASCII ) #CHAR# COMES? NOT                   ÉÆ EXPRESSION                            ASCII ) #CHAR# EXPECT ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                            \   PARSER: STATEMENT          22FEB91PZ                                          Ü : FOR-STMT ( -- )                           BREAKS NEW  CONTS NEW                    ASCII ( #CHAR# EXPECT                    1ST-EXPRESSION                           .LABEL                     \ Ø           2ND-EXPRESSION? DUP >R     \ ^              ÉÆ .JMN-AHEAD ( TRUE )  \ ^Ï                .JMP-AHEAD ( FALSE ) \ ^ÙÏ            ÅÌÓÅ .JMP-AHEAD 0 ÔÈÅÎ  \ ^ÏÏ         .LABEL                     \ ^ÙÙØ        3RD-EXPRESSION             \ ^ÙÙ^        3 ROLL .JMP                \ ÏÙÙ^        ROT .RESOLVE-JMP           \  ØÙ^        STATEMENT                  \   Ù^        CONTS RESOLVE              \   Ù^        .JMP                       \   ÙÏ        R> ÉÆ .RESOLVE-JMP         \   Ø            ÅÌÓÅ DROP ÔÈÅÎ                        BREAKS RESOLVE ;                                                                                                                                                                                       \   PARSER: STATEMENT          12MAR91PZ                                          Þ : STATEMENT? ( -- FLAG )  TRUE           #KEYWORD# COMES-A? ÉÆ                    <BREAK> CASE? ÉÆ BREAK-STMT EXIT ÔÈÅÎ    <CONT> CASE?                                        ÉÆ CONTINUE-STMT EXIT ÔÈÅÎ    <IF> CASE?    ÉÆ IF-STMT    EXIT ÔÈÅÎ    <DO> CASE?    ÉÆ DO-STMT    EXIT ÔÈÅÎ    <WHILE> CASE? ÉÆ WHILE-STMT EXIT ÔÈÅÎ    <FOR> CASE?   ÉÆ FOR-STMT   EXIT ÔÈÅÎ    <CASE> CASE?  ÉÆ CASE-STMT  EXIT ÔÈÅÎ    <DEFAULT> CASE?                                     ÉÆ DEFAULT-STMT  EXIT ÔÈÅÎ    <SWITCH> CASE?                                      ÉÆ SWITCH-STMT   EXIT ÔÈÅÎ    <RETURN> CASE?                                      ÉÆ RETURN-STMT   EXIT ÔÈÅÎ    DROP  BACKWORD ÔÈÅÎ                                                              [ 0 ?PAIRS                                                                                                                                                                                                 \   PARSER: STATEMENT          11SEP94PZ                                           0 ]                                       #CHAR# COMES-A? ÉÆ                       ASCII Û CASE? ÉÆ COMPOUND   EXIT ÔÈÅÎ    ASCII ; CASE? ÉÆ            EXIT ÔÈÅÎ    ASCII Ý CASE? ÉÆ BACKWORD  NOT                                       EXIT ÔÈÅÎ    DROP  BACKWORD ÔÈÅÎ  DROP                MARK EXPRESSION-STMT ADVANCED? ;                                                                                          MAKE STATEMENT ( -- )                     TESTSTACK                                STATEMENT? NOT                              ÉÆ *EXPECTED* ERROR                      ." A STATEMENT" ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                     \ PARSER: DECLARATION BASICS   14MAR91PZ                                          Ü VARIABLE #/OBJ                         Ü VARIABLE []DIM'D                       Ü VARIABLE #INITS                        Ü VARIABLE []INIT'D                                                               Ü VARIABLE EXTERN                                                                 Ü : >TYPE  ( DESC -- DESC.TYPE )                   ; IMMEDIATE                                                             \ HAENGT VON DER WIRKUNGSWEISE VON       \ 2@ U. 2! AB, MIT DENEN NORMALERWEISE   \ AUF DIE SYMBOLTABELLE ZUGEGRIFFEN      \ WIRD.                                                                                                                                                                                                                                                                                                                                                                                                                  \   PARSER: DECLARATION BASICS 14MAR91PZ                                          Þ VARIABLE FUNCTION :DOES> 0 ;                                                    Þ : DEFINED   SWAP ! ;                   Þ : DEFINED?  SWAP @ = ;                                                          \   FUNCTION [ NOT ] DEFINED             \   FUNCTION [ NOT ] DEFINED?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \   PARSER: TYPE-SPECIFIERS    14MAR91PZ                                          Ü : TYPE-NAME? ( TYPE -- TYPE' FLAG )         <CHAR> #KEYWORD# COMES?                     ÉÆ SET-CHAR TRUE                         ÅÌÓÅ <INT> #KEYWORD# COMES?                 ÉÆ SET-INT TRUE                          ÅÌÓÅ FALSE ÔÈÅÎ ÔÈÅÎ ;                                                 Ü : REGISTER? ( TYPE -- TYPE' FLAG )          <REGISTER> #KEYWORD# COMES?                 ÉÆ ( %REGISTER SET ) TRUE                ÅÌÓÅ FALSE ÔÈÅÎ ;                                                         Ü : EXTERN? ( TYPE -- TYPE' FLAG )            <EXTERN> #KEYWORD# COMES?                   ÉÆ %EXTERN SET  %OFFSET CLR                 EXTERN ON  TRUE                       ÅÌÓÅ FALSE ÔÈÅÎ ;                                                                                                                                                                                                                                                                     \   PARSER: TYPE-SPECIFIERS    14MAR91PZ                                          Ü : RANGE? ( TYPE -- TYPE' FLAG )             EXTERN? ?DUP ?EXIT                       <STATIC> #KEYWORD# COMES?                   ÉÆ %EXTERN CLR TRUE                      ÅÌÓÅ FALSE ÔÈÅÎ ;                                                         Ü : CLASS? ( TYPE -- TYPE' FLAG )             REGISTER? ?DUP ?EXIT                     EXTERN?   ?DUP ?EXIT                     <AUTO> #KEYWORD# COMES?                     ÉÆ TRUE EXIT ÔÈÅÎ                     <STATIC> #KEYWORD# COMES?                   ÉÆ %OFFSET CLR TRUE                      ÅÌÓÅ FALSE ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                \   PARSER: TYPE-SPECIFIERS    11SEP94PZ                                          Ü DEFER 'CLASS?                                                                   Ü : OR-TYPE: ( CFA -- )  CREATE ,            DOES> ( TYPE PFA -- TYPE' FLAG )          @ ÉÓ 'CLASS?   EXTERN OFF                'CLASS?                                     ÉÆ TYPE-NAME? DROP  TRUE                 ÅÌÓÅ TYPE-NAME?                             ÉÆ 'CLASS? DROP  TRUE                    ÅÌÓÅ FALSE ÔÈÅÎ ÔÈÅÎ ;                                                 Ü ' CLASS? OR-TYPE: CLASS-OR-TYPE?       Ü ' RANGE? OR-TYPE: RANGE-OR-TYPE?       Ü ' REGISTER? OR-TYPE: REGISTER-OR-TYPE?                                                                                                                                                                                                                                                                                                                                                                                 \   PARSER: DECLARATOR         08MAR91PZ                                          Ü CREATE ID-BUF /ID 1+ ALLOT                                                      Ü : HANDLE-ID  ( -- )                         ID-BUF OFF  #ID# COMES-A?                   ÉÆ ID-BUF OVER C@ 1+ CMOVE               ÅÌÓÅ *EXPECTED* ERROR                    ." IDENTIFIER" ÔÈÅÎ ;                                                                                              Ü : [PARAMETERS]) ( -- )                      TOS-OFFS OFF                             ASCII ) #CHAR# COMES? NOT                   ÉÆ ÂÅÇÉÎ #ID# COMES-A?                      ÉÆ PUTLOCAL                              2 DYN-ALLOT %LOCAL  ROT 2!               ÅÌÓÅ *EXPECTED* ERROR                    ." IDENTIFIER" ÔÈÅÎ                   ASCII , #CHAR# COMES? NOT ÕÎÔÉÌ          ASCII ) #CHAR# EXPECT ÔÈÅÎ ;                                                                                                                                                                        \   PARSER: DECLARATOR         14MAR91PZ                                          Ü : HANDLE-FUNCTION ( TYPE -- TYPE' )         FUNCTION?                                   ÉÆ UNNESTLOCAL ÔÈÅÎ                   %FUNCTION IS?                               *DOUBLE-FUNC* ?ERROR                  %FUNCTION SET                            %POINTER IS?                                ÉÆ []DIM'D @ *???* ?ERROR                []DIM'D OFF  1 #/OBJ !                   %POINTER CLR  %REFERENCE SET             ÅÌÓÅ %REFERENCE CLR ÔÈÅÎ              FUNCTION?                                   ÉÆ NESTLOCAL [PARAMETERS])               ÅÌÓÅ ASCII ) #CHAR# EXPECT               ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                  \   PARSER: DECLARATOR         08MAR91PZ                                          Ü : SET-POINTER ( TYPE -- TYPE' )             %POINTER IS?  *DOUBLE-PTR* ?ERROR        %POINTER SET ;                                                               Ü : HANDLE-ARRAY ( TYPE -- TYPE' )            ASCII ] #CHAR# COMES? NOT                   ÉÆ %FUNCTION IS? >R                      CONSTANT-EXPRESSION R>                      ÉÆ DROP *???* ERROR                      ÅÌÓÅ #/OBJ ! []DIM'D ON ÔÈÅÎ          ASCII ] #CHAR# EXPECT ÔÈÅÎ            SET-POINTER  %FUNCTION ISN'T?               ÉÆ %REFERENCE CLR ÔÈÅÎ ;                                                  \\ FRUEHER:                                   SET-POINTER  %FUNCTION IS?                  ÉÆ ASCII ] #CHAR# EXPECT                 ÅÌÓÅ %REFERENCE CLR                      ASCII ] #CHAR# COMES? NOT                   ÉÆ CONSTANT-EXPRESSION                   #/OBJ !  []DIM'D ON                      ASCII ] #CHAR# EXPECT ÔÈÅÎ            ÔÈÅÎ ;                          \   PARSER: DECLARATOR         06MAR91PZ                                          Ü : (DECLARATOR ( TYPE -- TYPE' )             1 #/OBJ !  []DIM'D OFF                  FALSE ÂÅÇÉÎ <*> #OPER# COMES? ×ÈÉÌÅ       *DOUBLE-PTR* ?ERROR TRUE ÒÅÐÅÁÔ >R       ASCII ( #CHAR# COMES?                       ÉÆ RECURSIVE (DECLARATOR                    ASCII ) #CHAR# EXPECT                 ÅÌÓÅ HANDLE-ID ÔÈÅÎ                   ÂÅÇÉÎ MARK >R                            ASCII [ #CHAR# COMES?                       ÉÆ HANDLE-ARRAY ÔÈÅÎ                  ASCII ( #CHAR# COMES?                       ÉÆ HANDLE-FUNCTION ÔÈÅÎ               R> ADVANCED? NOT ÕÎÔÉÌ                   R> ÉÆ SET-POINTER ÔÈÅÎ ;                                                     Ü DEFER 'DECLARATOR ( TYPE' -- )                                                  Ü : DECLARATOR ( TYPE -- )                    (DECLARATOR 'DECLARATOR ;                                                                                                                                     \   PARSER: DECLARATOR         12MAR91PZ                                          Ü VARIABLE (1ST                          Ü : 1ST  (1ST ON ;                       Ü : 2ND  (1ST OFF ;                      Ü : 1ST? (1ST @ ;                                                                                                          Ü : DECLARATOR-LIST';' ( TYPE -- )            >R                                       FUNCTION NOT DEFINED                     R@ 1ST DECLARATOR                        FUNCTION DEFINED?                           ÉÆ RDROP EXIT ÔÈÅÎ                    ÂÅÇÉÎ ASCII , #CHAR# COMES? ×ÈÉÌÅ        R@ 2ND DECLARATOR ÒÅÐÅÁÔ                 RDROP EXPECT';' ;                                                                                                                                                                                                                                                                                                                                                          \   PARSER: INITIALIZER        11SEP94PZ                                          Ü : 1MORE ( N -- N )                          TESTSTACK  1 #INITS +! ;                                                     Ü : NOMORE ( N -- )  DROP ;                                                       Ü DEFER '1MORE                                                                    Ü : ?1MORE  ( FLAG -- )                          ÉÆ ['] 1MORE                             ÅÌÓÅ *INITER* ERROR                      ['] NOMORE ÔÈÅÎ                       ÉÓ '1MORE ;                                                                  Ü : >INITTYPE ( TYPE -- INITTYPE )            ( BIT 0: INT     BIT 1: ARRAY   )        ( BIT 2: OFFSET  BIT 3: []DIM'D )        IS-INT? 1 AND >R ARRAY? 2 AND >R         %OFFSET IS? 4 AND NIP R> OR R> OR        []DIM'D @ 8 AND OR ;                                                         Ü : (INIT$   >INITTYPE 7 AND 2 =              DUP []INIT'D !  ?1MORE ;                                                    \   PARSER: INITIALIZER        12MAR91PZ                                          Ü : INIT[] ( TYPE -- VALUES )                 >INITTYPE 6 AND 2 =                      DUP []INIT'D !  ?1MORE                   ÂÅÇÉÎ CONSTANT-EXPRESSION '1MORE         ASCII Ý #CHAR# COMES? NOT ×ÈÉÌÅ          ASCII , #CHAR# EXPECT                    ASCII Ý #CHAR# COMES?                       ÉÆ 0  '1MORE  TRUE                       ÅÌÓÅ FALSE ÔÈÅÎ                       ÕÎÔÉÌ ;                                                                      Ü DO$: INIT$ ( TYPE -- VALUES )                  (INIT$ '1MORE NOOP ;                                                      Ü : INITIALIZER ( TYPE -- VALUES )            ASCII Û #CHAR# COMES?                       ÉÆ INIT[] EXIT ÔÈÅÎ                   #STRING# COMES-A?                           ÉÆ DROP INIT$ EXIT ÔÈÅÎ               >INITTYPE 14 AND 14 XOR ?1MORE           CONSTANT-EXPRESSION '1MORE ;                                                                                         \   PARSER: DECLARE-FCNT/DATA  14MAR91PZ                                          Ü : COMPARE-TYPES ( TYPE1 TYPE2 -- )          XOR %DECL.MASK AND                       *!=TYPE* ?ERROR ;                                                            Ü : DECLARE ( TYPE -- )                       ID-BUF FINDGLOBAL ?DUP                      ÉÆ >TYPE @ COMPARE-TYPES                 ÅÌÓÅ DROP *UNDEF* ERROR ÔÈÅÎ ;                                            Ü : EXTERN-OP?                                ( TYPE -- TYPE' FLAG )                   <*=> #OPER# COMES?                          ÉÆ FUNCTION?                                ÉÆ %STDFCTN SET                          ÅÌÓÅ *SYNTAX* ERROR ÔÈÅÎ              TRUE                                     ÅÌÓÅ </=> #OPER# COMES? ÔÈÅÎ ;                                            Ü : DEFINE-EXTERN ( TYPE -- )                 %EXTERN ISN'T? *???* ?ERROR              FUNCTION? ÉÆ UNNESTLOCAL ÔÈÅÎ            CONSTANT-EXPRESSION SWAP                 ID-BUF PUTGLOBAL  2! ;             \   PARSER: DEFINE-DATA        14MAR91PZ                                          Ü : DIM-ARRAY ( TYPE -- TYPE' )               []DIM'D @ 0=                                ÉÆ []INIT'D @                               ÉÆ #INITS @ #/OBJ !                      ÅÌÓÅ %REFERENCE SET ÔÈÅÎ              ÔÈÅÎ ;                                                                    Ü : SIZE/# ( TYPE -- TYPE N )                 %POINTER %FUNCTION + ISN'T? >R           ARRAY? >R IS-CHAR? R> R> OR AND          2+ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \   PARSER: DEFINE-DATA        11SEP94PZ                                          Ü DEFER 'STAT,                                                                    Ü : CREATE-STATIC                            ( [VALUES] TYPE -- OBJ )                  SIZE/# 1-                                   ÉÆ ['] STAT, ÅÌÓÅ ['] CSTAT,             ÔÈÅÎ ÉÓ 'STAT,                        >R #INITS @  #/OBJ @                     U> ÉÆ *INITER* ERROR                        #INITS @  #/OBJ @  DUP #INITS !          ÄÏ  DROP  ÌÏÏÐ ÔÈÅÎ                   #/OBJ @ #INITS @                            ?ÄÏ 0 'STAT, ÌÏÏÐ                     #INITS @ 0                                  ?ÄÏ   'STAT, ÌÏÏÐ                     STATICADR> R> ;                                                                                                                                                                                                                                                                                                                   \   PARSER: DEFINE-DATA        11SEP94PZ                                          Ü : CREATE-DYN ( [VALUE] TYPE -- OBJ )        SIZE/# #/OBJ @ *  DYN-ALLOT SWAP         #INITS @                                    ÉÆ SIZE/# .SIZE  ROT .LDA#.S             OVER .STA.S(BASE),# ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   PARSER: DEFINE-DATA        11SEP94PZ                                          Ü DEFER 'PUTSYMBOL                                                                Ü : DEFINE-DATA ( TYPE -- )                   EXTERN @                                    ÉÆA                                                                                                                                             COMPILER(2/2)     C2 2A                                                                                          ÿ                                                                                                                                                                                                                                                              K DECLARE EXIT ÔÈÅÎ                  #INITS OFF  []INIT'D OFF                 <=> #OPER# COMES?                           ÉÆ DUP >R INITIALIZER R> ÔÈÅÎ         ARRAY?                                      ÉÆ DIM-ARRAY ÔÈÅÎ                     %OFFSET IS?                                 ÉÆ CREATE-DYN                            ÅÌÓÅ CREATE-STATIC ÔÈÅÎ               ID-BUF 'PUTSYMBOL 2! ;                                                                                                                                                                                                                                                                                                                                                                                              \   PARSER: DEFINE FUNCTION    25APR94PZ                                          Þ VARIABLE PROTOS2RESOLVE                Þ VARIABLE PROTOS2PATCH                                                           Ü : PROTOTYPE ( TYPE -- )                     UNNESTLOCAL                              ID-BUF FINDGLOBAL ?DUP                      ÉÆ >TYPE @ COMPARE-TYPES                 ÅÌÓÅ %PROTO SET  .LABEL SWAP             ID-BUF PUTGLOBAL  DUP >R  2!             HEAP> ?DUP                                  ÉÆ DUP 2+  R> OVER !                            2+  .JMP-AHEAD SWAP !             PROTOS2RESOLVE HOOK-INTO                 ÅÌÓÅ RDROP ÔÈÅÎ                       ÔÈÅÎ ;                                                                    Þ : INIT-PATCHES                              PROTOS2RESOLVE OFF                       PROTOS2PATCH   OFF ;                                                              INIT: INIT-PATCHES                                                                                                   \   PARSER: DEFINE FUNCTION    25APR94PZ                                          Ü : SORT-IN  ( ADDR2PATCH -- LIST )           >R  PROTOS2PATCH ÂÅÇÉÎ                      DUP @ 0= ÉÆ RDROP EXIT ÔÈÅÎ              DUP @ 4 + @ R@ U<                                 ÉÆ RDROP EXIT ÔÈÅÎ              @ ÒÅÐÅÁÔ ;                                                                Ü : ADJUST-PROTOTYPE                         ( OBJ DESC TYPE -- OBJ DESC )             2 PICK COMPARE-TYPES   >R                PROTOS2RESOLVE ÂÅÇÉÎ DUP                    @  DUP 0= *COMPILER* ?FATAL              2+ @ R@ - ×ÈÉÌÅ  @ ÒÅÐÅÁÔ             HOOK-OUT  2 PICK OVER 2+ !               DUP 4 + @  SORT-IN  HOOK-INTO ;                                              Ü : FIND/PUTGLOBAL ( OBJ -- OBJ DESC )        ID-BUF FINDGLOBAL ?DUP                      ÉÆ DUP >TYPE @ %PROTO IS?                   ÉÆ ADJUST-PROTOTYPE EXIT                 ÅÌÓÅ 2DROP ÔÈÅÎ ÔÈÅÎ               ID-BUF PUTGLOBAL ;                                                          \   PARSER: DEFINE-FUNCTION    14MAR91PZ                                          Ü : PARAMETER' ( TYPE -- )                    FUNCTION? DUP >R                            ÉÆ UNNESTLOCAL ÔÈÅÎ                   ARRAY? R> OR                                ÉÆ *PARAM* ERROR                         ÅÌÓÅ ID-BUF FINDPARAM                    ?DUP 0= ÉÆ *UNDEF* ERROR DROP                    ÅÌÓÅ >TYPE ! ÔÈÅÎ                ÔÈÅÎ ;                                                                    Ü : DECLARE-PARAMETERS ( -- )                 ['] PARAMETER' ÉÓ 'DECLARATOR            ÂÅÇÉÎ %LOCAL                             REGISTER-OR-TYPE? ×ÈÉÌÅ                  DECLARATOR-LIST';' ÒÅÐÅÁÔ DROP ;                                                                                                                                                                                                                                                                                                                                           \   PARSER: DEFINE FUNCTION    14MAR91PZ                                          Ü : DEFINE-FUNCTION ( TYPE -- )               #CHAR# COMES-A?                             ÉÆ BACKWORD                              DUP ASCII ; = SWAP ASCII , = OR             ÉÆ PROTOTYPE EXIT ÔÈÅÎ ÔÈÅÎ        1ST?                                        ÉÆ .LABEL SWAP                           FIND/PUTGLOBAL 2!                         DECLARE-PARAMETERS                        ASCII Û #CHAR# EXPECT                    COMPOUND                                UNNESTLOCAL                             .RTS  FLUSHCODE                          FUNCTION DEFINED                         ÅÌÓÅ DROP *SYNTAX* ERROR ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                         \   PARSER: TYPE-SPECIFIERS    11SEP94PZ                                          Ü : GLOBAL  ( -- )                            ['] PUTGLOBAL ÉÓ 'PUTSYMBOL ;                                                Ü : LOCAL  ( -- )                             ['] PUTLOCAL ÉÓ 'PUTSYMBOL ;                                                                                          Ü : DECLARATION' ( TYPE -- )                  FUNCTION?                                   ÉÆ UNNESTLOCAL DECLARE                   ÅÌÓÅ LOCAL DEFINE-DATA ÔÈÅÎ ;                                             Ü : DEFINITION' ( TYPE -- )                   EXTERN-OP?                                  ÉÆ DEFINE-EXTERN EXIT ÔÈÅÎ            FUNCTION?                                   ÉÆ DEFINE-FUNCTION                       ÅÌÓÅ GLOBAL DEFINE-DATA ÔÈÅÎ ;                                                                                                                                                                                                               \   PARSER: DECLARATION        14MAR91PZ                                          Ü : DECLARATION? ( -- FLAG )                  ['] DECLARATION' ÉÓ 'DECLARATOR          %LOCAL CLASS-OR-TYPE?                       ÉÆ DECLARATOR-LIST';' TRUE               ÅÌÓÅ DROP FALSE ÔÈÅÎ ;                                                    Ü : DEFINITION? ( -- FLAG )                   ['] DEFINITION' ÉÓ 'DECLARATOR           %GLOBAL RANGE-OR-TYPE?                      ÉÆ DECLARATOR-LIST';' TRUE               ÅÌÓÅ #EOF# COMES?                           ÉÆ DROP FALSE                            ÅÌÓÅ MARK >R                             DECLARATOR-LIST';'                       R> ADVANCED? ÔÈÅÎ ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                             \ PARSER: COMPOUND, PROGRAM    09MAY94PZ                                            MAKE COMPOUND ( -- )                        NESTLOCAL                                ÂÅÇÉÎ DECLARATION? NOT ÕÎÔÉÌ             ÂÅÇÉÎ STATEMENT? NOT ÕÎÔÉÌ               ASCII Ý #CHAR# EXPECT                    UNNESTLOCAL ;                                                                Þ VARIABLE MAIN()-ADR                                                             Þ : COMPILE-PROGRAM ( -- )                    ÂÅÇÉÎ DEFINITION? NOT ÕÎÔÉÌ              " MAIN" FINDGLOBAL ?DUP 0=                  ÉÆ MAIN()-ADR OFF EXIT ÔÈÅÎ           2@ FUNCTION?                                ÉÆ DROP MAIN()-ADR ! EXIT ÔÈÅÎ        *BAD-MAIN* FATAL ;                                                                                                                                                                                                                                                                                                                \ PARSER:                      14MAR91PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       18APR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       18APR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ INVOKE :  LOADSCREEN         21SEP94PZ                                            .( MODULE INVOKE )                                                                 1 3 +THRU                                                                         CR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   INVOKE :  PASS1            11SEP94PZ                                          Þ : PASS1 ( -- )                              OPEN-OUTFILES                            ." SOURCE FILE: "                        SOURCE-NAME COUNT TYPE CR                SOURCE-NAME OPEN-INPUT                   COMPILE-PROGRAM                          END-OF-CODE CLOSE-OUTFILES ;                                                 Ü : ?USAGE  ( FLAG -- )                       ÉÆ ." USAGE: CC FILE.C" CR               RDROP ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   INVOKE :  START COMPILER   11SEP94PZ                                          Ü : WAIT-SCRATCH  ( -- )                      DEV 15 BUSIN ÂÅÇÉÎ BUS@ DROP             I/O-STATUS? ÕÎÔÉÌ BUSOFF ;                                                   Ü : S!  COUNT BUSTYPE ;                  Ü : ,!  ASCII , BUS! ;                                                            Ü : SCRATCH-EXE  ( -- )                       DEV 15 BUSOUT " S0:" S!                  EXE-NAME S!        ,!                    EXE-NAME S! CODE.SUFFIX S! ,!            EXE-NAME S! INIT.SUFFIX S! ,!            EXE-NAME S! DECL.SUFFIX S!               BUSOFF                                   WAIT-SCRATCH ;                                                                                                                                                                                                                                                                                                                                                             \   INVOKE :  START COMPILER   13SEP94PZ                                          FORTH DEFINITIONS                                                                   : CC  ( -- )                                CLEARSTACK  INIT                         BL WORD   DUP C@ 0= ?USAGE               DUP EXE-NAME STRCPY                          SOURCE-NAME STRCPY                   EXE-NAME COUNT 2-                        DUP EXE-NAME C!  + @                    [ ASCII . ASCII C 256 * + ] LITERAL       -  ?USAGE                                SCRATCH-EXE                              CR CR ." PASS 1:" CR                     PASS1  CR                                ANY-ERRORS? @                               ÉÆ ." ERROR(S) OCCURED" CR               CLOSE-FILES SCRATCHFILES EXIT            ÔÈÅÎ                                  ." PASS 2:" CR                           PASS2  CR                                ." COMPILATION DONE" CR                  SCRATCHFILES ;                                                              \                              19APR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       18APR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       18APR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       18APR94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ PASS2 :  LOADSCREEN          21SEP94PZ                                            .( MODULE PASS2 )                                                                 1 11 +THRU                                                                        CR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \   PASS2 :                    14JAN96PZ                                          Ü VARIABLE #TOREAD                       Ü VARIABLE #INBUF                        Ü VARIABLE P2IN>                         Ü ' CODE[ ÁÌÉÁÓ P2IN[                    Ü ' ]CODE ÁÌÉÁÓ ]P2IN                                                                                                      Ü : P2READCODE  ( -- )                        #TOREAD @ 0=     *COMPILER* ?FATAL       CODE-FILE FEOF? *OBJ-SHORT* ?FATAL       CODE-FILE FSETIN   P2IN[ P2IN> !         P2IN[  ]P2IN OVER - #TOREAD @ UMIN       FGETS  DUP #INBUF !                          NEGATE #TOREAD +!   FUNSET ;                                             Ü : P2CODE@ ( -- 8B ) 64 EMIT                 #INBUF @ 0= ÉÆ P2READCODE ÔÈÅÎ           -1 #INBUF +!                             P2IN> @ C@  1 P2IN> +! ;                                                                                                                                                                               \   PASS2 :                    13SEP94PZ                                          Ü VARIABLE P2OUT>                        Ü ' STATIC[ ÁÌÉÁÓ P2OUT[                 Ü ' ]STATIC ÁÌÉÁÓ ]P2OUT                                                                                                   Ü : P2FLUSH  ( -- )                           EXE-FILE FSETOUT                         P2OUT[ P2OUT> @ OVER - FPUTS             FUNSET                                   P2OUT[ P2OUT> ! ;                                                            Ü : P2CODE!  ( 8B -- )                        P2OUT> @  UNDER  C!                      1+ DUP P2OUT> !                          ]P2OUT = ÉÆ P2FLUSH ÔÈÅÎ ;                                                   Þ : INIT-P2I/O  ( -- )                        P2OUT[  P2OUT> ! ;                                                               INIT: INIT-P2I/O                                                                                                                                               \   PASS2 :                    14JAN96PZ                                          Ü : P2COPY  ( LAST.ADR+1 FIRST.ADR -- )       ?ÄÏ P2CODE@ P2CODE! ÌÏÏÐ ;                                                   Ü : P2WCODE!  ( 16B -- )                      >LO/HI SWAP P2CODE! P2CODE! ;                                                Ü : P2WCODE@DROP  ( -- )                      P2CODE@ P2CODE@ 2DROP ;                                                      Ü : P2OPENFILE                               ( LEN MODE TYPE NAME HANDLE -- )          ." LINKING " OVER COUNT TYPE CR          FOPEN  2+ #TOREAD !  #INBUF OFF          P2READCODE ;                                                                 Ü : P2CLOSEFILE  ( HANDLE -- )                DUP FCLOSE                               FEOF? 0= *OBJ-LONG* ?FATAL               #TOREAD @ #INBUF @ OR                    *COMPILER* ?FATAL ;                                                                                                                                           \   PASS2 :                    21SEP94PZ                                          Ü : LINK-RUNTIMEMODULE  ( -- )                ASCII W ASCII P EXE-NAME                 EXE-FILE FOPEN                           CODE.FIRST @ LIB.FIRST @ -               ASCII R ASCII P LIB.CODENAME             CODE-FILE P2OPENFILE                     >RUNTIME @  LIB.FIRST @                  2- P2COPY  \ COPY LOAD ADRESS, TOO       8 0 ÄÏ P2CODE@ DROP ÌÏÏÐ                 MAIN()-ADR @    P2WCODE!                 CODE.LAST @     P2WCODE!                 STATICS.FIRST @ P2WCODE!                 STATICS.LAST @  P2WCODE!                 CODE.FIRST @ >RUNTIME @ 8 + P2COPY       P2FLUSH EXE-FILE FCLOSE                  CODE-FILE P2CLOSEFILE ;                                                                                                                                                                                                                                                                                                           \   PASS2 :                    21SEP94PZ                                          Ü VARIABLE P2PC                                                                   Ü : LINK-CODE  ( -- )                         ASCII A ASCII P EXE-NAME                 EXE-FILE FOPEN                           CODE.LAST @ CODE.FIRST @ -               ASCII R ASCII P CODE-NAME                CODE-FILE P2OPENFILE                     P2WCODE@DROP \ DROP LOAD ADDRESS         CODE.FIRST @ P2PC !                      ÂÅÇÉÎ PROTOS2PATCH HOOK-OUT ?DUP         ×ÈÉÌÅ DUP 4 + @  ( LIST PATCHADR )       DUP  P2PC @  P2COPY ( DITO )             2+ P2PC !  P2WCODE@DROP  ( LIST )        2+ @ >LO/HI SWAP P2CODE! P2CODE!         ÒÅÐÅÁÔ                                   CODE.LAST @  P2PC @ P2COPY               P2FLUSH EXE-FILE FCLOSE                  CODE-FILE P2CLOSEFILE ;                                                                                                                                                                                \   PASS2 :                    14JAN96PZ                                          Ü : (LINK-STATICS  ( N FILENAME -- )          OVER 0=                                     ÉÆ ." NO NEED TO LINK "                  COUNT TYPE CR  DROP EXIT ÔÈÅÎ         ASCII A ASCII P EXE-NAME                                  EXE-FILE FOPEN          >R DUP ASCII R ASCII P R>                          CODE-FILE  P2OPENFILE          P2WCODE@DROP  \ DROP LOAD ADDRESS        0 P2COPY                                 P2FLUSH EXE-FILE FCLOSE                  CODE-FILE P2CLOSEFILE ;                                                      Ü : LINK-STATICS  ( -- )                      STATICS.LIBFIRST @ STATICS.FIRST @       - STATIC-NAME (LINK-STATICS              STATICS.LAST @ STATICS.LIBFIRST @        - LIB.INITNAME (LINK-STATICS ;                                                                                                                                                                                                                  \   PASS2 :                    21SEP94PZ                                          Ü : (LINK-LIB ( N IN-NAME W/A -- )            DUP >R                                   ASCII P EXE-NAME EXE-FILE FOPEN          >R DUP ASCII R ASCII P R>                            CODE-FILE P2OPENFILE         R> ASCII W =                                ÉÆ 2+ \ COPY LOAD ADRESS                 ÅÌÓÅ P2WCODE@DROP ÔÈÅÎ                0 P2COPY                                 P2FLUSH EXE-FILE FCLOSE                  CODE-FILE P2CLOSEFILE ;                                                      Ü : LINK-LIBSTATICS  ( -- )                 STATICS.LAST @ STATICS.LIBFIRST  @ -     LIB.INITNAME  ASCII W (LINK-LIB          STATICS.LIBFIRST @ STATICS.FIRST @ -     STATIC-NAME   ASCII A (LINK-LIB ;                                                                                                                                                                                                                                                          \   PASS2 :                    11SEP94PZ                                          Ü : HEX!  ( N -- )                            "  0X" COUNT FPUTS                       BASE PUSH HEX 0 <# #S #> FPUTS ;                                             Ü : CR!  ( -- )  $0D FPUTC ;                                                      Ü : STR! ( STRING -- ) COUNT FPUTS ;                                              Ü : WRITE-LIBHEADER ( -- )                    CR!                                      " #SPECIAL CC64" STR!                    >BASE         @ HEX!                     >ZP           @ HEX!                     LIB.FIRST     @ HEX!                     >RUNTIME      @ HEX!                     CODE.LAST     @ HEX!                     STATICS.FIRST @ HEX!                     STATICS.LAST  @ HEX!  BL FPUTC           EXE-NAME COUNT 2 - FPUTS                 CR! CR! ;                                                                                                                                                     \   PASS2 :                    11SEP94PZ                                          Ü : (WRITE-DECL ( NAME VAL TYPE -- )          %FUNCTION %REFERENCE %POINTER + +        ISN'T? ÉÆ 2DROP DROP EXIT ÔÈÅÎ           " EXTERN " STR!                          IS-CHAR? ÉÆ   " CHAR "                            ÅÌÓÅ " INT " ÔÈÅÎ STR!          %FUNCTION %REFERENCE + ISN'T? >R         %POINTER IS? R> AND                         ÉÆ DROP SWAP STR! " [] /=" STR!          HEX! EXIT ÔÈÅÎ                        %POINTER IS? ÉÆ ASCII * FPUTC ÔÈÅÎ       %FUNCTION IS?                               ÉÆ %REFERENCE ISN'T?                        ÉÆ ROT STR! ÅÌÓÅ " (*" STR!              ROT STR! ASCII ) FPUTC ÔÈÅÎ           " ()" STR! ÅÌÓÅ ROT STR! ÔÈÅÎ         %STDFCTN IS? ÉÆ "  *=" ÅÌÓÅ "  /="       ÔÈÅÎ STR!  DROP HEX!                     "  ;" STR!  CR! ;                                                                                                                                                                                      \   PASS2 :                    11SEP94PZ                                          Ü : WRITE-DECLARATIONS  ( -- )                ." CREATING " EXE-NAME COUNT             TYPE CR    ASCII W ASCII S               EXE-NAME EXE-FILE FOPEN                  EXE-FILE FSETOUT                         WRITE-LIBHEADER                          ]HASH HASH[                              ÄÏ É @ ?DUP                                 ÉÆ DUP COUNT + 2@                        (WRITE-DECL ÔÈÅÎ                      2 +ÌÏÏÐ                                  FUNSET  EXE-FILE FCLOSE ;                                                    Ü : LINK-LIB  ( -- )                          CODE.SUFFIX  EXE-NAME STRCAT             LINK-RUNTIMEMODULE  LINK-CODE            EXE-NAME CUT-SUFFIX                      INIT.SUFFIX EXE-NAME STRCAT              LINK-LIBSTATICS                          EXE-NAME CUT-SUFFIX                      DECL.SUFFIX EXE-NAME STRCAT              WRITE-DECLARATIONS ;                                                        \   PASS2 :                    11SEP94PZ                                          Ü : LINK-EXE  ( -- )                          LINK-RUNTIMEMODULE  LINK-CODE            LINK-STATICS ;                                                               Þ : PASS2  ( -- )                             MAIN()-ADR @                                ÉÆ LINK-EXE                              ÅÌÓÅ LINK-LIB ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   PASS2:                     11SEP94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \   PASS2:                     04SEP94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       24AUG94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       24AUG94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       24AUG94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       24AUG94PZ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ SHELL LOADSCREEN             21SEP94PZ                                            .( MODULE SHELL )                                                                 1 4 +THRU                                                                         CR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \   SHELL:                     21SEP94PZ                                          ÃODE BYE   $37 # LDA  $1 STA                        $A000 ) JMP  END-CODE                                                  ' SAVESYSTEM        ALIAS SAVEALL        ' .MEM              ALIAS MEM            ' HIMEM!            ALIAS SET-HIMEM      ' #LINKS!           ALIAS SET-HEAP       ' #GLOBALS!         ALIAS SET-HASH       ' SYMTABSIZE!       ALIAS SET-SYMTAB     ' CODESIZE!         ALIAS SET-CODE       ' RELOCATE          ALIAS SET-STACKS                                              : AUXDEV ( N -- )             AUX# C! ;  : DEVICE ( N -- ) DUP DEV# C! AUX# C! ;  : DEVICE?  ( -- )                         ." ACTUAL DEVICE NUMBER IS " DEV . CR    ." AUXILIAR DEV. NUMBER IS " AUX . ;    \\                                       : DELAY  ( N -- )  FDELAY ! ;            : DELAY? ( -- )                             ." DELAY AFTER FOPEN/FCLOSE IS" CR       FDELAY @ U. ." /60 SECONDS." CR ;                                             \   SHELL:                     09SEP94PZ                                          : DIR  ( -- )                               DEV 0 BUSOPEN  ASCII $ BUS! BUSOFF       DEV 0 BUSIN BUS@ BUS@ 2DROP              ÂÅÇÉÎ CR BUS@ BUS@ 2DROP                 I/O-STATUS? 0= ×ÈÉÌÅ                     BUS@ BUS@ LO/HI> U.                      ÂÅÇÉÎ BUS@ ?DUP ×ÈÉÌÅ CON! ÒÅÐÅÁÔ        ÒÅÐÅÁÔ BUSOFF  DEV 0 BUSCLOSE ;                                                : DOS  ( -- )                               BL WORD COUNT ?DUP                          ÉÆ DEV 15 BUSOUT BUSTYPE                 BUSOFF CR ÅÌÓÅ DROP ÔÈÅÎ              DEV 15 BUSIN                             ÂÅÇÉÎ BUS@ CON! I/O-STATUS? ÕÎÔÉÌ        BUSOFF ;                                                                       : CAT   ( -- ) CR                           DEV 2 BUSOPEN  BL WORD COUNT BUSTYPE     BUSOFF  DEV 2 BUSIN  ÂÅÇÉÎ BUS@ CON!     I/O-STATUS? ÕÎÔÉÌ BUSOFF                 DEV 2 BUSCLOSE ;                                                              \   SHELL: COLD' LOGO          14JAN96PZ                                          Ü ÃODE CHARSET  HERE 6 + JSR XYÎEXT JMP                   $CBFA ) JMP END-CODE                                             Ü : INIT-SHELL  ( -- )                        ONLY SHELL                               $CBFC 2@  $65021103. D=                     ÉÆ CHARSET ÔÈÅÎ ;                                                         ' INIT-SHELL ÉÓ 'COLD                                                                                                      Ü : .LOGO  ( -- )                             ."     RUNNUNG" CR                       ." CC64 Ã COMPILER Ö0.5" CR              ." 1994 BY ÐHILIP ÚEMBROD" CR            $CBFC 2@  $65021103. D= NOT ?EXIT        ." Ã CHARSET IN USE" CR ;                                                    ' .LOGO ÉÓ 'RESTART                                                                                                                                                                                         \   SHELL                      20SEP94PZ                                          : HELP  ." AVAILABLE COMMANDS:" CR               WORDS ;                                                                   ' CC                ALIAS CC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ PARSER: DECLARATION BASICS   21FEB91PZ                                          Ü VARIABLE OBJ-TYPE                      Ü VARIABLE OBJ-TYPE'                     Ü VARIABLE OBJ-VAL                                                                Ü VARIABLE #/OBJ                         Ü VARIABLE #INITS                        Ü VARIABLE []INIT'D                      Ü VARIABLE []DIM'D                                                                Ü : !SET ( MASK -- )                          OBJ-TYPE @ SWAP SET OBJ-TYPE ! ;                                             Ü : !CLR ( MASK -- )                          OBJ-TYPE @ SWAP CLR OBJ-TYPE ! ;                                             Ü : @IS? ( MASK -- FLAG )                     OBJ-TYPE @ SWAP IS? NIP ;                                                    Ü : @ISN'T? ( MASK -- FLAG )                  OBJ-TYPE @ SWAP ISN'T? NIP ;                                                                                                                                  \   PARSER: DECLARATION BASICS 26FEB91PZ                                          Ü : !SET-INT ( -- )                           OBJ-TYPE @ SET-INT OBJ-TYPE ! ;                                              Ü : !SET-CHAR ( -- )                          OBJ-TYPE @ SET-CHAR OBJ-TYPE ! ;                                             Ü : @IS-INT? ( -- FLAG )                      OBJ-TYPE @ IS-INT? NIP ;                                                     Ü : @IS-CHAR? ( -- FLAG )                     OBJ-TYPE @ IS-CHAR? NIP ;                                                    Ü : VAL/TYPE>TAB ( DESC -- )                  OBJ-VAL @  OBJ-TYPE @  ROT 2! ;                                              Ü : ARRAY?                                    %REFERENCE %FUNCTION + @ISN'T?           %POINTER @IS? AND ;                                                          Ü : FUNCTION?                                 %FUNCTION @IS? %REFERENCE @ISN'T?        AND ;                                                                       \   PARSER: TYPE-SPECIFIERS    26FEB91PZ                                          Ü : TYPE-NAME? ( -- FLAG )                    <CHAR> #KEYWORD# COMES?                     ÉÆ !SET-CHAR TRUE                        ÅÌÓÅ <INT> #KEYWORD# COMES?                 ÉÆ !SET-INT TRUE                         ÅÌÓÅ FALSE ÔÈÅÎ ÔÈÅÎ ;                                                 Ü : [TYPE-NAME] ( -- )                        TYPE-NAME? DROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \   PARSER: TYPE-SPECIFIERS    21JAN91PZ                                          Ü : REGISTER? ( -- FLAG )                     <REGISTER> #KEYWORD# COMES? DUP             ÉÆ ( %REGISTER !SET ) ÔÈÅÎ ;                                              Ü : [REGISTER]  REGISTER? DROP ;                                                  Ü : REGISTER-OR-TYPE? ( -- FLAG )             REGISTER?                                   ÉÆ [TYPE-NAME] TRUE                      ÅÌÓÅ TYPE-NAME?                             ÉÆ [REGISTER] TRUE                       ÅÌÓÅ FALSE ÔÈÅÎ ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \   PARSER: TYPE-SPECIFIERS    21JAN91PZ                                          Ü : EXTERN? ( -- FLAG )                       <EXTERN> #KEYWORD# COMES? DUP               ÉÆ %EXTERN !SET ÔÈÅÎ ;                                                    Ü : STATIC? ( -- FLAG )                       <STATIC> #KEYWORD# COMES? DUP               ÉÆ %EXTERN !CLR ÔÈÅÎ ;                                                    Ü : [STATIC]  STATIC? DROP ;                                                      Ü : CLASS? ( -- FLAG )                        <AUTO> #KEYWORD# COMES?                     ÉÆ TRUE EXIT ÔÈÅÎ                     <STATIC> #KEYWORD# COMES?                   ÉÆ %OFFSET !CLR TRUE EXIT ÔÈÅÎ        <REGISTER> #KEYWORD# COMES?                 ÉÆ ( %REGISTER !SET ) TRUE               ÅÌÓÅ FALSE ÔÈÅÎ ;                                                         Ü : [CLASS]  CLASS? DROP ;                                                                                                                                         \   PARSER: DECLARATOR         23FEB91PZ                                          Ü CREATE ID-BUF /ID 1+ ALLOT                                                      Ü : HANDLE-ID  ( -- )                         ID-BUF OFF  #ID# COMES-A?                   ÉÆ ID-BUF OVER C@ 1+ CMOVE               ÅÌÓÅ *EXPECTED* ERROR                    ." IDENTIFIER" ÔÈÅÎ ;                                                                                              Ü : PARAMETER-LIST ( -- )                     ASCII ) #CHAR# COMES? NOT                   ÉÆ ÂÅÇÉÎ #ID# COMES-A?                      ÉÆ PUTLOCAL                              2 DYN-ALLOT %LOCAL  ROT 2!               ÅÌÓÅ *EXPECTED* ERROR                    ." IDENTIFIER" ÔÈÅÎ                   ASCII , #CHAR# COMES? NOT ÕÎÔÉÌ          ASCII ) #CHAR# EXPECT ÔÈÅÎ ;                                                                                                                                                                                                                 \   PARSER: DECLARATOR         23FEB91PZ                                          Ü : HANDLE-FUNCTION ( -- )                    FUNCTION?  ÉÆ UNNESTLOCAL ÔÈÅÎ           %FUNCTION @IS?                              *DOUBLE-FUNC* ?ERROR                  %FUNCTION !SET                           %POINTER @IS?                               ÉÆ []DIM'D @ *???* ?ERROR                []DIM'D OFF  1 #/OBJ !                   %POINTER !CLR  %REFERENCE !SET           ÅÌÓÅ %REFERENCE !CLR ÔÈÅÎ             FUNCTION?                                   ÉÆ NESTLOCAL                             FUNCTION NOT ACTIVE?                        ÉÆ TOS-OFFS OFF                          PARAMETER-LIST                           ÅÌÓÅ ASCII ) #CHAR# EXPECT               ÔÈÅÎ                                  ÔÈÅÎ ;                                                                                                                                                                                                                                       \   PARSER: DECLARATOR         23FEB91PZ                                          Ü  VARIABLE PTR                          Ü : MARK-PTR ( -- )   PTR @  PTR ON           *DOUBLE-PTR* ?ERROR ;                                                        Ü : SET-POINTER ( -- )                        %POINTER @IS?  *DOUBLE-PTR* ?ERROR       %POINTER !SET ;                                                              Ü : HANDLE-ARRAY ( -- )                       SET-POINTER  %FUNCTION @IS?                 ÉÆ ASCII ] #CHAR# EXPECT                 ÅÌÓÅ %REFERENCE !CLR                     ASCII ] #CHAR# COMES? NOT                   ÉÆ CONSTANT-EXPRESSION                   #/OBJ !  []DIM'D ON                      ASCII ] #CHAR# EXPECT ÔÈÅÎ            ÔÈÅÎ ;                                                                                                                                                                                                                                                                                \   PARSER: DECLARATOR         23FEB91PZ                                          Ü : (DECLARATOR ( -- )                        OBJ-TYPE' @ OBJ-TYPE !                   1 #/OBJ !  []DIM'D OFF                   PTR OFF ÂÅÇÉÎ  <*> #OPER# COMES?         ×ÈÉÌÅ MARK-PTR ÒÅÐÅÁÔ                    ASCII ( #CHAR# COMES?                       ÉÆ PTR @  RECURSIVE (DECLARATOR             PTR !  ASCII ) #CHAR# EXPECT          ÅÌÓÅ HANDLE-ID ÔÈÅÎ                   ÂÅÇÉÎ MARK                               ASCII [ #CHAR# COMES?                       ÉÆ HANDLE-ARRAY ÔÈÅÎ                  ASCII ( #CHAR# COMES?                       ÉÆ HANDLE-FUNCTION ÔÈÅÎ               ADVANCED? NOT ÕÎÔÉÌ                      PTR @ ÉÆ SET-POINTER ÔÈÅÎ ;                                                  Ü DEFER 'DECLARATOR ( -- )                                                        Ü : DECLARATOR ( -- )                         (DECLARATOR 'DECLARATOR ;                                                                                            \   PARSER: DECLARATOR         23FEB91PZ                                          Ü VARIABLE (1ST                          Ü : 1ST  (1ST ON ;                       Ü : 2ND  (1ST OFF ;                      Ü : 1ST? (1ST @ ;                                                                 \ VARIABLE FUNCTION :DOES> 0 ;           \ : DEFINED   SWAP ! ;                   \ : DEFINED?  SWAP @ = ;                                                          \   FUNCTION [ NOT ] DEFINED             \   FUNCTION [ NOT ] DEFINED?                                                     Ü : DECLARATOR-LIST ( -- )                    OBJ-TYPE @ OBJ-TYPE' !                   FUNCTION NOT DEFINED                     1ST DECLARATOR                           FUNCTION DEFINED? ?EXIT                  ÂÅÇÉÎ ASCII , #CHAR# COMES? ×ÈÉÌÅ        2ND DECLARATOR ÒÅÐÅÁÔ ;                                                                                                                                                                                \   PARSER: INITIALIZER        21FEB91PZ                                          Ü : 1MORE ( N -- N )                          ?SAVESTACK  1 #INITS +! ;                                                    Ü : NOMORE ( N -- )  DROP ;                                                       Ü DEFER '1MORE                                                                                                                                                      Ü : []LEGAL? ( -- )                           ARRAY? %OFFSET @ISN'T? AND                  ÉÆ []INIT'D ON   ['] 1MORE               ÅÌÓÅ *INITER* ERROR                      ['] NOMORE ÔÈÅÎ                       ÉÓ '1MORE ;                                                                  Ü : ""LEGAL? ( -- )                           []LEGAL?                                 @IS-INT? *!=TYPE* ?ERROR ;                                                                                                                                                                             \   PARSER: INITIALIZER        21FEB91PZ                                          Ü : []INIT ( -- VALUES )                      []LEGAL?                                 ÂÅÇÉÎ CONSTANT-EXPRESSION '1MORE         ASCII Ý #CHAR# COMES? NOT ×ÈÉÌÅ          ASCII , #CHAR# EXPECT                    ASCII Ý #CHAR# COMES?                       ÉÆ 0  '1MORE  TRUE                       ÅÌÓÅ FALSE ÔÈÅÎ                       ÕÎÔÉÌ ;                                                                      Ü DO$: ""INIT  ""LEGAL? '1MORE NOOP ;                                             Ü : INITIALIZER ( -- VALUES )                 ASCII Û #CHAR# COMES?                       ÉÆ []INIT EXIT ÔÈÅÎ                   #STRING# COMES-A?                           ÉÆ DROP ""INIT EXIT ÔÈÅÎ              CONSTANT-EXPRESSION 1MORE ;                                                                                                                                                                                                                     \   PARSER: DECLARE-FCNT/DATA  26FEB91PZ                                          Ü : COMPARE-TYPES ( OBJ -- )                  NIP  OBJ-TYPE @  XOR                     %EXPR.MASK AND                           *!=TYPE* ?ERROR ;                                                            Ü : DECLARE-DATA ( -- )                       ID-BUF FINDGLOBAL ?DUP                      ÉÆ 2@ COMPARE-TYPES                      ÅÌÓÅ *UNDEF* ERROR ÔÈÅÎ ;                                                 Ü : DECLARE-FUNCTION ( -- )                   UNNESTLOCAL                              DECLARE-DATA ;                                                                                                                                                                                                                                                                                                                                                                                                                                               \   PARSER: DEFINE-DATA        21FEB91PZ                                          Ü : DIM-ARRAY ( -- )                          []DIM'D @ 0=                                ÉÆ []INIT'D @                               ÉÆ #INITS @ #/OBJ !                      []DIM'D ON ÔÈÅÎ ÔÈÅÎ ;                                                 Ü : B/OBJ ( -- B/OBJ )                        2 @IS-CHAR?                                 ÉÆ %POINTER %FUNCTION + @ISN'T?             ÉÆ 1- EXIT ÔÈÅÎ                       ARRAY? ÉÆ 1- ÔÈÅÎ                        ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \   PARSER: DEFINE-DATA        26FEB91PZ                                          Ü : INIT-DYN ( [VALUE] B/OBJ -- )             .SIZE  #INITS @                             ÉÆ .LDA#                                 $BASE OBJ-VAL @ .STA(),# ÔÈÅÎ ;                                                                                    Ü DEFER 'STAT,                                                                    Ü : INIT-STATIC ( [VALUES] B/OBJ -- )         1- ÉÆ ['] STAT, ÅÌÓÅ CSTAT, ÔÈÅÎ             ÉÓ 'STAT,                            #INITS @ #/OBJ @ 2DUP                    U> ÉÆ *INITER* ERROR                        ÄÏ ?LOADSTACK DROP ÌÏÏÐ                  #/OBJ @ #INITS !                         ÅÌÓÅ 2DROP ÔÈÅÎ                       #/OBJ @ #INITS @                            ?ÄÏ 0 'STAT, ÌÏÏÐ                     #INITS @ 0                                  ?ÄÏ ?LOADSTACK 'STAT, ÌÏÏÐ ;                                                                                                                               \   PARSER: DEFINE-DATA        21FEB91PZ                                          Ü : DEFINE-DATA ( -- )                        #INITS OFF  []INIT'D OFF                 +SAVESTACK                               <=> #OPER# COMES?                           ÉÆ INITIALIZER ÔÈÅÎ                   ARRAY?                                      ÉÆ DIM-ARRAY  []DIM'D @                     ÉÆ %REFERENCE !CLR ÔÈÅÎ               ÔÈÅÎ                                  B/OBJ %OFFSET @IS?                          ÉÆ DUP #/OBJ * DYN-ALLOT                 OBJ-VAL !                                INIT-DYN                                 ÅÌÓÅ INIT-STATIC                         STATICADR> OBJ-VAL !                     ÔÈÅÎ                                  -SAVESTACK ;                                                                                                                                                                                                                                                                             \   PARSER: DEFINE-DATA        16JAN91PZ                                          Ü : DEFINE-GLOBAL ( -- )                      </=> #OPER# COMES?                         ÉÆ CONSTANT-EXPRESSION OBJ-VAL !         ÅÌÓÅ DEFINE-DATA ÔÈÅÎ                  ID-BUF PUTGLOBAL VAL/TYPE>TAB ;                                              Ü : DEFINE-LOCAL ( -- )                       DEFINE-DATA                              ID-BUF PUTLOCAL VAL/TYPE>TAB ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \   PARSER: DEFINE FUNCTION    26FEB91PZ                                          Ü : EXT-FNCT ( -- )                           UNNESTLOCAL                              CONSTANT-EXPRESSION  OBJ-VAL !           ID-BUF PUTGLOBAL  VAL/TYPE>TAB ;                                             Ü : PROTOTYPE ( -- )                          UNNESTLOCAL                              ID-BUF FINDGLOBAL ?DUP                      ÉÆ 2@ COMPARE-TYPES                      ÅÌÓÅ %PROTO !SET  PC OBJ-VAL !           ID-BUF PUTGLOBAL                         FREELIST HOOK-OUT ?DUP                      ÉÆ DUP PATCHES HOOK-INTO                 2+ 2DUP !                                2+ .JMP-AHEAD SWAP ! ÔÈÅÎ             VAL/TYPE>TAB ÔÈÅÎ ;                                                                                                                                                                                                                                                                                                            \   PARSER: DEFINE FUNCTION    26FEB91PZ                                          Ü : ADJUST-PROTOTYPE                         ( DESC TYPE -- DESC )                     %PROTO CLR OBJ-TYPE @ -                     *!=TYPE* ?ERROR                       PATCHES ÂÅÇÉÎ @ DUP ×ÈÉÌÅ                2DUP 2+ @ = ÕÎÔÉÌ                        ?DUP ÉÆ 2+ PC SWAP ! ÔÈÅÎ ;                                                  Ü : FIND/PUTGLOBAL ( -- DESC )                ID-BUF FINDGLOBAL ?DUP                      ÉÆ DUP >TYPE @ %PROTO IS?                   ÉÆ ADJUST-PROTOTYPE EXIT                 ÅÌÓÅ 2DROP ÔÈÅÎ ÔÈÅÎ               ID-BUF PUTGLOBAL ;                                                                                                                                                                                                                                                                                                                                                                                                  \   PARSER: DEFINE-FUNCTION    26FEB91PZ                                          Ü CREATE DUMMY  4 ALLOT                                                           Ü : PARAMETER' ( -- )                         FUNCTION? DUP                               ÉÆ UNNESTLOCAL ÔÈÅÎ                   ARRAY? OR                                   ÉÆ *PARAM* ERROR                         ÅÌÓÅ ID-BUF FINDPARAM                    ?DUP 0= ÉÆ *UNDEF* ERROR                         DUMMY ÔÈÅÎ                       OBJ-TYPE @ SWAP >TYPE ! ÔÈÅÎ ;                                            Ü : DECLARE-PARAMETERS ( -- )                 ÂÅÇÉÎ OBJ-TYPE OFF  %OFFSET !SET         REGISTER-OR-TYPE? ×ÈÉÌÅ                  ['] PARAMETER' ÉÓ 'DECLARATOR            DECLARATOR-LIST                          EXPECT';' ÒÅÐÅÁÔ ;                                                                                                                                                                                                                              \   PARSER: DEFINE FUNCTION    26FEB91PZ                                          Ü : DEFINE-FUNCTION ( -- )                    ASCII ; #CHAR# COMES?                       ÉÆ PROTOTYPE BACKWORD EXIT ÔÈÅÎ       ASCII , #CHAR# COMES?                       ÉÆ PROTOTYPE BACKWORD EXIT ÔÈÅÎ       </=> #OPER# COMES?                          ÉÆ EXT-FNCT           EXIT ÔÈÅÎ       <*=> #OPER# COMES?                          ÉÆ %STDFCTN !SET EXT-FNCT                                      EXIT ÔÈÅÎ       1ST?                                        ÉÆ PC OBJ-VAL ! FUNCTION ACTIVE          FIND/PUTGLOBAL  VAL/TYPE>TAB              DECLARE-PARAMETERS                        ASCII Û #CHAR# EXPECT                    COMPOUND                                UNNESTLOCAL                             .RTS                                     FUNCTION NOT ACTIVE                      FUNCTION DEFINED                         ÅÌÓÅ *SYNTAX* ERROR ÔÈÅÎ ;                                                                                        \   PARSER:                    23FEB91PZ                                          Ü : DEF.LOCAL' ( -- )                         FUNCTION?                                   ÉÆ DECLARE-FUNCTION                      ÅÌÓÅ DEFINE-LOCAL ÔÈÅÎ ;                                                  Ü : EXT.LOCAL' ( -- )                         FUNCTION?                                   ÉÆ DECLARE-FUNCTION                      ÅÌÓÅ DECLARE-DATA ÔÈÅÎ ;                                                  Ü : DEF.GLOBAL' ( -- )                        FUNCTION?                                   ÉÆ DEFINE-FUNCTION                       ÅÌÓÅ DEFINE-GLOBAL ÔÈÅÎ ;                                                 Ü : EXT.GLOBAL' ( -- )                        FUNCTION?                                   ÉÆ DEFINE-FUNCTION                       ÅÌÓÅ DECLARE-DATA ÔÈÅÎ ;                                                                                                                                                                            \   PARSER: DECLARATION        21FEB91PZ                                          Ü : DEF.LOCAL ( -- )                          ['] DEF.LOCAL' ÉÓ 'DECLARATOR            DECLARATOR-LIST                          EXPECT';' ;                                                                  Ü : EXT.LOCAL ( -- )                          ['] EXT.LOCAL' ÉÓ 'DECLARATOR            DECLARATOR-LIST                          EXPECT';' ;                                                                  Ü : DEF.GLOBAL ( -- )                         ['] DEF.GLOBAL' ÉÓ 'DECLARATOR           DECLARATOR-LIST                          FUNCTION NOT DEFINED?                       ÉÆ EXPECT';' ÔÈÅÎ ;                                                       Ü : EXT.GLOBAL ( -- )                         ['] EXT.GLOBAL' ÉÓ 'DECLARATOR           DECLARATOR-LIST                          FUNCTION NOT DEFINED?                       ÉÆ EXPECT';' ÔÈÅÎ ;                                                                                               \   PARSER: TYPE-SPECIFIERS    22FEB91PZ                                          Ü : DEFINITION ( -- FLAG )  FALSE             %GLOBAL OBJ-TYPE ! EXTERN?                  ÉÆ [TYPE-NAME]  EXT.GLOBAL            ÅÌÓÅ STATIC?                                ÉÆ [TYPE-NAME]  DEF.GLOBAL            ÅÌÓÅ TYPE-NAME? NOT ?EXIT                EXTERN?  ÉÆ        EXT.GLOBAL            ÅÌÓÅ [STATIC]      DEF.GLOBAL            ÔÈÅÎ ÔÈÅÎ ÔÈÅÎ NOT ;                                                         Ü : DECLARATION ( -- FLAG ) FALSE             %LOCAL OBJ-TYPE !  EXTERN?                  ÉÆ [TYPE-NAME]  EXT.LOCAL             ÅÌÓÅ CLASS?                                 ÉÆ [TYPE-NAME]  DEF.LOCAL             ÅÌÓÅ TYPE-NAME? NOT ?EXIT                EXTERN?  ÉÆ        EXT.LOCAL             ÅÌÓÅ [CLASS]       DEF.LOCAL             ÔÈÅÎ ÔÈÅÎ ÔÈÅÎ NOT ;                                                                                                                                                                                   \ PARSER: COMPOUND, PROGRAM    23FEB91PZ                                            MAKE COMPOUND ( -- )                        NESTLOCAL                                ÂÅÇÉÎ DECLARATION NOT ÕÎÔÉÌ              ÂÅÇÉÎ STATEMENT NOT ÕÎÔÉÌ                ASCII Ý #CHAR# EXPECT                    UNNESTLOCAL ;                                                                Þ : PROGRAM ( -- )                            FUNCTION NOT ACTIVE                      ÂÅÇÉÎ DEFINITION NOT ÕÎÔÉÌ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            